---
title: "Racial and Ethnic Differences in ETI"
author: "Tim Vigers"
date: "today"
date-format: long
format:
  html:
    toc: true
    toc-depth: 5
    toc-float: true
    code-fold: true
    self-contained: true
    fig-cap-location: top
    page-layout: full
    theme:
      light: flatly
      dark: darkly
bibliography: /Users/timvigers/Dropbox/Miscellaneous/zotero.bib
csl: /Users/timvigers/Dropbox/Miscellaneous/american-medical-association.csl
editor: source
---

```{r setup}
#| include: false
# Libraries
library(Hmisc)
library(tidyverse)
library(gtsummary)
library(lmerTest)
library(broom.mixed)
library(emmeans)
library(knitr)
```

```{r data cleaning}
#| include: false
# source("/Users/timvigers/GitHub/CF/Kamyron Jordan/Racial and Ethnic Differences in ETI/create_race_eti_analysis_dataset.R")
load("/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Vigers/CF/Kamyron Jordan/Racial and Ethnic Differences in ETI/Data_Cleaned/analysis_dataset.RData")
```

# Race and ethnicity breakdown

The table below shows the race and ethnicity proportions for the entire cohort included in the CFFPR dataset. I decided to combine race and ethnicity with Hispanic "overriding" other racial identities. So if a participant was reported as both Black and Hispanic, they were consider Hispanic for the following analyses. Those with missing data for Hispanic ethnicity were moved to the "Indigenous/Mixed/Other/Unknown Race" category.

```{r}
demo %>%
  select(race) %>%
  tbl_summary(missing_text = "Missing") %>%
  bold_labels()
```

## Race by year

The table below shows the proportions of race and ethnicities included in the dataset in a given year. Most people are seen at least once a year, but this table serves as a sanity check to make sure that groups were generally seen equal amounts each year.

```{r}
annual %>%
  select(race, ReviewYear) %>%
  tbl_summary(by = ReviewYear, missing_text = "Missing") %>%
  bold_labels()
```

# Participant characteristics

```{r}
t1_vars <- c(
  "Gender", "WasGenotyped", "F508_num", "mean_ppFEV", "Age_YrEnd",
  "mean_ppFEV", "weight_last", "weight_perc_last", "bmi_last",
  "bmi_perc_last", "Vx770", "Vx809comb", "Vx661comb", "Vx445comb"
)
```

## Characteristics by race

```{r}
demo %>%
  select(Gender, WasGenotyped, F508_num, race) %>%
  tbl_summary(by = race, missing_text = "Missing") %>%
  bold_labels()
```

## Characteristics by year

```{r results='asis'}
set_gtsummary_theme(theme_gtsummary_compact(), quiet = T)
years <- split.data.frame(annual, annual$ReviewYear)
invisible(lapply(names(years), function(n) {
  cat("\n")
  cat("###", n)
  cat("\n")
  d <- years[[n]]
  t <- d %>%
    select(all_of(t1_vars), race) %>%
    tbl_summary(by = race, missing_text = "Missing") %>%
    bold_labels()
  print(t)
  cat("\n")
}))
reset_gtsummary_theme()
```

# ETI eligibility

Trikafta originally approved October 21, 2019 for patients 12+ years of age. Approved for ages 6 - 11 on June 9, 2021.

## Overall by year

```{r}
annual %>%
  select(eti_elig, ReviewYear) %>%
  tbl_summary(
    by = ReviewYear, missing_text = "Missing",
    type = all_dichotomous() ~ "categorical"
  ) %>%
  bold_labels()
```

## By race and year

```{r results='asis'}
invisible(lapply(names(years), function(n) {
  cat("\n")
  cat("###", n)
  cat("\n")
  d <- years[[n]]
  t <- d %>%
    select(eti_elig, race) %>%
    tbl_summary(
      by = race, missing_text = "Missing",
      type = all_dichotomous() ~ "categorical"
    ) %>%
    bold_labels()
  print(t)
  cat("\n")
}))
```

# People without visits in a given year

```{r}
# Which are missing from encounters data?
a <- as.data.frame.matrix(table(annual$eDWID, annual$ReviewYear))
a <- a %>% rownames_to_column("eDWID")
e <- as.data.frame.matrix(table(by_year$eDWID, by_year$reviewyear))
e <- e %>% rownames_to_column("eDWID")
rowdiff_a <- setdiff(a, e)
rowdiff_a$data <- "annual"
rowdiff_e <- setdiff(e, a)
rowdiff_e$data <- "encounter"
diffs <- rbind(rowdiff_a, rowdiff_e)
diffs <- diffs %>%
  arrange(eDWID, desc(data)) %>%
  select(-data)
diffs <- diffs %>%
  group_by(eDWID) %>%
  reframe(across(`2015`:`2021`, ~ diff(as.numeric(.x))))
diffs %>%
  reframe(across(`2015`:`2021`, ~ sum(.x == 1))) %>%
  kable()
```

There were a total of `r length(setdiff(a$eDWID,e$eDWID))` included in the annual dataset that did not appear in the encounter-level dataset at all. There were an additional `r nrow(diffs)` patients who were included in both datasets, but had at least one year with no encounters. The table above shows the number of people missing an encounter in each year.

If someone was not seen a given year, do we count them as eligible for that year? I am assuming they will be eligible but obviously will not have started any modulators.

# Potential COVID effects

## Spaghetti plot

```{r}
#| warning: false
ggplot(encounter, aes(
  y = GLI_FEV1_pct_predicted, x = encounterdate,
  group = eDWID, color = factor(eDWID)
)) +
  geom_line(alpha = 0.02) +
  theme_bw() +
  theme(legend.position = "none")
```

## Visits prior to and after March 11, 2020

The table below is limited to visits 2019 - 2021.

```{r}
encounter %>%
  filter(encounterdate >= "2019-01-01") %>%
  mutate(post_covid = encounterdate > "2020-03-11") %>%
  group_by(eDWID) %>%
  summarise(
    `Number of Visits Pre-COVID` = sum(!post_covid),
    `Number of Visits Post-COVID` = sum(post_covid),
    race = first(race),
    .groups = "drop"
  ) %>%
  select(-eDWID) %>%
  tbl_summary(by = race, missing_text = "Missing") %>%
  bold_labels()
```

# Lung function over time

## Annualized averages

FEV1 and FVC percent predicted (based on GLI equations) were averaged by year for each person. 

```{r}
#| warning: false
annual %>%
  mutate(mean_ppFEV = as.numeric(mean_ppFEV), mean_ppFVC = as.numeric(mean_ppFVC)) %>%
  pivot_longer(c("mean_ppFEV", "mean_ppFVC")) %>%
  ggplot(aes(x = ReviewYear, y = value, color = factor(eDWID), group = eDWID)) +
  geom_line(alpha = 0.01) +
  theme_bw() +
  theme(legend.position = "none") +
  facet_wrap(~name)
```

```{r}
#| cache: true
# Most basic model of lung function over time by race
mod <- lmer(
  mean_ppFEV ~ factor(ReviewYear) * race + (1 | eDWID),
  data = annual
)
res <- tidy(mod, effects = "fixed")
means <- data.frame(emmeans(mod, ~ race + ReviewYear,
  lmerTest.limit = 1e6,
  pbkrtest.limit = 1e6
))
kable(means)
```

```{r}
ggplot(means, aes(x = ReviewYear, y = emmean, color = race)) +
  geom_line() +
  geom_point() +
  xlab("Year") +
  ylab("LS Mean FEV1") +
  geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE), width = .2) +
  theme_bw()
```
