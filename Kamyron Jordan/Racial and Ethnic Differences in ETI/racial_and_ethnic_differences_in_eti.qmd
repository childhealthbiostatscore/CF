---
title: "Racial and Ethnic Differences in ETI"
author: "Tim Vigers"
date: "today"
date-format: long
format:
  html:
    toc: true
    toc-depth: 5
    toc-float: true
    code-fold: true
    self-contained: true
    fig-cap-location: top
    page-layout: full
    theme:
      light: flatly
      dark: darkly
bibliography: /Users/timvigers/Documents/Miscellaneous/zotero.bib
csl: /Users/timvigers/Documents/Miscellaneous/american-medical-association.csl
editor: source
---

```{r data cleaning}
#| include: false
# source("/Users/timvigers/GitHub/CF/Kamyron Jordan/Racial and Ethnic Differences in ETI/create_race_eti_analysis_dataset.R")
load("/Volumes/Work/Vigers/CF/Kamyron Jordan/Racial and Ethnic Differences in ETI/Data_Cleaned/analysis_dataset.RData")
```

```{r libraries}
#| include: false
library(Hmisc)
library(tidyverse)
library(gtsummary)
```

# Race and ethnicity breakdown

## Race by year

```{r t1}
annual %>%
  select(ReviewYear, race, Hispanicrace) %>%
  tbl_summary(
    by = ReviewYear, missing_text = "Missing",
    statistic = list(all_continuous() ~ "{mean} ({sd})")
  ) %>%
  modify_header(label = paste0("**Year**")) %>%
  bold_labels() %>%
  as_kable_extra()
```

## Race and ethnicity overall

```{r t2}
demo %>%
  select(race, Hispanicrace) %>%
  tbl_summary(
    by = Hispanicrace,
    statistic = list(all_continuous() ~ "{mean} ({sd})")
  ) %>%
  modify_header(label = paste0("**", label(annual$Hispanicrace), "**")) %>%
  add_overall() %>%
  bold_labels() %>%
  as_kable_extra()
```

Based on the above table, I decided to combine race and ethnicity with Hispanic "overriding" other racial identities. So if a participant was reported as both Black and Hispanic, they were consider Hispanic for the following analyses. Those with missing data for Hispanic ethnicity were moved to the "Mixed/Other/Unknown Race" category.

```{r combine race and eth}
demo$race <- as.character(demo$race)
demo$race[demo$Hispanicrace == "Yes"] <- "Hispanic or Latino"
demo$race[demo$Hispanicrace == "Unknown"] <- "Hispanic or Latino"
demo$race <- factor(demo$race,
  levels = c(
    "White", "Black or African American", "Hispanic or Latino",
    "American Indian or Alaska Native", "Asian",
    "Native Hawaiian or Other Pacific Islander", "Mixed/Other/Unknown Race"
  )
)
label(demo$race) <- "Race/Ethnicity"
```

## Race percentages overall

```{r t3}
demo %>%
  select(race) %>%
  tbl_summary(statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%
  modify_header(label = paste0("**Race**")) %>%
  bold_labels() %>%
  as_kable_extra()
```

# Participant characteristics

## Characteristics by race

```{r t4}
demo %>%
  select(race, Gender, WasGenotyped, F508) %>%
  tbl_summary(
    by = race, missing_text = "Missing",
    statistic = list(all_continuous() ~ "{mean} ({sd})")
  ) %>%
  modify_header(label = paste0("**Race**")) %>%
  add_overall() %>%
  bold_labels() %>%
  as_kable_extra()
```

```{r summarise by year}
#| cache: true
t5 <- encounter %>%
  group_by(eDWID, reviewyear) %>%
  summarise(across(c(race, Gender, WasGenotyped, F508, contains("insurance")), first),
    `Age at Last Visit` = last(na.omit(encounterage)),
    `Mean ppFEV` = mean(GLI_FEV1_pct_predicted, na.rm = T),
    `Weight at Last Visit` = last(na.omit(weight)),
    `Weight %ile at Last Visit` = last(na.omit(weightpercentile)),
    `BMI at Last Visit` = last(na.omit(bmivalue)),
    `BMI %ile at Last Visit` = last(na.omit(bmipercentile)),
    .groups = "drop"
  )
label(t5)[colnames(t5) %in% names(labels)] <- labels[match(colnames(t5), names(labels), nomatch = 0)]
```

## Characteristics by year

```{r t5}
#| message: false
t5 %>%
  select(
    -eDWID, reviewyear, race, Gender, WasGenotyped, F508, contains("insurance"),
    `Age at Last Visit`, `Mean ppFEV`, `Weight at Last Visit`,
    `Weight %ile at Last Visit`, `BMI at Last Visit`,
    `BMI %ile at Last Visit`
  ) %>%
  tbl_summary(
    by = reviewyear, missing_text = "Missing",
    statistic = list(all_continuous() ~ "{mean} ({sd})")
  ) %>%
  modify_header(label = paste0("**Year**")) %>%
  bold_labels() %>%
  as_kable_extra()
```

```{r}
#| label: fig-planets
#| fig-cap: Planets
```
