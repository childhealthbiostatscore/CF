---
title: "Racial and Ethnic Differences in ETI"
author: "Tim Vigers"
date: "today"
date-format: long
format:
  html:
    toc: true
    toc-depth: 5
    toc-float: true
    code-fold: true
    self-contained: true
    fig-cap-location: top
    page-layout: full
    theme:
      light: flatly
      dark: darkly
bibliography: /Users/timvigers/Documents/Miscellaneous/zotero.bib
csl: /Users/timvigers/Documents/Miscellaneous/american-medical-association.csl
editor: source
---

```{r libraries}
#| include: false
library(tidyverse)
library(table1)
library(lmerTest)
library(broom.mixed)
library(emmeans)
library(knitr)
```

```{r data cleaning}
#| include: false
# source("/Users/timvigers/GitHub/CF/Kamyron Jordan/Racial and Ethnic Differences in ETI/create_race_eti_analysis_dataset.R")
load("/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Vigers/CF/Kamyron Jordan/Racial and Ethnic Differences in ETI/Data_Cleaned/analysis_dataset.RData")
```

# Race and ethnicity breakdown

The table below shows the race and ethnicity proportions for the entire cohort included in the CFFPR dataset. I decided to combine race and ethnicity with Hispanic "overriding" other racial identities. So if a participant was reported as both Black and Hispanic, they were consider Hispanic for the following analyses. Those with missing data for Hispanic ethnicity were moved to the "Indigenous/Mixed/Other/Unknown Race" category.

```{r}
table1(~race, data = demo)
```

## Race by year

The table below shows the proportions of race and ethnicities included in the dataset in a given year. Most people are seen at least once a year, but this table serves as a sanity check to make sure that groups were generally seen equal amounts each year.

```{r}
table1(~ race | factor(ReviewYear), data = annual)
```

# Participant characteristics

```{r}
t1_vars <- c(
  "Gender", "WasGenotyped", "F508_num", "mean_ppFEV", "Age_YrEnd",
  "mean_ppFEV", "weight_last", "weight_perc_last", "bmi_last",
  "bmi_perc_last", "Vx770", "Vx809comb", "Vx661comb", "Vx445comb"
)
t1_form <- as.formula(paste("~", paste(t1_vars, collapse = "+"), "|factor(ReviewYear)"))
```

## Characteristics by race

```{r}
table1(~ Gender + WasGenotyped + F508_num | race, data = demo)
```

## Characteristics by year

```{r}
table1(t1_form, data = annual)
```

# ETI eligibility

Trikafta originally approved October 21, 2019 for patients 12+ years of age. Approved for ages 6 - 11 on June 9, 2021.

## Overall by year

```{r}
table1(~ eti_elig | factor(ReviewYear), data = annual, overall = F)
```

## By race and year

```{r}

```

# Potential COVID effects

## Spaghetti plot

```{r}
#| warning: false
ggplot(encounter, aes(
  y = GLI_FEV1_pct_predicted, x = encounterdate,
  group = eDWID, color = factor(eDWID)
)) +
  geom_line(alpha = 0.02) +
  theme_bw() +
  theme(legend.position = "none")
```

## Visits prior to and after March 11, 2020

The table below is limited to visits 2019 - 2021.

```{r}
encounter %>%
  filter(encounterdate >= "2019-01-01") %>%
  mutate(post_covid = encounterdate > "2020-03-11") %>%
  group_by(eDWID) %>%
  summarise(
    `Number of Visits Pre-COVID` = sum(!post_covid),
    `Number of Visits Post-COVID` = sum(post_covid),
    race = first(race),
    .groups = "drop"
  ) %>%
  rename(any_of(tidy_labels)) %>%
  select(-eDWID) %>%
  tbl_summary(by = `Race/Ethnicity`, missing_text = "Missing") %>%
  bold_labels() %>%
  as_kable_extra()
```

# Lung function over time

## Annualized averages

```{r}
mod_df <- encounter %>%
  group_by(eDWID, reviewyear) %>%
  summarise(
    across(
      c(GLI_FEV1_pct_predicted, GLI_FVC_pct_predicted),
      ~ mean(.x, na.rm = T)
    ),
    race = first(race),
    .groups = "drop"
  )
```

FEV1 and FVC percent predicted (based on GLI equations) were averaged by year for each person. 

```{r}
#| warning: false
mod_df
pivot_longer(c("GLI_FEV1_pct_predicted", "GLI_FVC_pct_predicted")) %>%
  ggplot(aes(x = reviewyear, y = value, color = factor(eDWID), group = eDWID)) +
  geom_line(alpha = 0.01) +
  theme_bw() +
  theme(legend.position = "none") +
  facet_wrap(~name)
```

```{r}
#| cache: true
# Most basic model of lung function over time by race
mod <- lmer(
  GLI_FEV1_pct_predicted ~ factor(reviewyear) * race + (1 | eDWID),
  data = mod_df
)
res <- tidy(mod, effects = "fixed")
means <- data.frame(emmeans(mod, ~ race + reviewyear,
  lmerTest.limit = 1e6,
  pbkrtest.limit = 1e6
))
kable(means)
```

```{r}
#| fig-width: 10
#| fig-height: 10
ggplot(means, aes(x = reviewyear, y = emmean, color = race)) +
  geom_line() +
  geom_point() +
  xlab("Year") +
  ylab("LS Mean FEV1") +
  geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE), width = .2) +
  theme_bw()
```
