---
title: "Racial and Ethnic Differences in ETI: Outcomes"
author: "Tim Vigers"
date: "today"
date-format: long
format:
  html:
    toc: true
    toc-depth: 5
    toc-float: true
    number-sections: true
    code-fold: true
    self-contained: true
    fig-cap-location: top
    fig-height: 10
    fig-width: 10
    page-layout: full
editor: source
---

```{r setup}
#| include: false
# Libraries
library(Hmisc)
library(multcomp)
library(tidyverse)
library(gt)
library(gtsummary)
library(ggflowchart)
library(lmerTest)
library(broom)
library(emmeans)
knitr::opts_knit$set(root.dir = "/Users/tim/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Vigers/CF")
```

```{r data import}
# source("/home/timvigers/GitHub/CF/Kamyron Jordan/Racial and Ethnic Differences in ETI/create_outcomes_dataset.R")
load("./Kamyron Jordan/Racial and Ethnic Differences in ETI/Data_Cleaned/outcomes_dataset.RData")
# Change age group reference level
encounter$age_group <- relevel(encounter$age_group, ref = "[18,30)")
```

# Data cleaning

```{r flowchart}
ggflowchart(flow_chart, text_size = 3, y_nudge = 0.4, x_nudge = 0.45)
```

# Table 1

## By person

Continuous variables are reported at the most recent visit prior to ETI start for each person, and categorical variables are reported as the most common value.

```{r}
t1_participant %>%
  select(-eDWID) %>%
  tbl_summary(
    by = Race,
    type = list(`Years With Data` ~ "continuous"),
    statistic = list(c(gli_fev1_ppred_rn, gli_fvc_ppred_rn) ~ "{mean} [{sd}]"),
    missing_text = "Missing"
  ) %>%
  add_overall()
```

# Encounter-level

```{r}
encounter %>%
  select(Race, encounterlocation, bacterialculturedone:othermicroorganisms1) %>%
  tbl_summary(by = Race, missing_text = "Missing")
```

# Segmented models

```{r}
# Create change in slope variable
encounter$slope_change_days <- (encounter$Days > 0) * encounter$Days
label(encounter$slope_change_days) <- "Change in Slope"
encounter$Years <- encounter$Days / 365.25
encounter$slope_change_years <- (encounter$Years > 0) * encounter$Years
label(encounter$slope_change_years) <- "Change in Slope"
# Prior modulator use
prior_mods <- encounter %>%
  select(eDWID, Days, vx661comb, vx445comb, Vx770, Vx809comb) %>%
  filter(Days < 0) %>%
  group_by(eDWID) %>%
  summarise(prior_modulator = any(vx661comb == 1) | any(vx445comb == 1) |
    any(Vx770 == 1) | any(Vx809comb))
prior_mods$prior_modulator <-
  fct_na_value_to_level(factor(prior_mods$prior_modulator), level = "No")
prior_mods$prior_modulator <- factor(prior_mods$prior_modulator,
  levels = c(T, "No"),
  labels = c("Yes", "No")
)
encounter <- left_join(encounter, prior_mods, by = join_by(eDWID))
# On enzymes for pancreatic insufficiency
encounter$isOnEnzymes <-
  factor(encounter$isOnEnzymes, levels = 0:1, labels = c("No", "Yes"))
# Pseudomonas
encounter$pseudomonasaeruginosa[is.na(encounter$pseudomonasaeruginosa)] <- 0
encounter$pseudomonasaeruginosa <- factor(encounter$pseudomonasaeruginosa,
  levels = 0:1, labels = c("No", "Yes")
)
```

The following models are adjusted for age group and insurance status. We fit a Gaussian mixed model for continuous outcomes with random intercept for each subject (random slope did not improve the model AIC).

## FEV1 % predicted

### Full cohort

#### GLI 2022 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  gli_fev1_ppred_rn ~ Years * Race + slope_change_years * Race + age_group +
    Insurance + prior_modulator + isOnEnzymes + pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter
)
# Model plot
pop_dat <- data.frame(expand.grid(
  Years = -3:2, Race = unique(encounter$Race), age_group = "[18,30)",
  Insurance = "Private", prior_modulator = "Yes",
  isOnEnzymes = "Yes", pseudomonasaeruginosa = "No"
))
pop_dat$slope_change_years <- (pop_dat$Years > 0) * pop_dat$Years
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("FEV1 % Predicted") +
  theme_classic(base_size = 15)
# Model summary
change_mod %>%
  gtsummary::tbl_regression(intercept = T) %>%
  as_gt() %>%
  fmt_number(decimals = 3)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(gli_fev1_ppred_rn = pred, ci.ll = ll, ci.ul = ul) %>%
  gt(caption = "Predicted Values at Various Timepoints") %>%
  fmt_number(decimals = 3)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_change,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_change,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_change,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_change
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

#### GLI 2012 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  GLI_FEV1_pct_predicted ~ Years * Race + slope_change_years * Race +
    age_group + Insurance + prior_modulator + isOnEnzymes +
    pseudomonasaeruginosa + (1 | eDWID),
  data = encounter
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("GLI_FEV1_pct_predicted") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(intercept = T) %>%
  as_gt() %>%
  fmt_number(decimals = 3)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(GLI_FEV1_pct_predicted = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 3)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_change,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_change,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_change,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_change
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

### Age < 18 at ETI initiation

The following models were not adjusted for age group.

#### GLI 2022 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  gli_fev1_ppred_rn ~ Years * Race + slope_change_years * Race + Insurance +
    prior_modulator + isOnEnzymes + pseudomonasaeruginosa + (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[-Inf,18)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("gli_fev1_ppred_rn") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(intercept = T) %>%
  as_gt() %>%
  fmt_number(decimals = 3)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(gli_fev1_ppred_rn = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 3)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_change,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_change,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_change,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_change
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

#### GLI 2012 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  GLI_FEV1_pct_predicted ~ Years * Race + slope_change_years * Race +
    Insurance + prior_modulator + isOnEnzymes + pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[-Inf,18)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("GLI_FEV1_pct_predicted") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(GLI_FEV1_pct_predicted = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 3)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_change,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_change,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_change,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_change
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

### Age >= 18 at ETI initiation

The following models were not adjusted for age group.

#### GLI 2022 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  gli_fev1_ppred_rn ~ Years * Race + slope_change_years * Race + Insurance +
    prior_modulator + isOnEnzymes + pseudomonasaeruginosa + (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[18, Inf)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("gli_fev1_ppred_rn") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(intercept = T) %>%
  as_gt() %>%
  fmt_number(decimals = 3)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(gli_fev1_ppred_rn = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 3)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_change,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_change,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_change,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_change
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

#### GLI 2012 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  GLI_FEV1_pct_predicted ~ Years * Race + slope_change_years * Race +
    Insurance + prior_modulator + isOnEnzymes + pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[18, Inf)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("GLI_FEV1_pct_predicted") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(GLI_FEV1_pct_predicted = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 3)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_change,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_change,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_change,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_change
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

## FVC % predicted

### Full cohort

#### GLI 2022 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  gli_fvc_ppred_rn ~ Years * Race + slope_change_years * Race + age_group +
    Insurance + prior_modulator + isOnEnzymes + pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("gli_fvc_ppred_rn") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(intercept = T) %>%
  as_gt() %>%
  fmt_number(decimals = 3)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(gli_fvc_ppred_rn = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 3)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_change,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_change,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_change,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_change
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

#### GLI 2012 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  GLI_FVC_pct_predicted ~ Years * Race + slope_change_years * Race +
    age_group + Insurance + prior_modulator + isOnEnzymes +
    pseudomonasaeruginosa + (1 | eDWID),
  data = encounter
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("GLI_FVC_pct_predicted") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(GLI_FVC_pct_predicted = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 3)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_change,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_change,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_change,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_change
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

### Age < 18 at ETI initiation

The following models were not adjusted for age group.

#### GLI 2022 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  gli_fvc_ppred_rn ~ Years * Race + slope_change_years * Race + Insurance +
    prior_modulator + isOnEnzymes + pseudomonasaeruginosa + (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[-Inf,18)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("gli_fvc_ppred_rn") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(intercept = T) %>%
  as_gt() %>%
  fmt_number(decimals = 3)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(gli_fvc_ppred_rn = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 3)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_change,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_change,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_change,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_change
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

#### GLI 2012 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  GLI_FVC_pct_predicted ~ Years * Race + slope_change_years * Race +
    Insurance + prior_modulator + isOnEnzymes + pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[-Inf,18)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("GLI_FVC_pct_predicted") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(GLI_FVC_pct_predicted = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 3)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_change,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_change,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_change,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_change
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

### Age >= 18 at ETI initiation

The following models were not adjusted for age group.

#### GLI 2022 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  gli_fvc_ppred_rn ~ Years * Race + slope_change_years * Race + Insurance +
    prior_modulator + isOnEnzymes + pseudomonasaeruginosa + (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[18, Inf)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("gli_fvc_ppred_rn") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(intercept = T) %>%
  as_gt() %>%
  fmt_number(decimals = 3)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(gli_fvc_ppred_rn = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 3)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_change,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_change,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_change,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_change
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

#### GLI 2012 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  GLI_FVC_pct_predicted ~ Years * Race + slope_change_years * Race +
    Insurance + prior_modulator + isOnEnzymes + pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[18, Inf)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("GLI_FVC_pct_predicted") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(GLI_FVC_pct_predicted = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 3)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_change,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_change,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_change,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_change
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

## FEV1/FVC % predicted

### Full cohort

#### GLI 2022 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  gli_fev1fvc_ppred_rn ~ Years * Race + slope_change_years * Race + age_group +
    Insurance + prior_modulator + isOnEnzymes + pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("gli_fev1fvc_ppred_rn") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(gli_fev1fvc_ppred_rn = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 3)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_change,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_change,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_change,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_change
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

#### GLI 2012 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  GLI_FEV1FVC_pct_predicted ~ Years * Race + slope_change_years * Race +
    age_group + Insurance + prior_modulator + isOnEnzymes +
    pseudomonasaeruginosa + (1 | eDWID),
  data = encounter
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("GLI_FEV1FVC_pct_predicted") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(GLI_FEV1FVC_pct_predicted = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 3)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_change,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_change,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_change,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_change
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

### Age < 18 at ETI initiation

The following models were not adjusted for age group.

#### GLI 2022 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  gli_fev1fvc_ppred_rn ~ Years * Race + slope_change_years * Race +
    Insurance + prior_modulator + isOnEnzymes + pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[-Inf,18)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("gli_fev1fvc_ppred_rn") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(gli_fev1fvc_ppred_rn = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 3)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_change,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_change,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_change,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_change
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

#### GLI 2012 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  GLI_FEV1FVC_pct_predicted ~ Years * Race + slope_change_years * Race +
    Insurance + prior_modulator + isOnEnzymes +
    pseudomonasaeruginosa + (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[-Inf,18)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("GLI_FEV1FVC_pct_predicted") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(GLI_FEV1FVC_pct_predicted = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 3)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_change,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_change,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_change,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_change
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

### Age >= 18 at ETI initiation

The following models were not adjusted for age group.

#### GLI 2022 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  gli_fev1fvc_ppred_rn ~ Years * Race + slope_change_years * Race + Insurance +
    prior_modulator + isOnEnzymes + pseudomonasaeruginosa + (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[18, Inf)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("gli_fev1fvc_ppred_rn") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(gli_fev1fvc_ppred_rn = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 3)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_change,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_change,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_change,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_change
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

#### GLI 2012 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  GLI_FEV1FVC_pct_predicted ~ Years * Race + slope_change_years * Race +
    Insurance + prior_modulator + isOnEnzymes + pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[18, Inf)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("GLI_FEV1FVC_pct_predicted") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(GLI_FEV1FVC_pct_predicted = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 3)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_change,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_change,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_change,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_change
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

## Number of Pulmonary Exacerbations

For some reason, exacerbation models with the encounter-level data are just not working. I think it may be because there are often several pulmonary exacerbation visits very close together, so including the "Days" variable is causing problems. In the end I used a very simple logistic regression model on annualized PEx data. See `/home/timvigers/GitHub/CF/Kamyron Jordan/Racial and Ethnic Differences in ETI/create_outcomes_dataset.R` for details on making the exacerbation dataset.

### Full cohort

```{r}
# Zero-inflated models
# mod_p <- mixed_model(num_pex ~ ETI * Race,
#   data = pex_data,
#   random = ~ 1 | eDWID, zi_random = ~ 1 | eDWID,
#   family = zi.poisson(), zi_fixed = ~1
# )
# mod_nb <- mixed_model(num_pex ~ ETI * Race,
#   data = pex_data,
#   random = ~ 1 | eDWID, zi_random = ~ 1 | eDWID,
#   family = zi.negative.binomial(), zi_fixed = ~1
# )
pex_logistic <- glmer(any_pex ~ ETI * Race + (1 | eDWID),
  data = pex_data,
  control = glmerControl(optimizer = "bobyqa"),
  family = "binomial"
)
means <- data.frame(emmeans(pex_logistic, ~ Race | ETI, type = "response"))
means %>%
  gt(caption = "Probabilities by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

The table above shows the predicted probability of a pulmonary exacerbation pre- and post-ETI. So for example, NHW pwCF had a PEx probability of `r round(means$prob[means$Race=="Non-Hispanic White"&means$ETI=="Pre-ETI"]*100,1)` (95%CI: `r round(means$asymp.LCL[means$Race=="Non-Hispanic White"&means$ETI=="Pre-ETI"]*100,1)` - `r round(means$asymp.UCL[means$Race=="Non-Hispanic White"&means$ETI=="Pre-ETI"]*100,1)`)  pre-ETI and `r round(means$prob[means$Race=="Non-Hispanic White"&means$ETI=="Post-ETI"]*100,1)` (95%CI: `r round(means$asymp.LCL[means$Race=="Non-Hispanic White"&means$ETI=="Post-ETI"]*100,1)` - `r round(means$asymp.UCL[means$Race=="Non-Hispanic White"&means$ETI=="Post-ETI"]*100,1)` post-ETI. Conversely, Black pwCF had a PEx probability of `r round(means$prob[means$Race=="Black or African American"&means$ETI=="Pre-ETI"]*100,1)` (95%CI: `r round(means$asymp.LCL[means$Race=="Black or African American"&means$ETI=="Pre-ETI"]*100,1)` - `r round(means$asymp.UCL[means$Race=="Black or African American"&means$ETI=="Pre-ETI"]*100,1)`)  pre-ETI and `r round(means$prob[means$Race=="Black or African American"&means$ETI=="Post-ETI"]*100,1)` (95%CI: `r round(means$asymp.LCL[means$Race=="Black or African American"&means$ETI=="Post-ETI"]*100,1)` - `r round(means$asymp.UCL[means$Race=="Black or African American"&means$ETI=="Post-ETI"]*100,1)` post-ETI. 

### Age < 18 at ETI initiation

```{r}
pex_logistic <- glmer(any_pex ~ ETI * Race + (1 | eDWID),
  data = pex_data[pex_data$age_eti_group == "[-Inf,18)", ],
  control = glmerControl(optimizer = "bobyqa"),
  family = "binomial"
)
means <- data.frame(emmeans(pex_logistic, ~ Race | ETI, type = "response"))
means %>%
  gt(caption = "Probabilities by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

### Age >= 18 at ETI initiation

```{r}
pex_logistic <- glmer(any_pex ~ ETI * Race + (1 | eDWID),
  data = pex_data[pex_data$age_eti_group == "[18, Inf)", ],
  control = glmerControl(optimizer = "bobyqa"),
  family = "binomial"
)
means <- data.frame(emmeans(pex_logistic, ~ Race | ETI, type = "response"))
means %>%
  gt(caption = "Probabilities by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

## BMI

### BMI %ile (age < 20 at ETI start)

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  bmipercentile ~ Years * Race + slope_change_years * Race +
    Insurance + prior_modulator + isOnEnzymes + pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_start < 20, ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("BMI Percentile") +
  theme_classic(base_size = 15)
# Model summary
change_mod %>%
  gtsummary::tbl_regression(intercept = T) %>%
  as_gt() %>%
  fmt_number(decimals = 3)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(bmipercentile = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 3)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_change,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_change,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_change,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_change
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

### BMI raw value (age >= 20 at ETI start)

```{r}
change_mod <- lmer(
  bmivalue ~ Years * Race + slope_change_years * Race +
    Insurance + prior_modulator + isOnEnzymes + pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_start >= 20, ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("BMI (kg/m2)") +
  theme_classic(base_size = 15)
# Model summary
change_mod %>%
  gtsummary::tbl_regression(intercept = T) %>%
  as_gt() %>%
  fmt_number(decimals = 3)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(bmivalue = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 3)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_change,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_change,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_change,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_change
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

## Height

### Height %ile (age < 20 at ETI start)

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  heightpercentile ~ Years * Race + slope_change_years * Race +
    Insurance + prior_modulator + isOnEnzymes + pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_start < 20, ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("heightpercentile") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(heightpercentile = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 3)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_change,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_change,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_change,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_change
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

### Height raw value (age >= 20 at ETI start)

```{r}
change_mod <- lmer(
  height ~ Years * Race + slope_change_years * Race + Insurance +
    prior_modulator + isOnEnzymes + pseudomonasaeruginosa + (1 | eDWID),
  data = encounter[encounter$age_eti_start >= 20, ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("height") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(height = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 3)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_change,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_change,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_change,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_change
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

## Weight

### Weight %ile (age < 20 at ETI start)

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  weightpercentile ~ Years * Race + slope_change_years * Race +
    Insurance + prior_modulator + isOnEnzymes + pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_start < 20, ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("weightpercentile") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(intercept = T) %>%
  as_gt() %>%
  fmt_number(decimals = 3)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(weightpercentile = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 3)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_change,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_change,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_change,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_change
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

### Weight raw value (age >= 20 at ETI start)

```{r}
change_mod <- lmer(
  weight ~ Years * Race + slope_change_years * Race + Insurance +
    prior_modulator + isOnEnzymes + pseudomonasaeruginosa + (1 | eDWID),
  data = encounter[encounter$age_eti_start >= 20, ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("weight") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(intercept = T) %>%
  as_gt() %>%
  fmt_number(decimals = 3)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(weight = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 3)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_change <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_change,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_change,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_change,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_change
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```
