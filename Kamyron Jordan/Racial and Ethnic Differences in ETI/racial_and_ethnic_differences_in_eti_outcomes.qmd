---
title: "Racial and Ethnic Differences in ETI: Outcomes"
author: "Tim Vigers"
date: "today"
date-format: long
format:
  html:
    toc: true
    toc-depth: 5
    toc-float: true
    number-sections: true
    code-fold: true
    self-contained: true
    fig-cap-location: top
    fig-height: 10
    fig-width: 10
    page-layout: full
editor: source
---

```{r setup}
#| include: false
# Libraries
library(Hmisc)
library(multcomp)
library(tidyverse)
library(patchwork)
library(gt)
library(gtsummary)
library(ggflowchart)
library(lmerTest)
library(broom)
library(emmeans)
home_dir <- switch(
  Sys.info()["sysname"],
  "Darwin" = "/Users/tim/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Vigers/CF/Kamyron Jordan/Racial and Ethnic Differences in ETI",
  "Windows" = "C:/Users/Tim/OneDrive - The University of Colorado Denver/Vigers/CF/Kamyron Jordan/Racial and Ethnic Differences in ETI",
  "Linux" = "/home/tim/OneDrive/Vigers/CF/Kamyron Jordan/Racial and Ethnic Differences in ETI"
)
github_dir <- switch(
  Sys.info()["sysname"],
  "Darwin" = "/Users/tim/Documents/GitHub",
  "Windows" = "C:/Users/Tim/Documents/GitHub",
  "Linux" = "/home/tim/Documents/GitHub"
)
knitr::opts_knit$set(root.dir = home_dir)
```

```{r data import}
# source("/home/timvigers/GitHub/CF/Kamyron Jordan/Racial and Ethnic Differences in ETI/create_outcomes_dataset.R")
setwd(home_dir)
load(
  "./Data_Cleaned/outcomes_dataset.RData"
)
# Change reference levels
encounter$age_group <- relevel(encounter$age_group, ref = "[18,30)")
```

# Data cleaning

```{r flowchart}
ggflowchart(flow_chart, text_size = 3, y_nudge = 0.4, x_nudge = 0.45)
```

# Table 1

## By person

Continuous variables are reported at the most recent visit prior to ETI start for each person, and categorical variables are reported as the most common value.

```{r}
t1_participant %>%
  select(-eDWID) %>%
  tbl_summary(
    by = Race,
    type = list(`Years With Data` ~ "continuous"),
    statistic = list(
      c(gli_fev1_ppred_rn, gli_fvc_ppred_rn) ~ "{mean} [{sd}]"
    ),
    missing_text = "Missing"
  ) %>%
  add_overall()
```

# Encounter-level

```{r}
encounter %>%
  select(
    Race,
    encounterlocation,
    bacterialculturedone:othermicroorganisms1
  ) %>%
  tbl_summary(by = Race, missing_text = "Missing")
```

# Segmented models

```{r}
# Create change in slope variable
encounter$slope_c_days <- (encounter$Days > 0) * encounter$Days
label(encounter$slope_c_days) <- "Change in Slope"
encounter$Years <- encounter$Days / 365.25
encounter$slope_c_years <- (encounter$Years > 0) * encounter$Years
label(encounter$slope_c_years) <- "Change in Slope"
# Prior modulator use
prior_mods <- encounter %>%
  select(eDWID, Days, vx661comb, vx445comb, Vx770, Vx809comb) %>%
  filter(Days < 0) %>%
  group_by(eDWID) %>%
  summarise(
    prior_modulator = any(vx661comb == 1) |
      any(vx445comb == 1) |
      any(Vx770 == 1) |
      any(Vx809comb)
  )
prior_mods$prior_modulator <-
  fct_na_value_to_level(factor(prior_mods$prior_modulator), level = "No")
prior_mods$prior_modulator <- factor(
  prior_mods$prior_modulator,
  levels = c(T, "No"),
  labels = c("Yes", "No")
)
encounter <- left_join(encounter, prior_mods, by = join_by(eDWID))
encounter$prior_modulator <- relevel(encounter$prior_modulator, ref = "No")
# On enzymes for pancreatic insufficiency
encounter$isOnEnzymes <-
  factor(encounter$isOnEnzymes, levels = 0:1, labels = c("No", "Yes"))
# Pseudomonas
encounter$pseudomonasaeruginosa[is.na(encounter$pseudomonasaeruginosa)] <- 0
encounter$pseudomonasaeruginosa <- factor(
  encounter$pseudomonasaeruginosa,
  levels = 0:1,
  labels = c("No", "Yes")
)
```

The following models are adjusted for age group and insurance status. We fit a Gaussian mixed model for continuous outcomes with random intercept for each subject (random slope did not improve the model AIC).

## FEV1 % predicted

### Full cohort

#### Quick annualized model check (unadjusted)

In the model below, we categorized days from ETI start into categorical years, and averaged FEV1 within these buckets. Then, we fix a mixed model with years from ETI as a categorical variable and a random intercept for participant. This model is not adjusted for any covariates.

```{r}
#| include: false
# Quick check of a categorical model
annualized <- encounter |>
  filter(Days >= -3 * 365.25 & Days <= 2 * 365.25) |>
  mutate(
    Days_cat = cut(
      Days,
      breaks = c(-3:2 * 365.25),
      dig.lab = 6
    )
  ) |>
  group_by(eDWID, Days_cat) |>
  summarise(
    Race = first(Race),
    age_eti_group = first(age_eti_group),
    Insurance = first(Insurance),
    prior_modulator = first(prior_modulator),
    isOnEnzymes = first(isOnEnzymes),
    pseudomonasaeruginosa = first(pseudomonasaeruginosa),
    fev1 = mean(gli_fev1_ppred_rn, na.rm = T),
    .groups = "drop"
  )
ann_mod <- lmer(fev1 ~ Days_cat * Race + (1 | eDWID), data = annualized)
emm <- data.frame(emmeans(
  ann_mod,
  specs = ~ Race + Days_cat,
  pbkrtest.limit = 1e6
))
ggplot(emm, aes(x = Days_cat, y = emmean, group = Race, color = Race)) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.1)
```

#### GLI 2022 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  gli_fev1_ppred_rn ~
    Years *
    Race +
    slope_c_years * Race +
    age_group +
    Insurance +
    prior_modulator +
    isOnEnzymes +
    pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter
)
# Model plot
pop_dat <- data.frame(expand.grid(
  Years = -3:2,
  Race = unique(encounter$Race),
  age_group = "[18,30)",
  Insurance = "Private",
  prior_modulator = "Yes",
  isOnEnzymes = "Yes",
  pseudomonasaeruginosa = "No"
))
pop_dat$slope_c_years <- (pop_dat$Years > 0) * pop_dat$Years
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
p = ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("FEV1 % Predicted") +
  theme_classic(base_size = 15) +
  scale_color_manual(
    values = c("#1e212b", "#4d8b31", "#ffc800", "#ff8427"),
    labels = c("White", "Black", "Hispanic", "Other")
  )
p
ggsave(
  "./Dissemination/Figures/fig2.png",
  plot = p,
  width = 7,
  height = 5,
  units = "in",
  dpi = 600
)
# Model summary
change_mod %>%
  gtsummary::tbl_regression(
    intercept = T,
    estimate_fun = ~ style_number(.x, digits = 1),
    pvalue_fun = ~ style_pvalue(.x, digits = 3)
  )
# Table of predicted values
pop_dat %>%
  select(-slope_c_years) %>%
  rename(gli_fev1_ppred_rn = pred, ci.ll = ll, ci.ul = ul) %>%
  gt(caption = "Predicted Values at Various Timepoints") %>%
  fmt_number(decimals = 1)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_c,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_c,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_c,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_c
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 1)
```

#### GLI 2012 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  GLI_FEV1_pct_predicted ~
    Years *
    Race +
    slope_c_years * Race +
    age_group +
    Insurance +
    prior_modulator +
    isOnEnzymes +
    pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("GLI_FEV1_pct_predicted") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(
    intercept = T,
    estimate_fun = ~ style_number(.x, digits = 1),
    pvalue_fun = ~ style_pvalue(.x, digits = 3)
  )
# Table of predicted values
pop_dat %>%
  select(-slope_c_years) %>%
  rename(GLI_FEV1_pct_predicted = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 1)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_c,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_c,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_c,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_c
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 1)
```

### Age < 18 at ETI initiation

The following models were not adjusted for age group.

#### GLI 2022 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  gli_fev1_ppred_rn ~
    Years *
    Race +
    slope_c_years * Race +
    Insurance +
    prior_modulator +
    isOnEnzymes +
    pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[-Inf,18)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("gli_fev1_ppred_rn") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(
    intercept = T,
    estimate_fun = ~ style_number(.x, digits = 1),
    pvalue_fun = ~ style_pvalue(.x, digits = 3)
  )
# Table of predicted values
pop_dat %>%
  select(-slope_c_years) %>%
  rename(gli_fev1_ppred_rn = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 1)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_c,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_c,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_c,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_c
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 1)
```

#### GLI 2012 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  GLI_FEV1_pct_predicted ~
    Years *
    Race +
    slope_c_years * Race +
    Insurance +
    prior_modulator +
    isOnEnzymes +
    pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[-Inf,18)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("GLI_FEV1_pct_predicted") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(
    intercept = T,
    estimate_fun = ~ style_number(.x, digits = 1),
    pvalue_fun = ~ style_pvalue(.x, digits = 3)
  )
# Table of predicted values
pop_dat %>%
  select(-slope_c_years) %>%
  rename(GLI_FEV1_pct_predicted = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 1)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_c,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_c,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_c,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_c
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 1)
```

### Age >= 18 at ETI initiation

The following models were not adjusted for age group.

#### GLI 2022 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  gli_fev1_ppred_rn ~
    Years *
    Race +
    slope_c_years * Race +
    Insurance +
    prior_modulator +
    isOnEnzymes +
    pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[18, Inf)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("gli_fev1_ppred_rn") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(
    intercept = T,
    estimate_fun = ~ style_number(.x, digits = 2),
    pvalue_fun = ~ style_pvalue(.x, digits = 3)
  )
# Table of predicted values
pop_dat %>%
  select(-slope_c_years) %>%
  rename(gli_fev1_ppred_rn = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 1)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_c,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_c,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_c,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_c
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 1)
```

#### GLI 2012 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  GLI_FEV1_pct_predicted ~
    Years *
    Race +
    slope_c_years * Race +
    Insurance +
    prior_modulator +
    isOnEnzymes +
    pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[18, Inf)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("GLI_FEV1_pct_predicted") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(
    intercept = T,
    estimate_fun = ~ style_number(.x, digits = 1),
    pvalue_fun = ~ style_pvalue(.x, digits = 3)
  )
# Table of predicted values
pop_dat %>%
  select(-slope_c_years) %>%
  rename(GLI_FEV1_pct_predicted = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 1)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_c,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_c,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_c,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_c
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 1)
```

## FVC % predicted

### Full cohort

#### GLI 2022 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  gli_fvc_ppred_rn ~
    Years *
    Race +
    slope_c_years * Race +
    age_group +
    Insurance +
    prior_modulator +
    isOnEnzymes +
    pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
p = ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("FVC % Predicted") +
  theme_classic(base_size = 15) +
  scale_color_manual(
    values = c("#1e212b", "#4d8b31", "#ffc800", "#ff8427"),
    labels = c("White", "Black", "Hispanic", "Other")
  )
p
ggsave(
  "./Dissemination/Figures/figS1.png",
  plot = p,
  width = 7,
  height = 5,
  units = "in",
  dpi = 600
)
# Model summary
change_mod %>%
  gtsummary::tbl_regression(
    intercept = T,
    estimate_fun = ~ style_number(.x, digits = 1),
    pvalue_fun = ~ style_pvalue(.x, digits = 3)
  )
# Table of predicted values
pop_dat %>%
  select(-slope_c_years) %>%
  rename(gli_fvc_ppred_rn = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 1)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_c,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_c,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_c,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_c
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 1)
```

#### GLI 2012 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  GLI_FVC_pct_predicted ~
    Years *
    Race +
    slope_c_years * Race +
    age_group +
    Insurance +
    prior_modulator +
    isOnEnzymes +
    pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("GLI_FVC_pct_predicted") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(
    intercept = T,
    estimate_fun = ~ style_number(.x, digits = 1),
    pvalue_fun = ~ style_pvalue(.x, digits = 3)
  )
# Table of predicted values
pop_dat %>%
  select(-slope_c_years) %>%
  rename(GLI_FVC_pct_predicted = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 1)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_c,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_c,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_c,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_c
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 1)
```

### Age < 18 at ETI initiation

The following models were not adjusted for age group.

#### GLI 2022 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  gli_fvc_ppred_rn ~
    Years *
    Race +
    slope_c_years * Race +
    Insurance +
    prior_modulator +
    isOnEnzymes +
    pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[-Inf,18)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("gli_fvc_ppred_rn") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(
    intercept = T,
    estimate_fun = ~ style_number(.x, digits = 1),
    pvalue_fun = ~ style_pvalue(.x, digits = 3)
  )
# Table of predicted values
pop_dat %>%
  select(-slope_c_years) %>%
  rename(gli_fvc_ppred_rn = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 1)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_c,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_c,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_c,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_c
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 1)
```

#### GLI 2012 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  GLI_FVC_pct_predicted ~
    Years *
    Race +
    slope_c_years * Race +
    Insurance +
    prior_modulator +
    isOnEnzymes +
    pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[-Inf,18)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("GLI_FVC_pct_predicted") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(
    intercept = T,
    estimate_fun = ~ style_number(.x, digits = 1),
    pvalue_fun = ~ style_pvalue(.x, digits = 3)
  )
# Table of predicted values
pop_dat %>%
  select(-slope_c_years) %>%
  rename(GLI_FVC_pct_predicted = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 1)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_c,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_c,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_c,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_c
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 1)
```

### Age >= 18 at ETI initiation

The following models were not adjusted for age group.

#### GLI 2022 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  gli_fvc_ppred_rn ~
    Years *
    Race +
    slope_c_years * Race +
    Insurance +
    prior_modulator +
    isOnEnzymes +
    pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[18, Inf)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("gli_fvc_ppred_rn") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(
    intercept = T,
    estimate_fun = ~ style_number(.x, digits = 1),
    pvalue_fun = ~ style_pvalue(.x, digits = 3)
  )
# Table of predicted values
pop_dat %>%
  select(-slope_c_years) %>%
  rename(gli_fvc_ppred_rn = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 1)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_c,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_c,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_c,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_c
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 1)
```

#### GLI 2012 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  GLI_FVC_pct_predicted ~
    Years *
    Race +
    slope_c_years * Race +
    Insurance +
    prior_modulator +
    isOnEnzymes +
    pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[18, Inf)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("GLI_FVC_pct_predicted") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(
    intercept = T,
    estimate_fun = ~ style_number(.x, digits = 1),
    pvalue_fun = ~ style_pvalue(.x, digits = 3)
  )
# Table of predicted values
pop_dat %>%
  select(-slope_c_years) %>%
  rename(GLI_FVC_pct_predicted = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 1)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_c,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_c,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_c,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_c
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 1)
```

## FEV1/FVC % predicted

### Full cohort

#### GLI 2022 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  gli_fev1fvc_ppred_rn ~
    Years *
    Race +
    slope_c_years * Race +
    age_group +
    Insurance +
    prior_modulator +
    isOnEnzymes +
    pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("gli_fev1fvc_ppred_rn") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(
    intercept = T,
    estimate_fun = ~ style_number(.x, digits = 1),
    pvalue_fun = ~ style_pvalue(.x, digits = 3)
  )
# Table of predicted values
pop_dat %>%
  select(-slope_c_years) %>%
  rename(gli_fev1fvc_ppred_rn = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 1)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_c,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_c,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_c,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_c
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 1)
```

#### GLI 2012 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  GLI_FEV1FVC_pct_predicted ~
    Years *
    Race +
    slope_c_years * Race +
    age_group +
    Insurance +
    prior_modulator +
    isOnEnzymes +
    pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("GLI_FEV1FVC_pct_predicted") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(
    intercept = T,
    estimate_fun = ~ style_number(.x, digits = 1),
    pvalue_fun = ~ style_pvalue(.x, digits = 3)
  )
# Table of predicted values
pop_dat %>%
  select(-slope_c_years) %>%
  rename(GLI_FEV1FVC_pct_predicted = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 1)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_c,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_c,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_c,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_c
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 1)
```

### Age < 18 at ETI initiation

The following models were not adjusted for age group.

#### GLI 2022 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  gli_fev1fvc_ppred_rn ~
    Years *
    Race +
    slope_c_years * Race +
    Insurance +
    prior_modulator +
    isOnEnzymes +
    pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[-Inf,18)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("gli_fev1fvc_ppred_rn") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(
    intercept = T,
    estimate_fun = ~ style_number(.x, digits = 1),
    pvalue_fun = ~ style_pvalue(.x, digits = 3)
  )
# Table of predicted values
pop_dat %>%
  select(-slope_c_years) %>%
  rename(gli_fev1fvc_ppred_rn = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 1)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_c,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_c,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_c,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_c
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 1)
```

#### GLI 2012 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  GLI_FEV1FVC_pct_predicted ~
    Years *
    Race +
    slope_c_years * Race +
    Insurance +
    prior_modulator +
    isOnEnzymes +
    pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[-Inf,18)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("GLI_FEV1FVC_pct_predicted") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(
    intercept = T,
    estimate_fun = ~ style_number(.x, digits = 1),
    pvalue_fun = ~ style_pvalue(.x, digits = 3)
  )
# Table of predicted values
pop_dat %>%
  select(-slope_c_years) %>%
  rename(GLI_FEV1FVC_pct_predicted = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 1)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_c,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_c,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_c,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_c
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 1)
```

### Age >= 18 at ETI initiation

The following models were not adjusted for age group.

#### GLI 2022 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  gli_fev1fvc_ppred_rn ~
    Years *
    Race +
    slope_c_years * Race +
    Insurance +
    prior_modulator +
    isOnEnzymes +
    pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[18, Inf)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("gli_fev1fvc_ppred_rn") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(
    intercept = T,
    estimate_fun = ~ style_number(.x, digits = 1),
    pvalue_fun = ~ style_pvalue(.x, digits = 3)
  )
# Table of predicted values
pop_dat %>%
  select(-slope_c_years) %>%
  rename(gli_fev1fvc_ppred_rn = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 1)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_c,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_c,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_c,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_c
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 1)
```

#### GLI 2012 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  GLI_FEV1FVC_pct_predicted ~
    Years *
    Race +
    slope_c_years * Race +
    Insurance +
    prior_modulator +
    isOnEnzymes +
    pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[18, Inf)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("GLI_FEV1FVC_pct_predicted") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(
    intercept = T,
    estimate_fun = ~ style_number(.x, digits = 1),
    pvalue_fun = ~ style_pvalue(.x, digits = 3)
  )
# Table of predicted values
pop_dat %>%
  select(-slope_c_years) %>%
  rename(GLI_FEV1FVC_pct_predicted = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 1)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_c,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_c,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_c,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_c
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 1)
```

## Number of Pulmonary Exacerbations

For some reason, exacerbation models with the encounter-level data are just not working. I think it may be because there are often several pulmonary exacerbation visits very close together, so including the "Days" variable is causing problems. In the end I used a very simple logistic regression model on annualized PEx data. See `/home/timvigers/GitHub/CF/Kamyron Jordan/Racial and Ethnic Differences in ETI/create_outcomes_dataset.R` for details on making the exacerbation dataset.

### Full cohort

```{r}
# Zero-inflated models
# mod_p <- mixed_model(num_pex ~ ETI * Race,
#   data = pex_data,
#   random = ~ 1 | eDWID, zi_random = ~ 1 | eDWID,
#   family = zi.poisson(), zi_fixed = ~1
# )
# mod_nb <- mixed_model(num_pex ~ ETI * Race,
#   data = pex_data,
#   random = ~ 1 | eDWID, zi_random = ~ 1 | eDWID,
#   family = zi.negative.binomial(), zi_fixed = ~1
# )
pex_logistic <- glmer(
  any_pex ~ ETI * Race + (1 | eDWID),
  data = pex_data,
  control = glmerControl(optimizer = "bobyqa"),
  family = "binomial"
)
pex_logistic |> tbl_regression()
means <- data.frame(emmeans(pex_logistic, ~ Race + ETI, type = "response"))
means %>%
  gt(caption = "Probabilities by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0)
aa_post <- c(0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 0, 1, 0, 0, 0, 0, 0)
hl_post <- c(0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(1, 0, 0, 0, 0, 0, 0, 0)
nhw_post <- c(0, 0, 0, 0, 1, 0, 0, 0)
other_pre <- c(0, 0, 0, 1, 0, 0, 0, 0)
other_post <- c(0, 0, 0, 0, 0, 0, 0, 1)
```

The table above shows the predicted probability of a pulmonary exacerbation pre- and post-ETI. So for example, NHW pwCF had a PEx probability of `r round(means$prob[means$Race=="Non-Hispanic White"&means$ETI=="Pre-ETI"]*100,1)` (95%CI: `r round(means$asymp.LCL[means$Race=="Non-Hispanic White"&means$ETI=="Pre-ETI"]*100,1)` - `r round(means$asymp.UCL[means$Race=="Non-Hispanic White"&means$ETI=="Pre-ETI"]*100,1)`)  pre-ETI and `r round(means$prob[means$Race=="Non-Hispanic White"&means$ETI=="Post-ETI"]*100,1)` (95%CI: `r round(means$asymp.LCL[means$Race=="Non-Hispanic White"&means$ETI=="Post-ETI"]*100,1)` - `r round(means$asymp.UCL[means$Race=="Non-Hispanic White"&means$ETI=="Post-ETI"]*100,1)`) post-ETI. Conversely, Black pwCF had a PEx probability of `r round(means$prob[means$Race=="Black or African American"&means$ETI=="Pre-ETI"]*100,1)` (95%CI: `r round(means$asymp.LCL[means$Race=="Black or African American"&means$ETI=="Pre-ETI"]*100,1)` - `r round(means$asymp.UCL[means$Race=="Black or African American"&means$ETI=="Pre-ETI"]*100,1)`)  pre-ETI and `r round(means$prob[means$Race=="Black or African American"&means$ETI=="Post-ETI"]*100,1)` (95%CI: `r round(means$asymp.LCL[means$Race=="Black or African American"&means$ETI=="Post-ETI"]*100,1)` - `r round(means$asymp.UCL[means$Race=="Black or African American"&means$ETI=="Post-ETI"]*100,1)`) post-ETI. 

### Age < 18 at ETI initiation

```{r}
pex_logistic <- glmer(
  any_pex ~ ETI * Race + (1 | eDWID),
  data = pex_data[pex_data$age_eti_group == "[-Inf,18)", ],
  control = glmerControl(optimizer = "bobyqa"),
  family = "binomial"
)
pex_logistic |> tbl_regression()
means <- emmeans(pex_logistic, ~ Race + ETI, type = "response")
data.frame(means) %>%
  gt(caption = "Probabilities by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

### Age >= 18 at ETI initiation

```{r}
pex_logistic <- glmer(
  any_pex ~ ETI * Race + (1 | eDWID),
  data = pex_data[pex_data$age_eti_group == "[18, Inf)", ],
  control = glmerControl(optimizer = "bobyqa"),
  family = "binomial"
)
means <- data.frame(emmeans(pex_logistic, ~ Race | ETI, type = "response"))
means %>%
  gt(caption = "Probabilities by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 3)
```

## BMI

### BMI %ile (age < 20 at ETI start)

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  bmipercentile ~
    Years *
    Race +
    slope_c_years * Race +
    Insurance +
    prior_modulator +
    isOnEnzymes +
    pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_start < 20, ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
p3a = ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("BMI Percentile") +
  theme_classic(base_size = 15) +
  scale_color_manual(
    values = c("#1e212b", "#4d8b31", "#ffc800", "#ff8427"),
    labels = c("White", "Black", "Hispanic", "Other")
  )
p3a
ggsave(
  "./Dissemination/Figures/fig3a.png",
  plot = p3a,
  width = 7,
  height = 5,
  units = "in",
  dpi = 600
)
# Model summary
change_mod %>%
  gtsummary::tbl_regression(
    intercept = T,
    estimate_fun = ~ style_number(.x, digits = 1),
    pvalue_fun = ~ style_pvalue(.x, digits = 3)
  )
# Table of predicted values
pop_dat %>%
  select(-slope_c_years) %>%
  rename(bmipercentile = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 1)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_c,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_c,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_c,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_c
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 1)
```

### BMI raw value (age >= 20 at ETI start)

```{r}
change_mod <- lmer(
  bmivalue ~
    Years *
    Race +
    slope_c_years * Race +
    Insurance +
    prior_modulator +
    isOnEnzymes +
    pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_start >= 20, ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
p3b = ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("BMI (kg/m2)") +
  theme_classic(base_size = 15) +
  scale_color_manual(
    values = c("#1e212b", "#4d8b31", "#ffc800", "#ff8427"),
    labels = c("White", "Black", "Hispanic", "Other")
  )
p3b
ggsave(
  "./Dissemination/Figures/fig3b.png",
  plot = p3b,
  width = 7,
  height = 5,
  units = "in",
  dpi = 600
)
p = p3a / p3b + plot_layout(guides = "collect")
ggsave(
  "./Dissemination/Figures/fig3ab.png",
  plot = p,
  width = 9,
  height = 7,
  units = "in",
  dpi = 600
)
# Model summary
change_mod %>%
  gtsummary::tbl_regression(
    intercept = T,
    estimate_fun = ~ style_number(.x, digits = 1),
    pvalue_fun = ~ style_pvalue(.x, digits = 3)
  )
# Table of predicted values
pop_dat %>%
  select(-slope_c_years) %>%
  rename(bmivalue = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 1)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_c,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_c,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_c,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_c
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 1)
```

## Height

### Height %ile (age < 20 at ETI start)

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  heightpercentile ~
    Years *
    Race +
    slope_c_years * Race +
    Insurance +
    prior_modulator +
    isOnEnzymes +
    pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_start < 20, ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("heightpercentile") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(
    intercept = T,
    estimate_fun = ~ style_number(.x, digits = 1),
    pvalue_fun = ~ style_pvalue(.x, digits = 3)
  )
# Table of predicted values
pop_dat %>%
  select(-slope_c_years) %>%
  rename(heightpercentile = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 1)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_c,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_c,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_c,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_c
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 1)
```

### Height raw value (age >= 20 at ETI start)

```{r}
change_mod <- lmer(
  height ~
    Years *
    Race +
    slope_c_years * Race +
    Insurance +
    prior_modulator +
    isOnEnzymes +
    pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_start >= 20, ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("height") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(
    intercept = T,
    estimate_fun = ~ style_number(.x, digits = 1),
    pvalue_fun = ~ style_pvalue(.x, digits = 3)
  )
# Table of predicted values
pop_dat %>%
  select(-slope_c_years) %>%
  rename(height = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 1)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_c,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_c,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_c,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_c
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 1)
```

## Weight

### Weight %ile (age < 20 at ETI start)

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  weightpercentile ~
    Years *
    Race +
    slope_c_years * Race +
    Insurance +
    prior_modulator +
    isOnEnzymes +
    pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_start < 20, ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("weightpercentile") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(
    intercept = T,
    estimate_fun = ~ style_number(.x, digits = 1),
    pvalue_fun = ~ style_pvalue(.x, digits = 3)
  )
# Table of predicted values
pop_dat %>%
  select(-slope_c_years) %>%
  rename(weightpercentile = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 1)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_c,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_c,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_c,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_c
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 1)
```

### Weight raw value (age >= 20 at ETI start)

```{r}
change_mod <- lmer(
  weight ~
    Years *
    Race +
    slope_c_years * Race +
    Insurance +
    prior_modulator +
    isOnEnzymes +
    pseudomonasaeruginosa +
    (1 | eDWID),
  data = encounter[encounter$age_eti_start >= 20, ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("weight") +
  theme_classic()
# Model summary
change_mod %>%
  gtsummary::tbl_regression(
    intercept = T,
    estimate_fun = ~ style_number(.x, digits = 1),
    pvalue_fun = ~ style_pvalue(.x, digits = 3)
  )
# Table of predicted values
pop_dat %>%
  select(-slope_c_years) %>%
  rename(weight = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 1)
# Contrasts
aa_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0)
aa_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
hl_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0)
hl_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0)
nhw_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
nhw_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
other_pre <- c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0)
other_c <- c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1)
contr <- rbind(
  "Black/AA Pre-ETI" = aa_pre,
  "Black/AA Post-ETI" = aa_pre + aa_c,
  "H/L Pre-ETI" = hl_pre,
  "H/L Post-ETI" = hl_pre + hl_c,
  "NHW Pre-ETI" = nhw_pre,
  "NHW Post-ETI" = nhw_pre + nhw_c,
  "Other Pre-ETI" = other_pre,
  "Other Post-ETI" = other_pre + other_c
)
change_mod_slopes <- glht(change_mod, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Race", rownames_to_stub = T) %>%
  fmt_number(decimals = 1)
```
