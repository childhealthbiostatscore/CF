---
title: "Racial and Ethnic Differences in ETI: Outcomes"
author: "Tim Vigers"
date: "today"
date-format: long
format:
  html:
    toc: true
    toc-depth: 5
    toc-float: true
    number-sections: true
    code-fold: true
    self-contained: true
    fig-cap-location: top
    fig-height: 10
    fig-width: 10
    page-layout: full
    theme:
      light: flatly
      dark: darkly
editor: source
---

```{r setup}
#| include: false
# Libraries
library(Hmisc)
library(tidyverse)
library(gt)
library(gtsummary)
library(ggflowchart)
library(lmerTest)
library(emmeans)
# Paths
home_dir <- switch(Sys.info()["sysname"],
  "Darwin" = "/Users/timvigers/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Vigers/CF",
  "Windows" = "C:/Users/timvigers/OneDrive - The University of Colorado Denver/Vigers/CF",
  "Linux" = "/home/timvigers/OneDrive/Vigers/CF"
)
knitr::opts_knit$set(root.dir = home_dir)
```

```{r data import}
# source("/home/timvigers/GitHub/CF/Kamyron Jordan/Racial and Ethnic Differences in ETI/create_outcomes_dataset.R")
load("./Kamyron Jordan/Racial and Ethnic Differences in ETI/Data_Cleaned/outcomes_dataset.RData")
# Change age group reference level
encounter$age_group <- relevel(encounter$age_group, ref = "[18,30)")
```

# Data cleaning

```{r flowchart}
ggflowchart(flow_chart)
```

# Table 1

## By person

Continuous variables are reported at the most recent visit prior to ETI start for each person, and categorical variables are reported as the most common value.

```{r}
t1_participant %>%
  select(-eDWID) %>%
  tbl_summary(
    by = Race,
    type = list(`Years With Data` ~ "continuous"),
    missing_text = "Missing"
  ) %>%
  add_overall()
```

# Encounter-level

```{r}
encounter %>%
  select(Race, encounterlocation, bacterialculturedone:othermicroorganisms1) %>%
  tbl_summary(by = Race, missing_text = "Missing")
```

# Outcome distributions

## FEV1 % predicted

### GLI 2022 equations

```{r}
ggplot(encounter, aes(x = gli_fev1_ppred_rn, fill = Race, color = Race)) +
  geom_density() +
  facet_wrap(~Race)
ggplot(encounter, aes(x = gli_fev1_ppred_rn, fill = Race)) +
  geom_density(alpha = 0.2)
```

### GLI 2012 equations

```{r}
ggplot(encounter, aes(x = GLI_FEV1_pct_predicted, fill = Race, color = Race)) +
  geom_density() +
  facet_wrap(~Race)
ggplot(encounter, aes(x = GLI_FEV1_pct_predicted, fill = Race)) +
  geom_density(alpha = 0.2)
```

## FVC % predicted

### GLI 2022 equations

```{r}
ggplot(encounter, aes(x = gli_fvc_ppred_rn, fill = Race, color = Race)) +
  geom_density() +
  facet_wrap(~Race)
ggplot(encounter, aes(x = gli_fvc_ppred_rn, fill = Race)) +
  geom_density(alpha = 0.2)
```

### GLI 2012 equations

```{r}
ggplot(encounter, aes(x = GLI_FVC_pct_predicted, fill = Race, color = Race)) +
  geom_density() +
  facet_wrap(~Race)
ggplot(encounter, aes(x = GLI_FVC_pct_predicted, fill = Race)) +
  geom_density(alpha = 0.2)
```

## FEV1/FVC % predicted

### GLI 2022 equations

```{r}
ggplot(encounter, aes(
  x = gli_fev1fvc_ppred_rn, fill = Race,
  color = Race
)) +
  geom_density() +
  facet_wrap(~Race)
ggplot(encounter, aes(x = gli_fev1fvc_ppred_rn, fill = Race)) +
  geom_density(alpha = 0.2)
```

### GLI 2012 equations

```{r}
ggplot(encounter, aes(x = GLI_FEV1FVC_pct_predicted, fill = Race, color = Race)) +
  geom_density() +
  facet_wrap(~Race)
ggplot(encounter, aes(x = GLI_FEV1FVC_pct_predicted, fill = Race)) +
  geom_density(alpha = 0.2)
```

## BMI %ile (age < 20 at ETI start)

```{r}
encounter %>%
  filter(age_eti_start < 20) %>%
  ggplot(aes(x = bmipercentile, fill = Race, color = Race)) +
  geom_density() +
  facet_wrap(~Race)
encounter %>%
  filter(age_eti_start < 20) %>%
  ggplot(aes(x = bmipercentile, fill = Race)) +
  geom_density(alpha = 0.2)
```

## BMI raw value (age >= 20 at ETI start)

```{r}
encounter %>%
  filter(age_eti_start >= 20) %>%
  ggplot(aes(x = bmivalue, fill = Race, color = Race)) +
  geom_density() +
  facet_wrap(~Race)
encounter %>%
  filter(age_eti_start >= 20) %>%
  ggplot(aes(x = bmivalue, fill = Race)) +
  geom_density(alpha = 0.2)
```

## Height %ile (age < 20 at ETI start)

```{r}
encounter %>%
  filter(age_eti_start < 20) %>%
  ggplot(aes(x = heightpercentile, fill = Race, color = Race)) +
  geom_density() +
  facet_wrap(~Race)
encounter %>%
  filter(age_eti_start < 20) %>%
  ggplot(aes(x = heightpercentile, fill = Race)) +
  geom_density(alpha = 0.2)
```

## Height raw value (age >= 20 at ETI start)

```{r}
encounter %>%
  filter(age_eti_start >= 20) %>%
  ggplot(aes(x = height, fill = Race, color = Race)) +
  geom_density() +
  facet_wrap(~Race)
encounter %>%
  filter(age_eti_start >= 20) %>%
  ggplot(aes(x = height, fill = Race)) +
  geom_density(alpha = 0.2)
```

## Weight %ile (age < 20 at ETI start)

```{r}
encounter %>%
  filter(age_eti_start < 20) %>%
  ggplot(aes(x = weightpercentile, fill = Race, color = Race)) +
  geom_density() +
  facet_wrap(~Race)
encounter %>%
  filter(age_eti_start < 20) %>%
  ggplot(aes(x = weightpercentile, fill = Race)) +
  geom_density(alpha = 0.2)
```

## Weight raw value (age >= 20 at ETI start)

```{r}
encounter %>%
  filter(age_eti_start >= 20) %>%
  ggplot(aes(x = weight, fill = Race, color = Race)) +
  geom_density() +
  facet_wrap(~Race)
encounter %>%
  filter(age_eti_start >= 20) %>%
  ggplot(aes(x = weight, fill = Race)) +
  geom_density(alpha = 0.2)
```

# Segmented models

```{r}
# Create change in slope variable
encounter$slope_change_days <- (encounter$Days > 0) * encounter$Days
label(encounter$slope_change_days) <- "Change in Slope"
encounter$Years <- encounter$Days / 365.25
encounter$slope_change_years <- (encounter$Years > 0) * encounter$Years
label(encounter$slope_change_years) <- "Change in Slope"
```

The following models are adjusted for age group and insurance status. We fit a Gaussian mixed model for continuous outcomes with random intercept for each subject (random slope did not improve the model AIC).

## FEV1 % predicted

### Full cohort

#### GLI 2022 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  gli_fev1_ppred_rn ~ Years * Race +
    slope_change_years * Race + age_group + Insurance + (1 | eDWID),
  data = encounter
)
# Model plot
pop_dat <- data.frame(expand.grid(
  Years = -3:2, Race = unique(encounter$Race), age_group = "[18,30)",
  Insurance = "Private"
))
pop_dat$slope_change_years <- (pop_dat$Years > 0) * pop_dat$Years
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("gli_fev1_ppred_rn") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(gli_fev1_ppred_rn = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 2)
```

#### GLI 2012 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  GLI_FEV1_pct_predicted ~ Years * Race +
    slope_change_years * Race + age_group + Insurance + (1 | eDWID),
  data = encounter
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("GLI_FEV1_pct_predicted") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(GLI_FEV1_pct_predicted = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 2)
```

### Age < 18 at ETI initiation

The following models were not adjusted for age group.

#### GLI 2022 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  gli_fev1_ppred_rn ~ Years * Race + slope_change_years * Race +
    Insurance + (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[-Inf,18)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("gli_fev1_ppred_rn") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(gli_fev1_ppred_rn = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 2)
```

#### GLI 2012 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  GLI_FEV1_pct_predicted ~ Years * Race +
    slope_change_years * Race + Insurance + (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[-Inf,18)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("GLI_FEV1_pct_predicted") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(GLI_FEV1_pct_predicted = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 2)
```

### Age >= 18 at ETI initiation

The following models were not adjusted for age group.

#### GLI 2022 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  gli_fev1_ppred_rn ~ Years * Race +
    slope_change_years * Race + Insurance + (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[18, Inf)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("gli_fev1_ppred_rn") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(gli_fev1_ppred_rn = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 2)
```

#### GLI 2012 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  GLI_FEV1_pct_predicted ~ Years * Race +
    slope_change_years * Race + Insurance + (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[18, Inf)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("GLI_FEV1_pct_predicted") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(GLI_FEV1_pct_predicted = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 2)
```

## FVC % predicted

### Full cohort

#### GLI 2022 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  gli_fvc_ppred_rn ~ Years * Race +
    slope_change_years * Race + age_group + Insurance + (1 | eDWID),
  data = encounter
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("gli_fvc_ppred_rn") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(gli_fvc_ppred_rn = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 2)
```

#### GLI 2012 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  GLI_FVC_pct_predicted ~ Years * Race +
    slope_change_years * Race + age_group + Insurance + (1 | eDWID),
  data = encounter
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("GLI_FVC_pct_predicted") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(GLI_FVC_pct_predicted = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 2)
```

### Age < 18 at ETI initiation

The following models were not adjusted for age group.

#### GLI 2022 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  gli_fvc_ppred_rn ~ Years * Race + slope_change_years * Race +
    Insurance + (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[-Inf,18)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("gli_fvc_ppred_rn") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(gli_fvc_ppred_rn = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 2)
```

#### GLI 2012 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  GLI_FVC_pct_predicted ~ Years * Race +
    slope_change_years * Race + Insurance + (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[-Inf,18)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("GLI_FVC_pct_predicted") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(GLI_FVC_pct_predicted = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 2)
```

### Age >= 18 at ETI initiation

The following models were not adjusted for age group.

#### GLI 2022 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  gli_fvc_ppred_rn ~ Years * Race +
    slope_change_years * Race + Insurance + (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[18, Inf)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("gli_fvc_ppred_rn") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(gli_fvc_ppred_rn = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 2)
```

#### GLI 2012 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  GLI_FVC_pct_predicted ~ Years * Race +
    slope_change_years * Race + Insurance + (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[18, Inf)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("GLI_FVC_pct_predicted") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(GLI_FVC_pct_predicted = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 2)
```

## FEV1/FVC % predicted

### Full cohort

#### GLI 2022 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  gli_fev1fvc_ppred_rn ~ Years * Race +
    slope_change_years * Race + age_group + Insurance + (1 | eDWID),
  data = encounter
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("gli_fev1fvc_ppred_rn") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(gli_fev1fvc_ppred_rn = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 2)
```

#### GLI 2012 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  GLI_FEV1FVC_pct_predicted ~ Years * Race +
    slope_change_years * Race + age_group + Insurance + (1 | eDWID),
  data = encounter
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("GLI_FEV1FVC_pct_predicted") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(GLI_FEV1FVC_pct_predicted = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 2)
```

### Age < 18 at ETI initiation

The following models were not adjusted for age group.

#### GLI 2022 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  gli_fev1fvc_ppred_rn ~ Years * Race + slope_change_years * Race +
    Insurance + (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[-Inf,18)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("gli_fev1fvc_ppred_rn") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(gli_fev1fvc_ppred_rn = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 2)
```

#### GLI 2012 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  GLI_FEV1FVC_pct_predicted ~ Years * Race +
    slope_change_years * Race + Insurance + (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[-Inf,18)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("GLI_FEV1FVC_pct_predicted") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(GLI_FEV1FVC_pct_predicted = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 2)
```

### Age >= 18 at ETI initiation

The following models were not adjusted for age group.

#### GLI 2022 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  gli_fev1fvc_ppred_rn ~ Years * Race +
    slope_change_years * Race + Insurance + (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[18, Inf)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("gli_fev1fvc_ppred_rn") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(gli_fev1fvc_ppred_rn = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 2)
```

#### GLI 2012 equations

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  GLI_FEV1FVC_pct_predicted ~ Years * Race +
    slope_change_years * Race + Insurance + (1 | eDWID),
  data = encounter[encounter$age_eti_group == "[18, Inf)", ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("GLI_FEV1FVC_pct_predicted") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(GLI_FEV1FVC_pct_predicted = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 2)
```

## BMI

### BMI %ile (age < 20 at ETI start)

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  bmipercentile ~ Years * Race +
    slope_change_years * Race + age_group + Insurance + (1 | eDWID),
  data = encounter[encounter$age_eti_start < 20, ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("bmipercentile") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(bmipercentile = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 2)
```

### BMI raw value (age >= 20 at ETI start)

```{r}
change_mod <- lmer(
  bmivalue ~ Years * Race +
    slope_change_years * Race + age_group + Insurance + (1 | eDWID),
  data = encounter[encounter$age_eti_start >= 20, ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("bmivalue") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(bmivalue = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 2)
```

## Height

### Height %ile (age < 20 at ETI start)

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  heightpercentile ~ Years * Race +
    slope_change_years * Race + age_group + Insurance + (1 | eDWID),
  data = encounter[encounter$age_eti_start < 20, ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("heightpercentile") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(heightpercentile = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 2)
```

### Height raw value (age >= 20 at ETI start)

```{r}
change_mod <- lmer(
  height ~ Years * Race +
    slope_change_years * Race + age_group + Insurance + (1 | eDWID),
  data = encounter[encounter$age_eti_start >= 20, ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("height") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(height = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 2)
```

## Weight

### Weight %ile (age < 20 at ETI start)

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  weightpercentile ~ Years * Race +
    slope_change_years * Race + age_group + Insurance + (1 | eDWID),
  data = encounter[encounter$age_eti_start < 20, ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("weightpercentile") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(weightpercentile = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 2)
```

### Weight raw value (age >= 20 at ETI start)

```{r}
change_mod <- lmer(
  weight ~ Years * Race +
    slope_change_years * Race + age_group + Insurance + (1 | eDWID),
  data = encounter[encounter$age_eti_start >= 20, ]
)
# Model plot
pred <- predict(change_mod, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(pop_dat, aes(x = Years, y = pred, group = Race, colour = Race)) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from ETI Start") +
  ylab("weight") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression(intercept = T)
# Table of predicted values
pop_dat %>%
  select(-slope_change_years) %>%
  rename(weight = pred, ci.ll = ll, ci.ul = ul) %>%
  gt() %>%
  fmt_number(decimals = 2)
```
