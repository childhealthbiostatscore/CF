---
title: "The Changing Face of Pediatric Pulmonary Exacerbations in CF (NACFC 2023)"
author: "Tim Vigers"
date: "today"
format:
  html:
    toc: false
    code-fold: true
    self-contained: true
    fig-cap-location: top
    page-layout: full
editor: source
execute: 
  echo: false
---

```{r}
#| include: false
library(tidyverse)
library(gtsummary)
# source("~/GitHub/CF/Scott Sagel/PEx in CF/create_pex_analysis_dataset.R")
load("~/Dropbox/Work/Vigers/CF/Scott Sagel/PEx in CF/Data_Cleaned/analysis_dataset.RData")
```

# Data cleaning notes

1. FEV1 % predicted at discharge was calculated using the `rspiro` package and GLI-2012 equations.
  - We did not distinguish between NE and SE Asian when capturing race, so all Asian participants were assumed to be NE Asian for these calculations (this was picked randomly).
  - Some participants are under age 3 and/or under 1 meter in height, so the ppFEV1 calculations may not be exactly accurate for these people.
2. For each person with multiple admissions, continuous variables were averaged prior to generating summary tables.
3. If a participant was on a modulators during any admission, they were counted as on modulators for that year.

The number of hospitalizations for PEx decreased from `r sum(df$Year==2018)` in 2018 to `r sum(df$Year==2022)` in 2022.

# Summary Statistics

```{r}
#| label: tbl-all
#| tbl-cap: Summary by Year
#| message: false
summary_table %>%
  select(-sid, -redcap_data_access_group) %>%
  select(num_hosp, days_admit:ppfev1_diff, age_at_admit, everything()) %>%
  tbl_summary(
    by = admit_year,
    type = list(num_hosp ~ "continuous"),
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      num_hosp ~ "{median} [{p25}, {p75}]",
      days_admit ~ "{median} [{p25}, {p75}]"
    ),
    missing_text = "(Missing)",
    label = labels
  )
```

```{r}
#| label: tbl-site
#| tbl-cap: Stratified by Site
#| message: false
summary_table %>%
  select(-sid, -cftr_mod_spec) %>%
  select(num_hosp, days_admit:ppfev1_diff, age_at_admit, everything()) %>%
  tbl_strata(
    strata = redcap_data_access_group,
    .tbl_fun =
      ~ .x %>%
        tbl_summary(
          by = admit_year,
          type = list(num_hosp ~ "continuous"),
          statistic = list(
            all_continuous() ~ "{mean} ({sd})",
            num_hosp ~ "{median} [{p25}, {p75}]",
            days_admit ~ "{median} [{p25}, {p75}]"
          ),
          missing_text = "(Missing)",
          label = labels
        )
  )
```
