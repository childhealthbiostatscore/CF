---
title: "SSwAB-IT Phase 1 Analysis"
author: "Tim Vigers"
date: "today"
date-format: long
format:
  html:
    toc: true
    toc-depth: 5
    toc-float: true
    code-fold: true
    self-contained: true
    fig-cap-location: top
    page-layout: full
    theme:
      light: flatly
      dark: darkly
bibliography: /Users/timvigers/Documents/Miscellaneous/zotero.bib
csl: /Users/timvigers/Documents/Miscellaneous/american-medical-association.csl
editor: source
---

```{r setup}
#| include: false
library(tidyverse)
library(gtsummary)
library(redcapAPI)
library(irr)
library(knitr)
home_dir <- switch(Sys.info()["sysname"],
  "Darwin" = "/Users/timvigers/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Vigers/CF",
  "Windows" = "C:/Users/timvigers/OneDrive - The University of Colorado Denver/Vigers/CF"
)
knitr::opts_knit$set(root.dir = home_dir)
```

```{r data cleaning}
#| include: false
# Import from REDCap
unlockREDCap(c(rcon = "SSwAB-IT (New)"),
  keyring = "API_KEYs",
  envir = 1,
  url = "https://redcap.ucdenver.edu/api/"
)
exportBulkRecords(list(db = rcon), envir = 1)
# Combine collection results
df <- full_join(db_cos_collection_results, db_sos_collection_results)
# Format
df <- df %>%
  select(
    record_id, redcap_data_access_group,
    staphylococcus_aureus_cos:other_result_cos,
    staphylococcus_aureus_sos:other_result_sos
  )
```

# Agreement

Cohen's kappa is interpreted analagously to a correlation coefficient, with -1 indicating perfect disagreement and 1 indicating perfect agreement. Tables with NaN and NAs indicate that all tests had the same values (i.e. all absent or all present).

| Cohen's Kappa | Interpretation         |
|---------------|------------------------|
| 0             | No agreement           |
| 0.10 - 0.20   | Slight agreement       |
| 0.21 - 0.40   | Fair agreement         |
| 0.41 - 0.60   | Moderate agreement     |
| 0.61 - 0.80   | Substantial agreement  |
| 0.81 - 0.99   | Near perfect agreement |
| 1             | Perfect agreement      |

```{r}
agreement <- function(bug, data = df) {
  cos <- paste0(bug, "_cos")
  sos <- paste0(bug, "_sos")
  d <- data[, c(cos, sos)]
  a <- agree(d)
  k <- kappa2(d)
  ct <- table(d[, cos])
  st <- table(d[, sos])
  return(list(
    "COS Absent" = ct[1], "COS Present" = ct[2],
    "SOS Absent" = st[1], "SOS Present" = st[2],
    "Percent Agreement" = a$value, "Cohen's Kappa" = k$value,
    "p value" = k$p.value
  ))
}
```

## Overall



## By bug

```{r}
bugs <- c(
  "staphylococcus_aureus", "haemophilus_influenza", "pseudomonas_aeruginosa",
  "pseudomonas_non_aero", "s_maltophilia", "burkholderia", "aspergillus", "ntm",
  "other"
)
bug_names <- c(
  "S. aureus", "H. influenza", "P. aeruginosa", "Pseudomonas non-aeruginosa",
  "S. maltophilia", "Burkholderia", "Aspergillus", "NTM", "Other"
)
bug_list = as.list(bug_names)
names(bug_list) = bugs
l <- lapply(bugs, function(b) {
  agreement(b)
})
l <- data.frame(do.call(rbind, l), check.names = F)
l <- data.frame(lapply(l, as.numeric), check.names = F)
rownames(l) <- bug_names
kable(l, digits = 2)
```

```{r results='asis'}
invisible(lapply(names(bug_list),function(b){
  cat("\n")
  cat("##",as.character(bug_list[b]))
  cat("\n")
  cos <- paste0(b, "_cos")
  sos <- paste0(b, "_sos")
  d <- df[, c(cos, sos)]
  t = data.frame(table(d))
  colnames(t) = c("COS","SOS","n")
  cat("\n")
  print(kable(t))
  cat("\n")
}))
```
