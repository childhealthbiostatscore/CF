---
title: "Remote Collection of Respiratory Samples"
author: "Tim Vigers"
date: "today"
date-format: long
format:
  html:
    toc: true
    toc-depth: 5
    toc-float: true
    code-fold: true
    self-contained: true
    fig-cap-location: top
    page-layout: full
    theme:
      light: flatly
      dark: darkly
bibliography: /Users/timvigers/Dropbox/Miscellaneous/zotero.bib
csl: /Users/timvigers/Dropbox/Miscellaneous/american-medical-association.csl
editor: source
---

```{r libraries}
#| include: false
library(tidyverse)
library(lubridate)
library(gtsummary)
library(eulerr)
```

```{r data cleaning, include=FALSE}
# Use REDCap import
source("/Users/timvigers/GitHub/CF/Jordana Hoppe/Home Collection/home_collection_data.r")
source("/Users/timvigers/GitHub/CF/Jordana Hoppe/Home Collection/home_collection_surveys.r")
# Fix missing labels
labels <- label(data)[which(label(data) != "")]
labels[paste0(names(labels), ".factor")] <- as.character(labels)
survey_labels <- label(survey_data)[which(label(survey_data) != "")]
survey_labels[paste0(names(survey_labels), ".factor")] <- as.character(survey_labels)
labels <- c(labels, survey_labels)
# Combine race columns
races <- c(
  "American Indian or Alaska Native", "Asian", "Black or African-American",
  "Native Hawaiian or Other Pacific Islander", "White", "More than one race",
  "Unknown or not reported"
)
data$race <- apply(data, 1, function(r) {
  w <- which(r[paste0("race___", 1:7)] == 1)
  paste0(races[w], collapse = "/")
})
# Age
data$age <- round(as.numeric(ymd(data$clinic_date) - ymd(data$pt_dob)) / 365.25, 1)
# Find tests with no growth
data$clinic_cx_no_growth <- apply(data, 1, function(r) {
  sum(as.numeric(r[grep("clinic_cx_results___\\d$", names(r))]))
})
data$res_cx_no_growth <- apply(data, 1, function(r) {
  sum(as.numeric(r[grep("res_cx_results___\\d$", names(r))]))
})
data$home_cx_no_growth <- apply(data, 1, function(r) {
  sum(as.numeric(r[grep("home_cx_results___\\d$", names(r))]))
})
# Additional labels for tables
labels["race"] <- "Race"
labels["age"] <- "Age at Clinic Visit"
```

# Summary Tables

## Table 1: Participant Characteristics

```{r}
#| label: tbl-1
#| tbl-cap: Participant Characteristics
data %>%
  select(
    age, pt_sex.factor, race, ethnicity.factor, mutation1.factor,
    mutation2.factor, rural_location.factor, fev1_pp, fvc_pp
  ) %>%
  mutate(
    mutation1.factor = droplevels(mutation1.factor),
    mutation2.factor = droplevels(mutation2.factor)
  ) %>%
  tbl_summary(
    label = labels, missing_text = "Missing",
    statistic = list(all_continuous() ~ "{mean} ({sd})")
  ) %>%
  as_kable_extra()
```

It appears that the two participants who were previously marked as unknown race are now considered more than one race.

## Table 2: Survey Results

```{r}
#| label: tbl-2
#| tbl-cap: Survey Results
survey_data %>%
  select(q1.factor:q6b___4.factor) %>%
  tbl_summary(
    label = labels, missing_text = "Missing"
  ) %>%
  as_kable_extra()
```

## Table 3: Clinic Culture Results

```{r}
#| label: tbl-3
#| tbl-cap: Clinic Culture Results
data %>%
  select(clinic_cx_source.factor:clinic_burk_sp.factor) %>%
  tbl_summary(
    label = labels, missing_text = "Missing"
  ) %>%
  as_kable_extra()
```

## Table 4: Research Culture Results

```{r}
#| label: tbl-4
#| tbl-cap: Research Culture Results
data %>%
  select(research_cx.factor:res_burk_sp.factor) %>%
  tbl_summary(
    label = labels, missing_text = "Missing"
  ) %>%
  as_kable_extra()
```

## Table 5: Home Culture Results

```{r}
#| label: tbl-5
#| tbl-cap: Home Culture Results
data %>%
  select(home_cx.factor:home_burk_sp.factor) %>%
  tbl_summary(
    label = labels, missing_text = "Missing"
  ) %>%
  as_kable_extra()
```

For Yes/No variables in @tbl-2 through @tbl-5, the percentage of "Yes" answers is shown.

# Agreement

## Euler Diagrams

### MSSA

```{r}
data %>%
  select(
    clinic_cx_results___1.factor, res_cx_results___1.factor,
    home_cx_results___1.factor
  ) %>%
  mutate(across(
    everything(),
    ~ factor(., levels = c("Checked", "Unchecked"), labels = c(1, 0))
  )) %>%
  mutate(across(
    everything(), ~ as.numeric(as.character(.))
  )) %>%
  rename(
    Clinic = clinic_cx_results___1.factor,
    Research = res_cx_results___1.factor,
    Home = home_cx_results___1.factor
  ) %>%
  euler(.) %>%
  plot(., quantities = T)
```

### *H. flu*

```{r}
data %>%
  select(
    clinic_cx_results___3.factor, res_cx_results___3.factor,
    home_cx_results___3.factor
  ) %>%
  mutate(across(
    everything(),
    ~ factor(., levels = c("Checked", "Unchecked"), labels = c(1, 0))
  )) %>%
  mutate(across(
    everything(), ~ as.numeric(as.character(.))
  )) %>%
  rename(
    Clinic = clinic_cx_results___3.factor,
    Research = res_cx_results___3.factor,
    Home = home_cx_results___3.factor
  ) %>%
  euler(.) %>%
  plot(., quantities = T)
```

### No growth

```{r}
data %>%
  select(clinic_cx_no_growth, res_cx_no_growth, home_cx_no_growth) %>%
  mutate(across(
    everything(), ~ .==0)
  ) %>%
  rename(
    Clinic = clinic_cx_no_growth,
    Research = res_cx_no_growth,
    Home = home_cx_no_growth
  ) %>%
  euler(.) %>%
  plot(., quantities = T)
```
