---
title: "Sweat electrolytes and CFTR activity in the era of CFTR modulators"
author: "Tim Vigers"
date: "today"
date-format: long
format:
  html:
    toc: true
    toc-depth: 10
    toc-float: true
    number-sections: true
    code-fold: true
    embed-resources: true
    fig-cap-location: top
    page-layout: full
editor: source
---

```{r setup}
#| include: false
library(knitr)
library(Hmisc)
library(lubridate)
library(readxl)
library(tidyverse)
library(arsenal)
library(pROC)
library(patchwork)
home_dir <- switch(
  Sys.info()["sysname"],
  "Darwin" = "/Users/tim/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Vigers/CF/Edith Zemanick/Sweat Variability",
  "Windows" = "C:/Users/Tim/OneDrive - The University of Colorado Denver/Vigers/CF/Edith Zemanick/Sweat Variability",
  "Linux" = "/home/tim/OneDrive/Vigers/CF/Edith Zemanick/Sweat Variability"
)
github_dir <- switch(
  Sys.info()["sysname"],
  "Darwin" = "/Users/tim/Documents/GitHub",
  "Windows" = "C:/Users/Tim/Documents/GitHub",
  "Linux" = "/home/tim/Documents/GitHub"
)
source(paste0(github_dir, "/CF/genotype_class_severity.R"))
knitr::opts_knit$set(root.dir = home_dir)
```

```{r data cleaning}
#| message: false
setwd(home_dir)
# Import CHCO, filter out those with no demo data, rename columns, etc.
chco <- read.csv(
  "./Data_Cleaned/chco_reidentified.csv",
  na.strings = c(
    "",
    "Test not performed",
    "Insufficient quant.",
    "repeat sweat chloride testing",
    "Please reorder testing and re",
    "The received specimen cannot"
  )
)
chco <- chco %>%
  group_by(PatientID) %>%
  filter(Demographics.Available == "TRUE") %>%
  select(
    PatientID,
    Name,
    DOB,
    Genotypes1,
    Genotypes2,
    Sex,
    Age.at.Test.in.Years,
    Method,
    Na,
    K,
    Cl,
    Na_Left,
    Na_Right,
    K_Left,
    K_Right,
    Cl_Left,
    Cl_Right
  ) %>%
  rename(Age = Age.at.Test.in.Years) %>%
  mutate(Name = tolower(gsub("[[:punct:] ]+", "", Name)))
# Fix CHCO diagnoses per Angela
chco_diagnoses <- read.csv("./Data_Cleaned/chco_diagnoses.csv")
chco <- full_join(chco, chco_diagnoses, by = join_by(PatientID))
# Manual fixes per Angela's 11/21/25 email
chco$Diagnosis[chco$PatientID == 549] = "CFTR-related disorder"
chco$Diagnosis[chco$PatientID == 650] = "Cystic Fibrosis"
chco$Diagnosis[chco$PatientID == 653] = "CFTR-related disorder"
chco$Diagnosis[chco$PatientID == 693] = "Cystic Fibrosis"
chco$Diagnosis[chco$PatientID == 702] = "Cystic Fibrosis"
chco$Diagnosis[chco$PatientID == 721] = "Cystic Fibrosis"
chco$Diagnosis[chco$PatientID == 736] = "CFTR-related disorder"
chco[nrow(chco) + 1, ] <- NA
chco$PatientID[nrow(chco)] = 692
chco$Age[nrow(chco)] = (mdy("3/24/2014") - mdy("9/26/13")) / 365.25
chco$Diagnosis[nrow(chco)] = "CRMS"
chco$Na_Left[nrow(chco)] = 24.1
chco$Na_Right[nrow(chco)] = 21.1
chco$Cl[nrow(chco)] = 30
chco$Cl_Right[nrow(chco)] = 30
chco[nrow(chco) + 1, ] <- NA
chco$PatientID[nrow(chco)] = 724
chco$Age[nrow(chco)] = (mdy("5/08/2015") - mdy("1/18/09")) / 365.25
chco$Diagnosis[nrow(chco)] = "CFTR-related disorder"
chco$Na_Left[nrow(chco)] = 72.4
chco$Na_Right[nrow(chco)] = 72.4
chco$Cl_Left[nrow(chco)] = 64
chco$Cl_Right[nrow(chco)] = 59
chco$PatientID <- NULL
# Manually add some Na and Cl values that Angela was able to find (using
# numbers so that no PHI is on GitHub)
chco$Na_Right[791] <- 61.3
chco$Na_Right[826] <- 72.4
chco$Na_Left[826] <- 72.4
chco$Na_Right[790] <- 21.1
chco$Na_Left[790] <- 24.1
# For "LESS THAN 10", replace with missing
chco[chco == "LESS THAN 10"] <- NA
chco[, c("Cl", "Cl_Left", "Cl_Right")] <-
  lapply(chco[, c("Cl", "Cl_Left", "Cl_Right")], as.numeric)
# Import NJH and add diagnoses from Katie
njh <- read.csv(
  "./Data_Cleaned/njh_full_list.csv",
  na.strings = c(
    "",
    "Test not performed",
    "Insufficient quant.",
    "repeat sweat chloride testing"
  )
)
njh_diagnoses <- read.csv("./Data_Cleaned/njh_diagnoses.csv", na.strings = "")
njh_diagnoses <- njh_diagnoses %>% filter(!is.na(Diagnosis))
njh <- full_join(njh, njh_diagnoses)
# Filter out those with no demo data, rename columns, etc.
njh <- njh %>%
  group_by(Patient.ID) %>%
  filter(Demographics.Available == "TRUE") %>%
  select(
    Patient.ID,
    Patient.Name,
    Birth.Date,
    Genotype.1,
    Genotype.2,
    Sex,
    Age.at.test..in.years.,
    Test.Method,
    Sweat.sodium,
    Sweat.potassium,
    Sweat.chloride,
    Sweat.sodium.left.arm,
    Sweat.sodium.right.arm,
    Sweat.potassium.left.arm,
    Sweat.potassium.right.arm,
    Sweat.chloride.left.arm,
    Sweat.chloride.right.arm,
    Diagnosis
  ) %>%
  rename(
    Name = Patient.Name,
    Genotypes1 = Genotype.1,
    DOB = Birth.Date,
    Genotypes2 = Genotype.2,
    Age = Age.at.test..in.years.,
    Method = Test.Method,
    Na = Sweat.sodium,
    K = Sweat.potassium,
    Cl = Sweat.chloride,
    Na_Left = Sweat.sodium.left.arm,
    Na_Right = Sweat.sodium.right.arm,
    K_Left = Sweat.potassium.left.arm,
    K_Right = Sweat.potassium.right.arm,
    Cl_Left = Sweat.chloride.left.arm,
    Cl_Right = Sweat.chloride.right.arm
  ) %>%
  mutate(Name = tolower(gsub("[[:punct:] ]+", "", Name)))
njh$Patient.ID <- NULL
# Row bind, fill diagnosis, then remove dupes
df <- rbind(chco, njh)
method <- df %>%
  select(Name, Age, Method, Na, Cl) %>%
  distinct() %>%
  drop_na()
df <- df %>%
  select(-Method) %>%
  group_by(Name) %>%
  fill(Diagnosis) %>%
  distinct() %>%
  select(Name, Diagnosis, everything()) %>%
  arrange(Name, Age)
# For those with left and right, average them
df$Na_mean <- rowMeans(df[, c("Na_Left", "Na_Right")], na.rm = T)
df$Na <- coalesce(df$Na, df$Na_mean)
df$Cl_mean <- rowMeans(df[, c("Cl_Left", "Cl_Right")], na.rm = T)
df$Cl <- coalesce(df$Cl, df$Cl_mean)
df$K_mean <- rowMeans(df[, c("K_Left", "K_Right")], na.rm = T)
df$K <- coalesce(df$K, df$K_mean)
# Change Cl under 10 or over 160 to missing
df$Cl[df$Cl < 10] <- NA
df$Cl[df$Cl > 160] <- NA
# Remove Na under 10 as well
df$Na[df$Na < 10] <- NA
# Calculate Na:Cl ratio
df$`Na:Cl` <- df$Na / df$Cl
# Use each person's first sweat test with both sodium and chloride
df <- df %>%
  filter(!is.na(`Na:Cl`)) %>%
  group_by(Name) %>%
  slice_min(Age)
# If there are still duplicates, exclude them
dups <- df$Name[duplicated(df$Name)]
df <- df[!df$Name %in% dups, ]
# Get rid of unnecessary columns, remove those with no diagnosis
df <- df %>%
  select(
    Name,
    DOB,
    Diagnosis,
    Genotypes1,
    Genotypes2,
    Sex,
    Age,
    Na,
    K,
    Cl,
    `Na:Cl`
  ) %>%
  filter(!is.na(Diagnosis))
# Combine CFTR-related disorder and CRMS
df$Diagnosis <- factor(
  df$Diagnosis,
  levels = c("Cystic Fibrosis", "CFTR-related disorder", "CRMS", "Non-CF"),
  labels = c(
    "Cystic Fibrosis",
    "CFTR-RD or CRMS",
    "CFTR-RD or CRMS",
    "Non-CF"
  )
)
# Additional changes based on Angela's review
df$Diagnosis[which(is.na(df$Name))] <- "Cystic Fibrosis"
df$Diagnosis[400] <- "Cystic Fibrosis"
df$Na[541] <- 69
# Angela reviewed a random set of 75 patients and requested the changes below
# See the "random_pull.csv" document for details
# Changes done by row number to avoid PHI in GitHub
df$Cl[1473] <- 103.5
df$Na[505] <- 42.6
df$Na[238] <- 73
df$Na[541] <- 69
df$Na[747] <- 88.9
# Remove people per Angela's recommendation and duplicates based on DOB review
df <- df[
  -c(
    78,
    79,
    183,
    257,
    259,
    270,
    314,
    342,
    691,
    719,
    724,
    737,
    812,
    903,
    1012,
    1066,
    1126,
    1151,
    1202,
    1209,
    1222,
    1224,
    1340,
    1428,
    1456
  ),
]
# Get genotype severity
## By severity
df$geno_risk_1 <- cf_genotype_class_severity(df$Genotypes1)
df$geno_risk_2 <- cf_genotype_class_severity(df$Genotypes2)
df$geno_risk_1[df$Diagnosis == "Non-CF"] <- "Not CF"
df$geno_risk_2[df$Diagnosis == "Non-CF"] <- "Not CF"
df$geno_risk <- paste(df$geno_risk_1, df$geno_risk_2, sep = "/")
df$geno_risk <- factor(
  df$geno_risk,
  levels = c(
    "Mild/Mild",
    "Mild/Severe",
    "Mild/Unknown",
    "Severe/Mild",
    "Severe/Severe",
    "Severe/Unknown",
    "Unknown/Severe",
    "Unknown/Unknown",
    "Not CF/Not CF"
  ),
  labels = c(
    "Low",
    "Low",
    "Unknown",
    "Low",
    "High",
    "Unknown",
    "Unknown",
    "Unknown",
    "Not CF"
  )
)
# Create a categorical column for Cl
df$`Cl Group` <- cut(
  df$Cl,
  breaks = c(-Inf, 30, 60, Inf),
  right = F,
  labels = c("< 30", "30-59", ">= 60")
)
# Add method back in
df <- left_join(df, method) %>% arrange(Name, desc(Method))
# Organize columns, remove age over 50 (there shouldn't be any age < 2 days)
df <- df %>%
  select(Name:Genotypes2, geno_risk, everything()) %>%
  select(-geno_risk_1, -geno_risk_2) %>%
  rename(`Genotype Risk` = geno_risk) %>%
  filter(Age < 50)
df <- df[-which(duplicated(df$Name)), ]
# Age groups
df$`Age Group` = cut(
  df$Age,
  breaks = c(-Inf, 18, Inf),
  labels = c("< 18", ">= 18"),
  right = FALSE
)
# All genotypes
df$`Detailed Genotype` = paste0(df$Genotypes1, "/", df$Genotypes2)
# Specific genotypes
df$Genotypes1[
  !df$Genotypes1 %in%
    c(
      "F508del",
      "G542X",
      "G551D",
      "W1282X",
      "N1303K",
      "R117H"
    )
] = "Other"
df$Genotypes2[
  !df$Genotypes2 %in%
    c(
      "F508del",
      "G542X",
      "G551D",
      "W1282X",
      "N1303K",
      "R117H"
    )
] = "Other"
df$Genotype = paste0(df$Genotypes1, "/", df$Genotypes2)
df$Genotype = factor(
  df$Genotype,
  levels = c(
    "F508del/F508del",
    "F508del/G542X",
    "F508del/G551D",
    "F508del/N1303K",
    "F508del/Other",
    "F508del/R117H",
    "F508del/W1282X",
    "G542X/G551D",
    "G542X/N1303K",
    "G542X/Other",
    "G542X/R117H",
    "G551D/Other",
    "G551D/R117H",
    "N1303K/G542X",
    "N1303K/N1303K",
    "N1303K/Other",
    "Other/F508del",
    "Other/G542X",
    "Other/Other",
    "Other/W1282X",
    "R117H/F508del",
    "R117H/Other",
    "W1282X/N1303K"
  ),
  labels = c(
    "F508del/F508del",
    "F508del/G542X",
    "F508del/G551D",
    "F508del/N1303K",
    "F508del/Other",
    "F508del/R117H",
    "F508del/W1282X",
    "Other",
    "Other",
    "Other",
    "Other",
    "Other",
    "Other",
    "Other",
    "Other",
    "Other",
    "F508del/Other",
    "Other",
    "Other",
    "Other",
    "F508del/R117H",
    "Other",
    "Other"
  )
)
# Order factor variables
df$Diagnosis = factor(
  df$Diagnosis,
  levels = c("Cystic Fibrosis", "CFTR-RD or CRMS", "Non-CF")
)
df$`Genotype Risk` = factor(
  df$`Genotype Risk`,
  levels = c("Not CF", "Low", "High", "Unknown")
)
# Reclassify genotypes per Angela and Edith
new_genotypes = read.csv(
  "./Data_Cleaned/reclassified_genotypes_2026-02-09.csv",
  na.strings = ""
)
new_genotypes$NewRisk = coalesce(
  new_genotypes$Reclassification,
  new_genotypes$Risk
)
df$`Genotype Risk` = new_genotypes$NewRisk[match(
  df$`Detailed Genotype`,
  new_genotypes$Genotype
)]
# Set table options
mycontrols <- tableby.control(
  numeric.stats = c("N", "Nmiss", "meansd", "medianq1q3", "iqr", "range"),
  simulate.p.value = TRUE
)
# Save this for Angela et al. to check
write.csv(
  df,
  file = "./Data_Cleaned/sweat_variability_analysis_dataset.csv",
  row.names = F,
  na = ""
)
# Make detailed genotype table for manuscript
geno_tab = xtabs(
  ~ `Detailed Genotype` + `Genotype Risk`,
  data = df,
  addNA = T
) |>
  data.frame() |>
  filter(Freq > 0, Detailed.Genotype != "NA/NA") |>
  select(-Freq)
geno_diag = table(df$`Detailed Genotype`, df$Diagnosis) |>
  data.frame() |>
  filter(Freq != 0, Var1 != "NA/NA") |>
  arrange(Var1) |>
  pivot_wider(names_from = Var2, values_from = Freq)
geno_diag = left_join(
  geno_diag,
  geno_tab,
  by = join_by(Var1 == Detailed.Genotype)
)
geno_diag[is.na(geno_diag)] = 0
geno_diag[, c("Cystic Fibrosis", "CFTR-RD or CRMS", "Non-CF")] = lapply(
  geno_diag[, c("Cystic Fibrosis", "CFTR-RD or CRMS", "Non-CF")],
  function(c) {
    return(paste0(c, " (", scales::percent(c / sum(c)), ")"))
  }
)
geno_diag = geno_diag |> rename(Genotype = Var1, Risk = Genotype.Risk)
write.csv(
  geno_diag,
  file = "./Data_Cleaned/genotype_counts.csv",
  row.names = F,
  na = ""
)
```

# Data Cleaning

- Started with 5,046 sweat tests with 4,646 unique individuals.
- 1,551 did not have demographics available.
- 399 with Cl < 10 and 1 with Cl > 160
- 156 with Na < 10
- 19 over age 50 and 3 under age 2 days
- 43 with insufficient quantity 
- 25 on modulators

# Full Cohort

## Table 1: Participant Demographics by Diagnosis

```{r results='asis'}
summary(
  tableby(
    Diagnosis ~
      Method +
      Sex +
      Age +
      fe(`Age Group`) +
      fe(Genotype) +
      fe(`Genotype Risk`) +
      fe(`Cl Group`) +
      Cl +
      Na +
      `Na:Cl` +
      K,
    data = df,
    simulate.p.value = T,
    control = mycontrols
  ),
  pfootnote = T
)
```

## Table 2: CF Demographics by Genotype Risk

```{r results='asis'}
summary(
  tableby(
    `Genotype Risk` ~
      Sex +
      Age +
      fe(`Age Group`) +
      fe(Genotype) +
      fe(`Cl Group`) +
      Cl +
      Na +
      `Na:Cl` +
      K,
    data = df[
      df$`Genotype Risk` != "Unknown" & df$Diagnosis == "Cystic Fibrosis",
    ],
    simulate.p.value = T,
    control = mycontrols
  ),
  pfootnote = T
)
```

## Table 3: Participant Demographics by Chloride Group

```{r results='asis'}
summary(
  tableby(
    `Cl Group` ~ Sex +
      Age +
      fe(`Age Group`) +
      fe(Genotype) +
      Cl +
      Na +
      `Na:Cl` +
      K,
    data = df,
    control = mycontrols
  ),
  pfootnote = T
)
```

## Boxplots

### Chloride

#### By diagnosis

```{r}
#| warning: false
group_n <- df |> group_by(Diagnosis) |> summarise(n = n()) |> mutate(pos = 160)
clp_d <- ggplot(df, aes(x = Diagnosis, y = Cl)) +
  geom_boxplot() +
  geom_label(
    data = group_n,
    aes(x = Diagnosis, y = pos, label = paste("n =", n))
  ) +
  theme_bw()
clp_d
```

#### By genotype risk

```{r}
#| warning: false
geno_n <- df |>
  group_by(`Genotype Risk`) |>
  summarise(n = n()) |>
  mutate(pos = 160)
clp_g <- ggplot(df, aes(x = `Genotype Risk`, y = Cl)) +
  geom_boxplot() +
  geom_label(
    data = geno_n,
    aes(x = `Genotype Risk`, y = pos, label = paste("n =", n))
  ) +
  theme_bw()
clp_g
```

### Sodium

#### By diagnosis

```{r}
#| warning: false
nap_d <- ggplot(df, aes(x = Diagnosis, y = Na)) +
  geom_boxplot() +
  geom_label(
    data = group_n,
    aes(x = Diagnosis, y = pos, label = paste("n =", n))
  ) +
  theme_bw()
nap_d
```

#### By genotype risk

```{r}
#| warning: false
nap_g <- ggplot(df, aes(x = `Genotype Risk`, y = Na)) +
  geom_boxplot() +
  geom_label(
    data = geno_n,
    aes(x = `Genotype Risk`, y = pos, label = paste("n =", n))
  ) +
  theme_bw()
nap_g
```

### Na:Cl

#### By diagnosis

```{r}
#| warning: false
group_n$pos = 4
ratiop_d <- ggplot(df, aes(x = Diagnosis, y = `Na:Cl`)) +
  geom_boxplot() +
  geom_label(
    data = group_n,
    aes(x = Diagnosis, y = pos, label = paste("n =", n))
  ) +
  theme_bw() +
  ylab("Na:Cl")
ratiop_d
```

#### By genotype risk

```{r}
#| warning: false
geno_n$pos = 4
ratiop_g <- ggplot(df, aes(x = `Genotype Risk`, y = `Na:Cl`)) +
  geom_boxplot() +
  geom_label(
    data = geno_n,
    aes(x = `Genotype Risk`, y = pos, label = paste("n =", n))
  ) +
  theme_bw() +
  ylab("Na:Cl")
ratiop_g
```

```{r}
p1 = (clp_d + ratiop_d) / (clp_g + ratiop_g)
p1
ggsave(
  filename = "./Dissemination/Figures/fig1.png",
  plot = p1,
  height = 9,
  width = 12,
  units = "in",
  dpi = 600
)
```

## Na:Cl ROC Curves

### By Diagnosis

```{r}
# Fit a multiclass ROC
mc_roc <- multiclass.roc(
  df$Diagnosis,
  df$`Na:Cl`,
  quiet = T,
  levels = c("Non-CF", "CFTR-RD or CRMS", "Cystic Fibrosis")
)
roc_list = mc_roc$rocs
names(roc_list) <- lapply(mc_roc$rocs, function(r) {
  paste(r$levels, collapse = " vs. ")
})
ggroc(roc_list, legacy.axes = T) +
  theme_bw() +
  theme(legend.title = element_blank())
roc_table <- lapply(roc_list, function(r) {
  coords(
    r,
    "best",
    best.method = "youden",
    ret = c(
      "threshold",
      "sensitivity",
      "specificity",
      "accuracy",
      "tpr",
      "fpr",
      "tnr",
      "fnr"
    )
  )
})
roc_table <- do.call(rbind, roc_table)
kable(roc_table, digits = 3)
```

- The multiclass AUC for Na:Cl is `r round(as.numeric(auc(mc_roc)),3)`. 

#### Individual ROC Curves

```{r}
plot(
  roc_list[[1]],
  print.auc = T,
  print.thres = T,
  main = names(roc_list)[1]
)
plot(
  roc_list[[2]],
  print.auc = T,
  print.thres = T,
  main = names(roc_list)[2]
)
plot(
  roc_list[[3]],
  print.auc = T,
  print.thres = T,
  main = names(roc_list)[3]
)
```

### By genotype risk

```{r}
# Fit a multiclass ROC
gr_roc <- roc(
  `Genotype Risk` ~ `Na:Cl`,
  data = df,
  levels = c("Low", "High"),
  quiet = T
)
plot(
  gr_roc,
  print.auc = T,
  print.thres = T,
  main = "Low vs. High Risk Genotype"
)
kable(coords(
  gr_roc,
  "best",
  best.method = "youden",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "accuracy",
    "tpr",
    "fpr",
    "tnr",
    "fnr"
  )
))
```

# Excluding Cl < 30

```{r}
df <- df %>% filter(Cl >= 30)
```

## Table 1: Participant Demographics by Diagnosis

```{r results='asis'}
summary(
  tableby(
    Diagnosis ~
      Method +
      Sex +
      Age +
      fe(`Age Group`) +
      fe(Genotype) +
      fe(`Genotype Risk`) +
      fe(`Cl Group`) +
      Cl +
      Na +
      `Na:Cl` +
      K,
    data = df,
    simulate.p.value = T,
    control = mycontrols
  ),
  pfootnote = T
)
```

## Table 2: Participant Demographics by Genotype Risk

```{r results='asis'}
summary(
  tableby(
    `Genotype Risk` ~
      Sex +
      Age +
      fe(`Age Group`) +
      fe(Genotype) +
      fe(`Cl Group`) +
      Cl +
      Na +
      `Na:Cl` +
      K,
    data = df[
      df$`Genotype Risk` != "Unknown" & df$Diagnosis == "Cystic Fibrosis",
    ],
    simulate.p.value = T,
    control = mycontrols
  ),
  pfootnote = T
)
```

## Table 3: Participant Demographics by Chloride Group

```{r results='asis'}
summary(
  tableby(
    `Cl Group` ~ Sex +
      Age +
      fe(`Age Group`) +
      fe(Genotype) +
      Cl +
      Na +
      `Na:Cl` +
      K,
    data = df,
    control = mycontrols
  ),
  pfootnote = T
)
```

## Boxplots

### Chloride

#### By diagnosis

```{r}
#| warning: false
group_n <- df |> group_by(Diagnosis) |> summarise(n = n()) |> mutate(pos = 160)
clp_d <- ggplot(df, aes(x = Diagnosis, y = Cl)) +
  geom_boxplot() +
  geom_label(
    data = group_n,
    aes(x = Diagnosis, y = pos, label = paste("n =", n))
  ) +
  theme_bw()
clp_d
```

#### By genotype risk

```{r}
#| warning: false
geno_n <- df |>
  group_by(`Genotype Risk`) |>
  summarise(n = n()) |>
  mutate(pos = 160)
clp_g <- ggplot(df, aes(x = `Genotype Risk`, y = Cl)) +
  geom_boxplot() +
  geom_label(
    data = geno_n,
    aes(x = `Genotype Risk`, y = pos, label = paste("n =", n))
  ) +
  theme_bw()
clp_g
```

### Sodium

#### By diagnosis

```{r}
#| warning: false
nap_d <- ggplot(df, aes(x = Diagnosis, y = Na)) +
  geom_boxplot() +
  geom_label(
    data = group_n,
    aes(x = Diagnosis, y = pos, label = paste("n =", n))
  ) +
  theme_bw()
nap_d
```

#### By genotype risk

```{r}
#| warning: false
nap_g <- ggplot(df, aes(x = `Genotype Risk`, y = Na)) +
  geom_boxplot() +
  geom_label(
    data = geno_n,
    aes(x = `Genotype Risk`, y = pos, label = paste("n =", n))
  ) +
  theme_bw()
nap_g
```

### Na:Cl

#### By diagnosis

```{r}
#| warning: false
group_n$pos = 4
ratiop_d <- ggplot(df, aes(x = Diagnosis, y = `Na:Cl`)) +
  geom_boxplot() +
  geom_label(
    data = group_n,
    aes(x = Diagnosis, y = pos, label = paste("n =", n))
  ) +
  theme_bw() +
  ylab("Na:Cl")
ratiop_d
```

#### By genotype risk

```{r}
#| warning: false
geno_n$pos = 4
ratiop_g <- ggplot(df, aes(x = `Genotype Risk`, y = `Na:Cl`)) +
  geom_boxplot() +
  geom_label(
    data = geno_n,
    aes(x = `Genotype Risk`, y = pos, label = paste("n =", n))
  ) +
  theme_bw() +
  ylab("Na:Cl")
ratiop_g
```

```{r}
p2 = (clp_d + ratiop_d) / (clp_g + ratiop_g)
p2
ggsave(
  filename = "./Dissemination/Figures/fig2.png",
  plot = p2,
  height = 9,
  width = 12,
  units = "in",
  dpi = 600
)
```

## Na:Cl ROC Curves

### By Diagnosis

```{r}
# Fit a multiclass ROC
mc_roc <- multiclass.roc(
  df$Diagnosis,
  df$`Na:Cl`,
  quiet = T,
  levels = c("Non-CF", "CFTR-RD or CRMS", "Cystic Fibrosis")
)
roc_list = mc_roc$rocs
names(roc_list) <- lapply(mc_roc$rocs, function(r) {
  paste(r$levels, collapse = " vs. ")
})
ggroc(roc_list, legacy.axes = T) +
  theme_bw() +
  theme(legend.title = element_blank())
roc_table <- lapply(roc_list, function(r) {
  coords(
    r,
    "best",
    best.method = "youden",
    ret = c(
      "threshold",
      "sensitivity",
      "specificity",
      "accuracy",
      "tpr",
      "fpr",
      "tnr",
      "fnr"
    )
  )
})
roc_table <- do.call(rbind, roc_table)
kable(roc_table, digits = 3)
```

- The multiclass AUC for Na:Cl is `r round(as.numeric(auc(mc_roc)),3)`. 

#### Individual ROC Curves

```{r}
plot(
  roc_list[[1]],
  print.auc = T,
  print.thres = T,
  main = names(roc_list)[1]
)
plot(
  roc_list[[2]],
  print.auc = T,
  print.thres = T,
  main = names(roc_list)[2]
)
plot(
  roc_list[[3]],
  print.auc = T,
  print.thres = T,
  main = names(roc_list)[3]
)
```

### By genotype risk

```{r}
# Fit a multiclass ROC
gr_roc <- roc(
  `Genotype Risk` ~ `Na:Cl`,
  data = df,
  levels = c("Low", "High"),
  quiet = T
)
plot(
  gr_roc,
  print.auc = T,
  print.thres = T,
  main = "Low vs. High Risk Genotype"
)
kable(coords(
  gr_roc,
  "best",
  best.method = "youden",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "accuracy",
    "tpr",
    "fpr",
    "tnr",
    "fnr"
  )
))
```