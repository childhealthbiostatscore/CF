---
title: "Sweat electrolytes and CFTR activity in the era of CFTR modulators"
author: "Tim Vigers"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 5
    toc_float: yes
---

```{r setup, include=FALSE}
library(readxl)
library(arsenal)
library(tidyverse)
library(pROC)
library(knitr)
knitr::opts_chunk$set(echo = FALSE)
if (Sys.info()["sysname"] == "Windows") {
  home_dir <- "C:/Users/timvigers/OneDrive - The University of Colorado Denver/Vigers/CF/Edith Zemanick/Sweat Test"
  source("C:/Users/timvigers/Documents/GitHub/CF/get_genotype_class_severity.R")
} else if (Sys.info()["sysname"] == "Linux") {
  home_dir <- "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Vigers/CF/Edith Zemanick/Sweat Test"
  source("~/GitHub/CF/get_genotype_class_severity.R")
} else if (Sys.info()["sysname"] == "Darwin") {
  home_dir <- "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Vigers/CF/Edith Zemanick/Sweat Test"
  source("~/GitHub/CF/genotype_class_severity.R")
}
knitr::opts_knit$set(root.dir = home_dir)
rm(home_dir)
```

```{r}
# Import exclusion data from Excel
diagnoses <- read_excel("./Data_Cleaned/AM reclassifications All Patients with CF or Non-CF.xlsx")
exclude <- diagnoses$PatientID[!is.na(diagnoses$Exclude)]
# Import data
df <- read.csv("./Data_Raw/Copy of Sweat Tests_AllFor202558_revised01Feb2021.csv", na.strings = "")
# Remove exclusions from Angela
df <- df[!(df$PatientID %in% exclude), ]
df$Diagnosis <- diagnoses$Diagnosis[match(df$PatientID, diagnoses$PatientID)]
# Add modulator info
cftr <- read.csv("./Data_Raw/Copy of Report CFTR Modulators.csv")
df$Modulator <- apply(df, 1, function(r) {
  mod <- cftr[cftr$Patient.ID == as.numeric(r["PatientID"]), ]
  if (any(duplicated(mod$Age.at.Start..years.))) {
    mod <- mod[-which(duplicated(mod$Age.at.Start..years.)), ]
  }
  mod <- mod[order(mod$Age.at.Start..years.), ]
  age <- as.numeric(r["Age.at.Test.in.Years"])
  as.character(cut(age, c(-Inf, mod$Age.at.Start..years., Inf),
    labels = c("None", mod$Modulator), right = F
  ))
})
# Numeric variables
num_vars <- c("Amount", "Na", "K", "Cl")
num_vars <- c(paste0(num_vars, "_Left"), paste0(num_vars, "_Right"))
df[, num_vars] <- suppressWarnings(lapply(df[, num_vars], as.numeric))
# Filter per Maxie's code
df <- df %>%
  mutate(Age.at.Test.in.Days = Age.at.Test.in.Weeks * 7) %>%
  filter(
    Age.at.Test.in.Years < 50 & Age.at.Test.in.Days >= 2,
    !(Diagnosis == "Non-CF" & PatientID %in%
      c(22, 23, 24, 29, 31, 474, 483, 484, 485, 505, 510, 785, 791, 792, 793)),
    Modulator == "None"
  ) %>%
  distinct(.) %>%
  filter(Sex != "", Demographics.Available == "TRUE")
# Genotype info
## By severity
df$geno1 <- cf_genotype_class_severity(df$Genotypes1)
df$geno2 <- cf_genotype_class_severity(df$Genotypes2)
df$geno1[df$Diagnosis == "Non-CF"] <- "Not CF"
df$geno2[df$Diagnosis == "Non-CF"] <- "Not CF"
df$geno_risk <- paste(df$geno1, df$geno2, sep = "_")
df$geno_risk <- factor(df$geno_risk,
  levels = c(
    "Severe_Severe", "Mild_Severe", "Mild_Unknown", "Severe_Mild", "Mild_Mild",
    "Not CF_Not CF", "Severe_Unknown", "Unknown_Severe", "Unknown_Unknown"
  ),
  labels = c(
    "High", "Low", "Low", "Low", "Low", "Not CF", "Unknown",
    "Unknown", "Unknown"
  )
)
## By function
df$geno1_class <- cf_genotype_class_severity(df$Genotypes1, out = "class")
df$geno1_class[grep("508", df$Genotypes1)] <- "F508del"
df$geno1_class <- replace(df$geno1_class, df$geno1_class %in% c("I", "II", "III"), "MF")
df$geno1_class <- replace(df$geno1_class, df$geno1_class %in% c("IV", "V"), "RF")

df$geno2_class <- cf_genotype_class_severity(df$Genotypes2, out = "class")
df$geno2_class[grep("508", df$Genotypes2)] <- "F508del"
df$geno2_class <- replace(df$geno2_class, df$geno2_class %in% c("I", "II", "III"), "MF")
df$geno2_class <- replace(df$geno2_class, df$geno2_class %in% c("IV", "V"), "RF")


df$geno_class <- factor(paste0(
  pmin(df$geno1_class, df$geno2_class), "/",
  pmax(df$geno1_class, df$geno2_class)
))
# Which arm?
df$Arm <- apply(df[, c("Cl", "Cl_Left", "Cl_Right", "Na", "Na_Left", "Na_Right", "K", "K_Left", "K_Right")], 1, function(r) {
  k <- sum(!is.na(r))
  if (k == 6) {
    return("Both")
  } else if (k == 3) {
    return("Arm Not Noted")
  } else {
    return(NA)
  }
})

# Difference between arms
df$`Cl Diff. Between Left and Right Arm` <- as.numeric(df$Cl_Left) - as.numeric(df$Cl_Right)
df$`Na Diff. Between Left and Right Arm` <- as.numeric(df$Na_Left) - as.numeric(df$Na_Right)
# Merge left and right values
df$Amount <- apply(df[, c("Amount", "Amount_Left", "Amount_Right")], 1, function(r) {
  amt <- suppressWarnings(as.numeric(as.character(r)))
  mean(amt, na.rm = T)
})
df$Cl <- apply(df[, c("Cl", "Cl_Left", "Cl_Right")], 1, function(r) {
  cl <- suppressWarnings(as.numeric(as.character(r)))
  mean(cl, na.rm = T)
})
df$Na <- apply(df[, c("Na", "Na_Left", "Na_Right")], 1, function(r) {
  na <- suppressWarnings(as.numeric(as.character(r)))
  mean(na, na.rm = T)
})
df$K <- apply(df[, c("K", "K_Left", "K_Right")], 1, function(r) {
  k <- suppressWarnings(as.numeric(as.character(r)))
  mean(k, na.rm = T)
})
# Sodium to chloride ratio
df$`Na/Cl Ratio` <- df$Na / df$Cl
# Sort
df <- df %>% arrange(PatientID, Age.at.Test.in.Weeks)
# Table options (most variables are not normally distributed)
mycontrols <- tableby.control(numeric.test = "kwt", numeric.stats = c("Nmiss", "median", "q1q3"))
labels <- list(
  Age.at.Test.in.Years = "Age (Years)",
  geno_risk = "Genotype Severity", geno_class = "Specific Genotype"
)
```

# Patient Demographics and Sample Characteristics

For those with two sweat electrolyte measures (left and right), the average of the two was used. Each participants' first sweat test value was used for the following tables.

## By diagnosis

```{r results='asis'}
t1_df <- df %>%
  group_by(PatientID) %>%
  filter(row_number() == 1) # First measure for everyone
t1 <- tableby(
  Diagnosis ~ Sex + Age.at.Test.in.Years + fe(geno_risk) + fe(geno_class) +
    Amount + Cl + Na + K + `Na/Cl Ratio`,
  data = t1_df, control = mycontrols, simulate.p.value = T
)
summary(t1,
  pfootnote = T,
  labelTranslations = labels
)
```

## By method

```{r results='asis'}
t1 <- tableby(
  Method ~ Sex + Age.at.Test.in.Years + Diagnosis + fe(geno_risk) + fe(geno_class) +
    Amount + Cl + Na + K + `Na/Cl Ratio` + `Cl Diff. Between Left and Right Arm` +
    `Na Diff. Between Left and Right Arm`,
  data = t1_df, control = mycontrols, simulate.p.value = T
)
summary(t1,
  pfootnote = T,
  labelTranslations = labels
)
```

# Electrolyte comparisons

## By diagnosis

```{r results='asis'}
t1 <- tableby(
  Diagnosis ~ Amount + Cl + Na + K + `Na/Cl Ratio` +
    `Cl Diff. Between Left and Right Arm` +
    `Na Diff. Between Left and Right Arm`,
  data = t1_df, control = mycontrols,
)
summary(t1,
  pfootnote = T,
  labelTranslations = labels
)
```

### Gibson-Cooke only

```{r results='asis'}
t1 <- tableby(
  Diagnosis ~ Amount + Cl + Na + K + `Na/Cl Ratio` +
    `Cl Diff. Between Left and Right Arm` +
    `Na Diff. Between Left and Right Arm`,
  data = t1_df[t1_df$Method == "Gibson-Cooke", ], control = mycontrols,
)
summary(t1,
  pfootnote = T,
  labelTranslations = labels
)
```

### Macroduct only

```{r results='asis'}
t1 <- tableby(
  Diagnosis ~ Amount + Cl + Na + K + `Na/Cl Ratio` +
    `Cl Diff. Between Left and Right Arm` +
    `Na Diff. Between Left and Right Arm`,
  data = t1_df[t1_df$Method == "Macroduct", ], control = mycontrols,
)
summary(t1,
  pfootnote = T,
  labelTranslations = labels
)
```

## By genotype risk

```{r results='asis'}
t1 <- tableby(
  geno_risk ~ Amount + Cl + Na + K + `Na/Cl Ratio` +
    `Cl Diff. Between Left and Right Arm` +
    `Na Diff. Between Left and Right Arm`,
  data = t1_df, control = mycontrols,
)
summary(t1,
  pfootnote = T,
  labelTranslations = labels
)
```

## By genotype risk and diagnosis

### Cystic fibrosis

```{r results='asis'}
t1 <- tableby(geno_risk ~ Amount + Cl + Na + K + `Na/Cl Ratio` + `Cl Diff. Between Left and Right Arm` + `Na Diff. Between Left and Right Arm`,
  data = t1_df[t1_df$Diagnosis == "Cystic Fibrosis", ], control = mycontrols
)
summary(t1,
  pfootnote = T,
  labelTranslations = labels
)
```

### CFTR-related disorder

```{r results='asis'}
t1 <- tableby(geno_risk ~ Amount + Cl + Na + K + `Na/Cl Ratio` + `Cl Diff. Between Left and Right Arm` + `Na Diff. Between Left and Right Arm`,
  data = t1_df[t1_df$Diagnosis == "CFTR-related disorder", ], control = mycontrols
)
summary(t1,
  pfootnote = T,
  labelTranslations = labels
)
```

### CRMS

```{r results='asis'}
t1 <- tableby(geno_risk ~ Amount + Cl + Na + K + `Na/Cl Ratio` + `Cl Diff. Between Left and Right Arm` + `Na Diff. Between Left and Right Arm`,
  data = t1_df[t1_df$Diagnosis == "CRMS", ], control = mycontrols
)
summary(t1,
  pfootnote = T,
  labelTranslations = labels
)
```

### Non-CF

```{r results='asis'}
t1 <- tableby(~ Amount + Cl + Na + K + `Na/Cl Ratio` + `Cl Diff. Between Left and Right Arm` + `Na Diff. Between Left and Right Arm`,
  data = t1_df[t1_df$Diagnosis == "Non-CF", ], control = mycontrols
)
summary(t1,
  pfootnote = T,
  labelTranslations = labels
)
```

### Plots

```{r warning=FALSE}
ggplot(df, aes(x = Diagnosis, y = Na)) +
  geom_boxplot() +
  theme_bw() +
  ggtitle("Sweat Sodium")

ggplot(df, aes(x = Diagnosis, y = K)) +
  geom_boxplot() +
  theme_bw() +
  ggtitle("Sweat Potassium")

ggplot(df, aes(x = Diagnosis, y = Cl)) +
  geom_boxplot() +
  theme_bw() +
  ggtitle("Sweat Chloride")

ggplot(df, aes(x = Diagnosis, y = `Na/Cl Ratio`)) +
  geom_boxplot() +
  theme_bw() +
  ggtitle("Na/Cl Ratio")
```

## By specific genotype

```{r results='asis'}
t1 <- tableby(
  geno_class ~ Amount + Cl + Na + K + `Na/Cl Ratio` +
    `Cl Diff. Between Left and Right Arm` +
    `Na Diff. Between Left and Right Arm`,
  data = t1_df, control = mycontrols,
)
summary(t1,
  pfootnote = T,
  labelTranslations = labels
)
```

## By specific genotype and diagnosis

### Cystic fibrosis

```{r results='asis'}
t1 <- tableby(geno_class ~ Amount + Cl + Na + K + `Na/Cl Ratio` + `Cl Diff. Between Left and Right Arm` + `Na Diff. Between Left and Right Arm`,
  data = t1_df[t1_df$Diagnosis == "Cystic Fibrosis", ], control = mycontrols
)
summary(t1,
  pfootnote = T,
  labelTranslations = labels
)
```

### CFTR-related disorder

```{r results='asis'}
t1 <- tableby(geno_class ~ Amount + Cl + Na + K + `Na/Cl Ratio` + `Cl Diff. Between Left and Right Arm` + `Na Diff. Between Left and Right Arm`,
  data = t1_df[t1_df$Diagnosis == "CFTR-related disorder", ], control = mycontrols
)
summary(t1,
  pfootnote = T,
  labelTranslations = labels
)
```

### CRMS

```{r results='asis'}
t1 <- tableby(geno_class ~ Amount + Cl + Na + K + `Na/Cl Ratio` + `Cl Diff. Between Left and Right Arm` + `Na Diff. Between Left and Right Arm`,
  data = t1_df[t1_df$Diagnosis == "CRMS", ], control = mycontrols
)
summary(t1,
  pfootnote = T,
  labelTranslations = labels
)
```

### Non-CF

```{r results='asis'}
t1 <- tableby(~ Amount + Cl + Na + K + `Na/Cl Ratio` + `Cl Diff. Between Left and Right Arm` + `Na Diff. Between Left and Right Arm`,
  data = t1_df[t1_df$Diagnosis == "Non-CF", ], control = mycontrols
)
summary(t1,
  pfootnote = T,
  labelTranslations = labels
)
```

### Plots

```{r warning=FALSE}
ggplot(df, aes(x = geno_class, y = Na)) +
  geom_boxplot() +
  theme_bw() +
  xlab("Specific Genotype") +
  ggtitle("Sweat Sodium")

ggplot(df, aes(x = geno_class, y = K)) +
  geom_boxplot() +
  theme_bw() +
  ggtitle("Sweat Potassium")

ggplot(df, aes(x = geno_class, y = Cl)) +
  geom_boxplot() +
  theme_bw() +
  xlab("Specific Genotype") +
  ggtitle("Sweat Chloride")

ggplot(df, aes(x = geno_class, y = `Na/Cl Ratio`)) +
  geom_boxplot() +
  theme_bw() +
  xlab("Specific Genotype") +
  ggtitle("Na/Cl Ratio")
```

# Between occasion

For all participants with more than one sweat test, we compared their first and last values.

```{r results='asis'}
# Get first and last values for everyone with more than 1
multiples <- df %>%
  group_by(PatientID) %>%
  filter(n() > 1) %>% # Multiple values only
  filter(row_number() == 1 | row_number() == n()) %>% # First and last
  mutate(time = row_number())
multiples$time <- factor(multiples$time, levels = 1:2, labels = c("First", "Last"))
# Paired testing options
mycontrols <- tableby.control(
  numeric.test = "signed.rank", cat.test = "mcnemar",
  numeric.stats = c("Nmiss", "median", "q1q3")
)
```

## Overall

```{r results='asis'}
p <- paired(
  time ~ Diagnosis + Cl + Na + K + `Na/Cl Ratio` +
    `Cl Diff. Between Left and Right Arm` +
    `Na Diff. Between Left and Right Arm`,
  signed.rank.exact = F, data = multiples,
  id = PatientID, control = mycontrols
)
summary(p, pfootnote = T, labelTranslations = labels)
```

## By diagnosis

Not enough observations in CRMS or CFTR-related disorder groups to calculate p values. Also not enough observations to further break down the table by sweat collection method. 

```{r results='asis'}
p <- paired(time ~ Cl + Na + K + `Na/Cl Ratio` + `Cl Diff. Between Left and Right Arm` + `Na Diff. Between Left and Right Arm`,
  signed.rank.exact = F, strata = Diagnosis,
  data = multiples %>% filter(Diagnosis %in% c("Cystic Fibrosis", "Non-CF")),
  id = PatientID, control = mycontrols
)
summary(p, pfootnote = T, labelTranslations = labels)
```

## By genotype risk

```{r results='asis'}
p <- paired(time ~ Cl + Na + K + `Na/Cl Ratio` + `Cl Diff. Between Left and Right Arm` + `Na Diff. Between Left and Right Arm`,
  signed.rank.exact = F, strata = geno_risk,
  data = multiples,
  id = PatientID, control = mycontrols
)
summary(p, pfootnote = T, labelTranslations = labels)
```

## By genotype risk and diagnosis

Not enough paired observations in the CRMS or CFTR-related disorder groups.

### Cystic fibrosis

```{r results='asis'}
p <- paired(time ~ Cl + Na + K + `Na/Cl Ratio`,
  signed.rank.exact = F, strata = geno_risk,
  data = multiples %>% filter(Diagnosis == "Cystic Fibrosis"),
  id = PatientID, control = mycontrols
)
summary(p, pfootnote = T, labelTranslations = labels)
```

### Non-CF

```{r results='asis'}
p <- paired(time ~ Cl + Na + K + `Na/Cl Ratio`,
  signed.rank.exact = F, strata = geno_risk,
  data = multiples %>% filter(Diagnosis == "Non-CF"),
  id = PatientID, control = mycontrols
)
summary(p, pfootnote = T, labelTranslations = labels)
```

## By specific genotype

```{r results='asis'}
p <- paired(
  time ~ Cl + Na + K + `Na/Cl Ratio` +
    `Cl Diff. Between Left and Right Arm` +
    `Na Diff. Between Left and Right Arm`,
  signed.rank.exact = F, strata = geno_class, numeric.test = "notest",
  data = multiples, id = PatientID, control = mycontrols
)
summary(p, pfootnote = T, labelTranslations = labels)
```

## By genotype class and diagnosis

Not enough paired observations in the CRMS or CFTR-related disorder groups.

### Cystic fibrosis

```{r results='asis'}
p <- paired(time ~ Cl + Na + K + `Na/Cl Ratio`,
  signed.rank.exact = F, strata = geno_class,
  data = multiples %>% filter(Diagnosis == "Cystic Fibrosis"),
  id = PatientID, control = mycontrols
)
summary(p, pfootnote = T, labelTranslations = labels)
```

### Non-CF

```{r results='asis'}
p <- paired(time ~ Cl + Na + K + `Na/Cl Ratio`,
  signed.rank.exact = F, strata = geno_class,
  data = multiples %>% filter(Diagnosis == "Non-CF"),
  id = PatientID, control = mycontrols
)
summary(p, pfootnote = T, labelTranslations = labels)
```

# Cutoff analyses

We performed receiver operating characteristic (ROC) analysis to find a sweat sodium to sweat chloride cutoff that distinguishes between groups. Only the first sweat test from each participant was used.

## Full cohort

The full cohort analyses include all participants.

### Diagnosis

#### ROC

```{r}
# Re-format diagnosis column
t1_df$`Combined Diagnosis` <- factor(t1_df$Diagnosis,
                     levels = c("Non-CF","CFTR-related disorder","CRMS","Cystic Fibrosis"),
                     labels = c("Non-CF","CFTR-related disorder or CRMS","CFTR-related disorder or CRMS","Cystic Fibrosis"),
                     ordered = T)

```

```{r}
roc_cf <- roc(response= t1_df$`Combined Diagnosis`,
              predictor = t1_df$`Na/Cl Ratio`, 
              levels = c("CFTR-related disorder or CRMS","Cystic Fibrosis"),
              quiet = T)
coords_cf <- round(coords(roc_cf, "best", best.method = "youden"), 3)


roc_non_cf <- roc(response= t1_df$`Combined Diagnosis`,
              predictor = t1_df$`Na/Cl Ratio`, 
              levels = c("Non-CF","CFTR-related disorder or CRMS"),
              quiet = T)
coords_non_cf <- round(coords(roc_non_cf, "best", best.method = "youden"), 3)

plot(roc_cf, print.auc = TRUE, col = "blue")
plot(roc_non_cf, print.auc = TRUE, col = "green", print.auc.y = .4, add = TRUE)
```

The blue curve shows the ROC for distinguishing between CFTR-related disorder or CRMS vs. CF, and the green is the ROC curve for distinguishing between non-CF vs. CFTR-related disorder or CRMS. The optimal threshold for distinguishing between CFTR-related disorder or CRMS vs. CF was `r coords_cf$threshold` (sensitivity = `r coords_cf$sensitivity`, specificity = `r coords_cf$specificity`) based on the Youden index. The optimal threshold for distinguishing between non-CF vs. CFTR-related disorder or CRMS was `r coords_non_cf$threshold` (sensitivity = `r coords_non_cf$sensitivity`, specificity = `r coords_non_cf$specificity`) based on the Youden index. The mean AUC for the two curves is `r round(mean(c(roc_cf$auc,roc_non_cf$auc)),3)`.

#### Histogram by group

Vertical blue line indicates the threshold for CFTR-related disorder or CRMS vs. CF and green indicates the threshold for non-CF vs. CFTR-related disorder or CRMS. Na/Cl ratio was log-transformed for easier visualization.

```{r warning=FALSE}
ggplot(t1_df[!is.na(t1_df$`Combined Diagnosis`), ], 
       aes(log(`Na/Cl Ratio`), fill = `Combined Diagnosis`)) +
  geom_histogram(alpha = 0.3, position = "identity",bins = 50) +
  geom_vline(xintercept = log(coords_cf$threshold), color = "blue") +
  geom_vline(xintercept = log(coords_non_cf$threshold), color = "green") +
  ylab("Count") + xlab("ln(Na/Cl Ratio)") +
  theme_bw()
```

### Genotype

Participants with unknown genotype risk were excluded from this analysis.

#### ROC

```{r}
# Re-format diagnosis column
t1_df$`Genotype Risk` <- factor(t1_df$geno_risk,
                     levels = c("Not CF","Low","High","Unknown"),
                     ordered = T)
t1_df$`Genotype Risk`[t1_df$`Genotype Risk`=="Unknown"]= NA
```

```{r}
roc_cf <- roc(response= t1_df$`Genotype Risk`,
              predictor = t1_df$`Na/Cl Ratio`, 
              levels = c("Low","High"),
              quiet = T)
coords_cf <- round(coords(roc_cf, "best", best.method = "youden"), 3)


roc_non_cf <- roc(response= t1_df$`Genotype Risk`,
              predictor = t1_df$`Na/Cl Ratio`, 
              levels = c("Not CF","Low"),
              quiet = T)
coords_non_cf <- round(coords(roc_non_cf, "best", best.method = "youden"), 3)

plot(roc_cf, print.auc = TRUE, col = "blue")
plot(roc_non_cf, print.auc = TRUE, col = "green", print.auc.y = .4, add = TRUE)
```

The blue curve shows the ROC for distinguishing between low vs. high risk, and the green is the ROC curve for distinguishing between non-CF vs. low risk. The optimal threshold for distinguishing between low vs. high risk was `r coords_cf$threshold` (sensitivity = `r coords_cf$sensitivity`, specificity = `r coords_cf$specificity`) based on the Youden index. The optimal threshold for distinguishing between non-CF vs. low risk was `r coords_non_cf$threshold` (sensitivity = `r coords_non_cf$sensitivity`, specificity = `r coords_non_cf$specificity`) based on the Youden index. The mean AUC for the two curves is `r round(mean(c(roc_cf$auc,roc_non_cf$auc)),3)`.

#### Histogram by group

Vertical blue line indicates the threshold for low vs. high risk and green indicates the threshold for non-CF vs. low risk. Na/Cl ratio was log-transformed for easier visualization.

```{r warning=FALSE}
ggplot(t1_df[!is.na(t1_df$`Genotype Risk`), ], 
       aes(log(`Na/Cl Ratio`), fill = `Genotype Risk`)) +
  geom_histogram(alpha = 0.3, position = "identity",bins = 50) +
  geom_vline(xintercept = log(coords_cf$threshold), color = "blue") +
  geom_vline(xintercept = log(coords_non_cf$threshold), color = "green") +
  ylab("Count") + xlab("ln(Na/Cl Ratio)") +
  theme_bw()
```

## Limited cohort

The limited cohort analyses only included participants with sweat chloride < 60.

### Diagnosis

#### ROC

```{r}
# Exclude those with Cl >= 60
t1_df = t1_df %>% filter(Cl < 60)
```

```{r}
roc_cf <- roc(response= t1_df$`Combined Diagnosis`,
              predictor = t1_df$`Na/Cl Ratio`, 
              levels = c("CFTR-related disorder or CRMS","Cystic Fibrosis"),
              quiet = T)
coords_cf <- round(coords(roc_cf, "best", best.method = "youden"), 3)


roc_non_cf <- roc(response= t1_df$`Combined Diagnosis`,
              predictor = t1_df$`Na/Cl Ratio`, 
              levels = c("Non-CF","CFTR-related disorder or CRMS"),
              quiet = T)
coords_non_cf <- round(coords(roc_non_cf, "best", best.method = "youden"), 3)

plot(roc_cf, print.auc = TRUE, col = "blue")
plot(roc_non_cf, print.auc = TRUE, col = "green", print.auc.y = .4, add = TRUE)
```

The blue curve shows the ROC for distinguishing between CFTR-related disorder or CRMS vs. CF, and the green is the ROC curve for distinguishing between non-CF vs. CFTR-related disorder or CRMS. The optimal threshold for distinguishing between CFTR-related disorder or CRMS vs. CF was `r coords_cf$threshold` (sensitivity = `r coords_cf$sensitivity`, specificity = `r coords_cf$specificity`) based on the Youden index. The optimal threshold for distinguishing between non-CF vs. CFTR-related disorder or CRMS was `r coords_non_cf$threshold` (sensitivity = `r coords_non_cf$sensitivity`, specificity = `r coords_non_cf$specificity`) based on the Youden index. The mean AUC for the two curves is `r round(mean(c(roc_cf$auc,roc_non_cf$auc)),3)`.

#### Histogram by group

Vertical blue line indicates the threshold for CFTR-related disorder or CRMS vs. CF and green indicates the threshold for non-CF vs. CFTR-related disorder or CRMS. Na/Cl ratio was log-transformed for easier visualization.

```{r warning=FALSE}
ggplot(t1_df[!is.na(t1_df$`Combined Diagnosis`), ], 
       aes(log(`Na/Cl Ratio`), fill = `Combined Diagnosis`)) +
  geom_histogram(alpha = 0.3, position = "identity",bins = 50) +
  geom_vline(xintercept = log(coords_cf$threshold), color = "blue") +
  geom_vline(xintercept = log(coords_non_cf$threshold), color = "green") +
  ylab("Count") + xlab("ln(Na/Cl Ratio)") +
  theme_bw()
```

### Genotype

Participants with unknown genotype risk were excluded from this analysis.

#### ROC

```{r}
roc_cf <- roc(response= t1_df$`Genotype Risk`,
              predictor = t1_df$`Na/Cl Ratio`, 
              levels = c("Low","High"),
              quiet = T)
coords_cf <- round(coords(roc_cf, "best", best.method = "youden"), 3)


roc_non_cf <- roc(response= t1_df$`Genotype Risk`,
              predictor = t1_df$`Na/Cl Ratio`, 
              levels = c("Not CF","Low"),
              quiet = T)
coords_non_cf <- round(coords(roc_non_cf, "best", best.method = "youden"), 3)

plot(roc_cf, print.auc = TRUE, col = "blue")
plot(roc_non_cf, print.auc = TRUE, col = "green", print.auc.y = .4, add = TRUE)
```

The blue curve shows the ROC for distinguishing between low vs. high risk, and the green is the ROC curve for distinguishing between non-CF vs. low risk. The optimal threshold for distinguishing between low vs. high risk was `r coords_cf$threshold` (sensitivity = `r coords_cf$sensitivity`, specificity = `r coords_cf$specificity`) based on the Youden index. The optimal threshold for distinguishing between non-CF vs. low risk was `r coords_non_cf$threshold` (sensitivity = `r coords_non_cf$sensitivity`, specificity = `r coords_non_cf$specificity`) based on the Youden index. The mean AUC for the two curves is `r round(mean(c(roc_cf$auc,roc_non_cf$auc)),3)`.

#### Histogram by group

Vertical blue line indicates the threshold for low vs. high risk and green indicates the threshold for non-CF vs. low risk. Na/Cl ratio was log-transformed for easier visualization.

```{r warning=FALSE}
ggplot(t1_df[!is.na(t1_df$`Genotype Risk`), ], 
       aes(log(`Na/Cl Ratio`), fill = `Genotype Risk`)) +
  geom_histogram(alpha = 0.3, position = "identity",bins = 50) +
  geom_vline(xintercept = log(coords_cf$threshold), color = "blue") +
  geom_vline(xintercept = log(coords_non_cf$threshold), color = "green") +
  ylab("Count") + xlab("ln(Na/Cl Ratio)") +
  theme_bw()
```
