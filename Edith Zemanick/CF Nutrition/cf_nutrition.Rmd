---
title: "Serum Biomarkers of Nutrition Pre and Post CFTR Modulator Use in Children with Cystic Fibrosis"
author: "Tim Vigers"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(arsenal)
library(tidyverse)
library(readxl)
library(performance)
library(mcp)
library(lmerTest)
library(plotly)
library(knitr)
knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "S:/PEDS/RI Biostatistics Core/Shared/Shared Projects/Vigers/CF"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Vigers/CF"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Vigers/CF"
}
knitr::opts_knit$set(root.dir = home_dir)
rm(home_dir)
source("~/GitHub/CF/get_genotype_class_severity.R")
```

```{r data cleaning}
# Import
df = read.csv("./Edith Zemanick/CF Nutrition/Data_Cleaned/analysis_dataset.csv",na.strings = "")
# Only those on effective modulators
on_effective = unique(df$Patient.ID[which(df[,'Modulator'] %in% c('Kalydeco','Trikafta'))])
df = df %>% filter(Patient.ID %in% on_effective)
# Non-highy efective to "None
df$Modulator[!df$Modulator %in% c('Kalydeco','Trikafta')] = "None"
# Before or after
df$Before_After = df$Age.at.Test..Years. < df$Age.at.Start..years.
df$Before_After = factor(df$Before_After,levels = c(FALSE,TRUE),labels = c("After","Before"))
# Count number of measures 
num_values = df %>% group_by(Patient.ID,Before_After) %>% 
  summarise(n = sum(!is.na(X25OH.Vitamin.D)),.groups = "drop") %>%
  pivot_wider(id_cols = Patient.ID,names_from = Before_After,values_from = n)
num_values$`NA` = NULL
colnames(num_values)[2:3] = c("vit_measures_after","vit_measures_before")
df = left_join(df,num_values,by = "Patient.ID")
# At least two annual nutritional measurements prior to first modulator start date
two_measures = num_values$Patient.ID[which(num_values$`vit_measures_before` >= 2)]
# At least one measurement of nutritional markers and one weight/height measurement >= three months post-modulator
time_after = df %>% 
  filter(Age.at.Test..Years. >= (Age.at.Start..years. + 0.25),!is.na(X25OH.Vitamin.D)) %>%
  pull(Patient.ID) %>% unique(.)
# Filter out those without above criteria, get first modulator
df = df %>% filter(Patient.ID %in% intersect(two_measures,time_after)) %>%
  group_by(Patient.ID) %>% 
  mutate(first_mod = head(Modulator[Modulator != "None"],1)) %>% ungroup()
# Genotype group
geno = read_excel("./CF Info/Sweat Tests from Internal Database_genotype class.xlsx")
geno = geno[,c('PatientID','genoRisk')]
df = left_join(df,geno,by = c('Patient.ID' = 'PatientID'))
# Time prior to first modulator
years = df %>% group_by(Patient.ID,Before_After) %>% 
  mutate(years_to_start_max = max(abs(Age.at.Test..Years. - Age.at.Start..years.))) %>% 
  select(Patient.ID,Before_After,years_to_start_max) %>% 
  ungroup() %>% distinct(.) %>%
  pivot_wider(id_cols = Patient.ID,names_from = Before_After,values_from = years_to_start_max)
years$`NA` = NULL
colnames(years)[2:3] = c('max_years_to_start','max_years_from_start')
df = left_join(df,years,by = "Patient.ID")
df$years = df$Age.at.Test..Years. - df$Age.at.Start..years.
```

# Participant Characteristics

For each person, we calculated the maximum amount of time from the earliest nutrition measure before modulator start to start date, and the amount of time from modulator start date to most recent nutrition measure. The ranges of these values are presented below ("Years to start" and "Years From start," respectively).

```{r results='asis'}
df$Sex[df$Sex == ""] = NA
demo = df %>% group_by(Patient.ID) %>% fill(Sex,.direction = "downup") %>% 
  filter(row_number() == 1)
t1 = tableby(first_mod ~ Age.at.Start..years. + Sex + genoRisk + 
               vit_measures_after + vit_measures_before +
               notest(max_years_to_start,"min","max") + 
               notest(max_years_from_start,"min","max"),
             data = demo,
             control = tableby.control(numeric.stats=c("Nmiss", "median", "q1q3"),))
summary(t1,test = F,
        labelTranslations = 
          list(Age.at.Start..years. = "Age at Start (years)",
               genoRisk = "Genotype risk group",
               vit_measures_after = "No. of vitamin measures post",
               vit_measures_before = "No. of vitamin measures pre",
               max_years_to_start = "Years to start",max_years_from_start = "Years From start"))
```

# Vitamin measures before and after modulator initiation

For each participant, we selected the pre and post visit closest to modulator start (and at least 3 months after start) with both a vitamin A and FEV1 % predicted value measure. Some visits were on different days and had different measures, so some missing values were filled in with the closest value (within 1 month). 

```{r results='asis'}
nutrition_vars = c("VitaminA_Retinol","X25OH.Vitamin.D","Vitamin.E.Alpha",
                   "BMI","FEV1...pred")
# Get the most recent 
paired_df = df %>% 
  select(Patient.ID,Before_After,years,first_mod,all_of(nutrition_vars)) %>% 
  filter(years >= 0.25 | years < 0) %>%
  mutate(years = round(years,1)) %>%
  group_by(Patient.ID,years) %>%
  fill(all_of(nutrition_vars),.direction = "downup") %>%
  drop_na(any_of(c("X25OH.Vitamin.D"))) %>%
  group_by(Patient.ID,Before_After) %>%
  slice_min(abs(years)) %>% distinct() %>% 
  arrange(Patient.ID,abs(years)) %>%filter(row_number()==1) 
paired_df$Before_After = relevel(paired_df$Before_After,ref = "Before")

f = as.formula(paste0("Before_After ~ ",paste0(nutrition_vars,collapse = "+")))
p = paired(f,data = paired_df,id = Patient.ID)
summary(p,
        labelTranslations = list(VitaminA_Retinol = "Vitamin A Retinol",
                                 X25OH.Vitamin.D = "25OH-Vitamin D",
                                 Vitamin.E.Alpha = "FEV1 % Predicted",
                                 first_mod = "First Modulator"))
```

# Piecewise longitudinal models

```{r}
# Set up data again
df = read.csv("~/Dropbox/Work/CF/Edith Zemanick/CF Nutrition/Data_Cleaned/analysis_dataset.csv")
df$Age.at.Start..years. = NULL
# New age at start
mods = read_excel("~/Dropbox/Work/CF/Edith Zemanick/CF Nutrition/Data_Raw/Report CFTR Modulators_throughDecember2021.xlsx")
mods = mods[mods$Modulator %in% c('Kalydeco','Trikafta'),]
colnames(mods) = make.names(colnames(mods))
mods = mods %>% select(Patient.ID,Modulator,Age.at.Start..years.) %>% 
  pivot_wider(id_cols = Patient.ID,names_from = Modulator,
              values_from = Age.at.Start..years.)
colnames(mods)[2:ncol(mods)] = paste0("age_at_start_",colnames(mods)[2:ncol(mods)])
# Age at first and second modulator
mods$age_first = pmin(mods$age_at_start_Trikafta,mods$age_at_start_Kalydeco,na.rm = T)
mods$age_second = pmax(mods$age_at_start_Trikafta,mods$age_at_start_Kalydeco)
# Merge back in
df = left_join(df,mods,by = "Patient.ID")
df = df %>% group_by(Patient.ID) %>% 
  fill(age_at_start_Trikafta,age_at_start_Kalydeco,.direction = "downup")
# Time relative to first mod
df$time = df$Age.at.Test..Years. - df$age_first
# Calculate spline things
df$c1 = 
  (df$time-0)*(df$time>=0)
df$c2 = 
  (df$Age.at.Test..Years.-df$age_second)*(df$Age.at.Test..Years.>=df$age_second)
```

```{r}
piecewise_mod = function(outcome,data){
  data = data %>% select(Patient.ID,all_of(outcome),time,c1,c2) %>% drop_na()
  # Base plot
  plot = ggplot(data,aes_string(x = "time",y = outcome)) + 
    geom_point(alpha = 0.2) + geom_line(alpha = 0.2) +
    theme_bw() + theme(legend.position = "none") + xlab("Age at Test")
  # Model
  f = as.formula(paste0(outcome,"~ time + c1 + c2 + (1|Patient.ID)"))
  m = lmer(f,data = data)
  # Predicted values for plotting
  pred = predict(m)
  
  plot + geom_line(data=data, 
            aes(y = pred, x=Age.at.Test..Years.), size = 1, col="blue") 
  ggplotly(plot)
}
```

## Vitamin A

```{r}
mod_df = df %>% select(Patient.ID,VitaminA_Retinol,Age.at.Test..Years.,
                       age_first,age_second) %>% drop_na()
mod_df$c1 = 
  (mod_df$Age.at.Test..Years.-mod_df$age_first)*(mod_df$Age.at.Test..Years.>=mod_df$age_first)
mod_df$c2 = 
  (mod_df$Age.at.Test..Years.-mod_df$age_second)*(mod_df$Age.at.Test..Years.>=mod_df$age_second)

m = lmer(VitaminA_Retinol ~ c1+c2+(1|Patient.ID),data = mod_df)
```

```{r cache=TRUE}
mod_df = df %>% select(Patient.ID,time,VitaminA_Retinol) %>% drop_na()
model = list(
  VitaminA_Retinol ~ 1,  # Plateau in the first segment (int_1)
  1 + (1|Patient.ID) ~ 0 + time,    # Joined slope (time_2) at cp_1
  1 + (1|Patient.ID) ~ 0 + time     # Joined slope (int_3, time_3) at cp_2
)
fit = mcp(model, data = mod_df)
plot(fit) + theme_bw()
```

```{r eval=FALSE}
library(MultiKink)
data("triceps")
pred7 <- lm(triceps~ age + I((age-5)*(age>=5)) +
                                   I((age-10)*(age >= 10)),
                    data = triceps)
triceps$c1 = (triceps$age-5)*(triceps$age>=5)
triceps$c2 = (triceps$age-10)*(triceps$age>=10)

tri.age.plot <- ggplot(triceps, aes(x=age, y=triceps)) +
                 geom_point(alpha=0.55, color="black") + 
                 theme_minimal()
tri.age.plot +
  geom_line(data=triceps, 
            aes(y = pred7, x=age), size = 1, col="blue") 
```
