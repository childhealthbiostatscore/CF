---
title: "Serum Biomarkers of Nutrition Pre and Post CFTR Modulator Use in Children with Cystic Fibrosis"
author: "Tim Vigers"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(arsenal)
library(tidyverse)
library(readxl)
library(performance)
library(mcp)
library(lmerTest)
library(broom.mixed)
library(plotly)
library(knitr)
library(DiagrammeR)
library(lubridate)
knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "S:/PEDS/RI Biostatistics Core/Shared/Shared Projects/Vigers/CF"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Vigers/CF"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Vigers/CF"
}
knitr::opts_knit$set(root.dir = home_dir)
rm(home_dir)
source("~/GitHub/CF/get_genotype_class_severity.R")
```

```{r warning=FALSE}
# Vitamins
vit = read_excel("./Edith Zemanick/CF Nutrition/Data_Raw/Report Vitamins_throughDecember2021_revised20220712.xlsx")
vit$VitaminA_Retinol = as.numeric(vit$VitaminA_Retinol)
# Determine which modulator they were on
mods = read_excel("./Edith Zemanick/CF Nutrition/Data_Raw/Report CFTR Modulators_throughDecember2021.xlsx")
mods = mods %>% filter(Modulator %in% c('Kalydeco','Trikafta')) %>%
  select(`Patient ID`,Modulator,`Earliest Date in Registry`) %>% 
  pivot_wider(id_cols = `Patient ID`,names_from = Modulator,
              values_from = `Earliest Date in Registry`)
colnames(mods)[2:ncol(mods)] = paste0(colnames(mods)[2:ncol(mods)]," Date")
mods$`First Mod Date` = pmin(mods$`Trikafta Date`,mods$`Kalydeco Date`,na.rm = T)
mods$`Second Mod Date` = pmax(mods$`Trikafta Date`,mods$`Kalydeco Date`)
mods$`First Mod` = NA
mods$`First Mod`[mods$`First Mod Date` == mods$`Trikafta Date`] = "Trikafta"
mods$`First Mod`[mods$`First Mod Date` == mods$`Kalydeco Date`] = "Kalydeco"
# Add pancreatic status
pancreatic = read_excel("./CF Info/Sweat Tests from Internal Database_genotype class_withPancStatus.xlsx")
pancreatic = pancreatic %>% rename(`Patient ID` = PatientID) %>% select(`Patient ID`,PancreaticStatus)
# FEV1 and BMI
fev = read_excel("./Edith Zemanick/CF Nutrition/Data_Raw/Report_PFTs_ThroughDecember2021.xlsx")
fev = fev %>% select(PatientID,Sex,Date,`BMI percentile (CDC)`,`FEV1 % pred`) %>% rename(`Patient ID` = PatientID)
# Merge
df = full_join(vit,fev,by = c("Patient ID", "Date")) %>% filter(`Patient ID` %in% mods$`Patient ID`)
df = left_join(df,mods,by = "Patient ID")
df = left_join(df,pancreatic,by = "Patient ID")
```

# Participant Characteristics

```{r results='asis'}
# Import demo info and add
demo = before_after %>% group_by(`Patient ID`) %>% filter(row_number() == 1)
t1 = tableby(`First Mod` ~ Age + Sex + `Vitamin A` + `Vitamin D` + 
               `Vitamin E Alpha` + `Vitamin E Gamma` + BMI + `FEV1 % pred`,
             data = demo,
             control = tableby.control(numeric.stats=c("Nmiss", "median", "q1q3")))
summary(t1)
```

# Pre-Post Comparisons

Continuous variables were compared using a Wilcoxon signed rank test and categorical variables were compared using McNemarâ€™s test.

```{r results='asis'}
t2 = paired(Before_After ~ `Vitamin A` + `Vitamin D` + 
               `Vitamin E Alpha` + `Vitamin E Gamma` + BMI + `FEV1 % pred`,
             data = before_after, id = `Patient ID`, 
            numeric.test = "signed.rank",signed.rank.exact = FALSE,
            control = paired.control(numeric.stats=c("Nmiss", "median", "q1q3")))
summary(t2)
```

<!-- # Piecewise longitudinal models -->

<!-- ```{r} -->
<!-- # Time relative to first mod -->
<!-- df$time = as.numeric(difftime(df$Date,df$`First Mod Date`,units = "days"))/365.25 -->
<!-- # Calculate spline things -->
<!-- df$c1 = -->
<!--   (df$time-0)*(df$time>=0) -->
<!-- df$c2 = -->
<!--   (as.numeric(difftime(df$Date,df$`Second Mod Date`,units = "days"))/365.25)*(df$Date >= df$`Second Mod Date`) -->
<!-- # Limit to 3 years prior -->
<!-- df = df %>% filter(!is.na(time) & time >= -3) %>% distinct() -->
<!-- ``` -->

<!-- ```{r} -->
<!-- piecewise_mod = function(outcome,data,diagnostics = F){ -->
<!--   data$`Patient ID` = as.factor(data$`Patient ID`) -->
<!--   data = data %>% select(`Patient ID`,Date,`First Mod Date`,`Second Mod Date`,PancreaticStatus,BMI, -->
<!--                          all_of(outcome)) %>% drop_na(all_of(outcome)) -->
<!--   # Separate data for single and double mods -->
<!--   single = data %>% filter(c2 <= 0 | is.na(c2)) -->
<!--   double = data %>% filter(!is.na(c2)) -->
<!--   # Models -->
<!--   f_single = as.formula(paste0(outcome,"~ BMI + PancreaticStatus + time + c1 + (1|`Patient ID`)")) -->
<!--   f_double = as.formula(paste0(outcome,"~ BMI + PancreaticStatus + time + c1 +c2 + (1|`Patient ID`)")) -->
<!--   if(outcome == "BMI"){ -->
<!--     f_single = update(f_single,.~.-BMI) -->
<!--     f_double = update(f_double,.~.-BMI) -->
<!--   } -->
<!--   m_single = lmer(f_single,data = single) -->
<!--   m_double = lmer(f_double,data = double) -->
<!--   # Diagnostics if required -->
<!--   if(diagnostics){ -->
<!--     check_single = check_model(m_single) -->
<!--     check_double = check_model(m_double) -->
<!--   } else { -->
<!--     check_single = NULL -->
<!--     check_double = NULL -->
<!--   } -->
<!--   # Results -->
<!--   res_single = tidy(m_single,"fixed") -->
<!--   res_double = tidy(m_double,"fixed") -->
<!--   # Plots -->
<!--   single_plot_df = m_single@frame -->
<!--   single_plot_df$pred = predict(m_single) -->
<!--   single_plot = ggplot(single_plot_df,aes_string(x = "time",y = outcome,color = "`Patient ID`")) + -->
<!--     geom_line(aes(y = pred)) + -->
<!--     theme_bw() + theme(legend.position = "none") + xlab("Time (years)") -->
<!--   double_plot_df = m_double@frame -->
<!--   double_plot_df$pred = predict(m_double) -->
<!--   double_plot = ggplot(double_plot_df,aes_string(x = "time",y = outcome,color = "`Patient ID`")) + -->
<!--     geom_line(aes(y = pred)) + -->
<!--     theme_bw() + theme(legend.position = "none") + xlab("Time (years)") -->
<!--   # Return -->
<!--   return(list("results_single" = res_single,"results_double" = res_double, -->
<!--               "diagnostics_single" = check_single,"diagnostics_double" = check_double, -->
<!--               "plot_single" = single_plot,"plot_double" = double_plot)) -->
<!-- } -->
<!-- ``` -->

<!-- In the following models, the "time" estimate represents the slope prior to first modulator start, "c1" is the change in slope after first modulator start, and "c2" is the change in slope from first modulator to second. All models were adjusted for BMI and pancreatic status (except the BMI model, which was only adjusted for pancreatic status). -->

<!-- ## Vitamin A -->

<!-- ```{r} -->
<!-- vita = piecewise_mod(outcome = "VitaminA_Retinol",data = df,diagnostics = T) -->
<!-- ``` -->

<!-- ### Single modulator -->

<!-- ```{r results='asis'} -->
<!-- vita$plot_single -->
<!-- kable(vita$results_single,digits = 3) -->
<!-- ``` -->

<!-- ### Double modulator -->

<!-- ```{r results='asis'} -->
<!-- vita$plot_double -->
<!-- kable(vita$results_double,digits = 3) -->
<!-- ``` -->

<!-- ## BMI -->

<!-- ```{r} -->
<!-- bmi = piecewise_mod(outcome = "BMI",data = df,diagnostics = T) -->
<!-- ``` -->

<!-- ### Single modulator -->

<!-- ```{r results='asis'} -->
<!-- bmi$plot_single -->
<!-- kable(bmi$results_single,digits = 3) -->
<!-- ``` -->

<!-- ### Double modulator -->

<!-- ```{r results='asis'} -->
<!-- bmi$plot_double -->
<!-- kable(bmi$results_double,digits = 3) -->
<!-- ``` -->

<!-- # Bayesian? -->

<!-- ## BMI -->

<!-- ```{r cache=TRUE,echo=TRUE} -->
<!-- mod_df = df %>% filter(!is.na(age_second)) %>% select(Patient.ID,time,BMI) %>% drop_na() -->
<!-- model = list( -->
<!--   BMI ~ 1, # Plateau -->
<!--   1 + (1|Patient.ID) ~ 0 + time, # Joined slope -->
<!--   1 + (1|Patient.ID) ~ 0 + time, # Joined slope -->
<!--   1 + (1|Patient.ID) ~ 0 + time # Joined slope -->
<!-- ) -->
<!-- fit = mcp(model, data = mod_df,sample = "both") -->
<!-- ``` -->

<!-- ### Posterior means -->

<!-- ```{r} -->
<!-- summary(fit) -->
<!-- ``` -->

<!-- ### Posterior fit -->

<!-- ```{r} -->
<!-- plot(fit,q_fit = TRUE) + theme_bw() -->
<!-- ``` -->

<!-- ### Parameter plot -->

<!-- ```{r} -->
<!-- plot_pars(fit) -->
<!-- ``` -->

<!-- ### Hypothesis tests -->

<!-- ```{r} -->
<!-- hypothesis(fit,c("cp_1 = 0","cp_2 = 0","cp_3 = 0")) -->
<!-- ``` -->

<!-- t -->