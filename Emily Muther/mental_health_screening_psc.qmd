---
title: "Mental Health Screening in CF - PSC Screening"
author: "Tim Vigers"
date: "today"
date-format: long
format:
  html:
    toc: true
    toc-depth: 5
    toc-float: true
    code-fold: true
    self-contained: true
    fig-cap-location: top
    page-layout: full
editor: source
---

```{r setup}
#| include: false
library(tidyverse)
library(gtsummary)
library(ggcorrplot)
home_dir <- switch(Sys.info()["sysname"],
  "Darwin" = "/Users/timvigers/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Vigers/CF",
  "Windows" = "C:/Users/timvigers/OneDrive - The University of Colorado Denver/Vigers/CF"
)
knitr::opts_knit$set(root.dir = home_dir)
```

```{r data cleaning}
#| warning: false
# Import
df <- read.csv("./Emily Muther/General - Muther Research Group/Mental Health Screening/Data_Raw/PSC_Full_Data_data_11-11-22.csv",
  check.names = F, na.strings = ""
)
# Remove duplicate rows
df <- df %>% distinct()
# Sort by ID and contact date
df$CONTACT_DATE <- lubridate::mdy(df$CONTACT_DATE)
df <- df %>% arrange(PAT_MRN_ID, CONTACT_DATE)
# Exclude those with no PSC data
df <- df %>% filter(!is.na(Score))
```

# Data cleaning

1. Duplicate rows were removed (n=21).
2. All rows with missing data for `Score` were excluded (n=2319).
3. In Table 1, demographics and first contact date are reported.

# Demographics

```{r table 1}
cat_demo_vars <- c(
  "DEPARTMENT_NAME", "ENC_T", "PAYOR_NAME"
)
cont_demo_vars <- c("AGE AT CONTACT")
df %>%
  group_by(PAT_MRN_ID) %>%
  summarise(
    across(all_of(cont_demo_vars), ~ first(na.omit(.x))),
    across(all_of(cat_demo_vars), ~ first(na.omit(.x)))
  ) %>%
  select(-PAT_MRN_ID) %>%
  tbl_summary(missing_text = "Missing", label = list("Age at First Contact" = "AGE AT CONTACT"))
```

# Prevalence of behavioral health difficulties

## All PSC screeners

```{r table 2}
df %>%
  select(
    `Internalizing subscale`:`Externalizing subscale`, Score,
    `PSC Attention`:`PSC Totals`
  ) %>%
  tbl_summary(
    missing_text = "Missing",
    type = list(`Internalizing subscale` ~ "continuous")
  )
```

## By person

The maximum score on each subscale was calculated for all participants.

```{r}
#| warning: false
df %>%
  mutate(across(`PSC Attention`:`PSC Totals`, ~ factor(.x, ordered = T))) %>%
  group_by(PAT_MRN_ID) %>%
  summarise(across(c(
    `Internalizing subscale`:`Externalizing subscale`, Score,
    `PSC Attention`:`PSC Totals`
  ), ~ max(.x, na.rm = T))) %>%
  mutate(across(
    c(`Internalizing subscale`:`Externalizing subscale`, Score),
    ~ case_when(.x == -Inf ~ NA, .default = .x)
  )) %>%
  select(-PAT_MRN_ID) %>%
  tbl_summary(
    missing_text = "Missing",
    type = list(`Internalizing subscale` ~ "continuous")
  )
```

# Correlations

```{r}
X = df %>% 
```
