---
title: "Pre-/Post-Trikafta (Prospective)"
author: "Tim Vigers"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(arsenal)
library(tidyverse)
library(performance)
library(AGD)
library(pracma)
library(knitr)
knitr::opts_chunk$set(echo = FALSE,warning = TRUE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "S:/PEDS/RI Biostatistics Core/Shared/Shared Projects/Vigers/CF"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Vigers/CF"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Vigers/CF"
}
knitr::opts_knit$set(root.dir = home_dir)
rm(home_dir)
```

```{r}
# Import
df = read.csv("./Christine Chan/Pre-post Trikafta Prospective/Data_Cleaned/trikafta_2022-02-8.csv",
              na.strings = c(""))
# Clean up
df$Sex = factor(df$Sex..Male.1.)
levels(df$Sex) = c("F","M")
df = df %>% group_by(Study.ID) %>% 
  mutate(trikafta_duration = sum(Time.on.trikafta.in.months)) %>% ungroup()
df[,c("Kalydeco","Orkambi","Symdeko")] = 
  lapply(df[,c("Kalydeco.1","orkambi.1","tezacaftor.ivacaftor..symdeko..1")],function(c){
    c = as.factor(c)
    levels(c) = c("No","Yes")
    return(c)
  })
# Genotype
df$Genotype = apply(df,1,function(r){
  if(tolower(r["CFTR.Mutation.1"]) == "f508del" & tolower(r["CFTR.Mutation.2"]) == "f508del"){
    g = "Homozygous F508del"
  } else if (tolower(r["CFTR.Mutation.1"]) == "f508del"){
    g = "Heterozygous F508del"
  } else {
    g = "Other"
  }
  return(g)
})
# BMI z score (count everyone over 20 as 20)
df$Age = ifelse(df$Age.at.visit. >= 20, 20, df$Age.at.visit.)
df$BMIz = y2z(df$BMI,x = df$Age,sex = df$Sex,ref=nl4.bmi)
```

# Table 1: Demographics at Baseline

For calculating BMI z scores for adults > 20, we used CDC references for 20 year olds.

```{r results='asis'}
t1 = tableby(~Age.at.visit.+Sex..Male.1.+BMIz+FEV1..+FVC....+trikafta_duration+
               Genotype+Pancreatic.Status+Kalydeco+Orkambi+Symdeko,
             data = df[df$Event.Name == "Visit 1",])
newlabels = list(Age.at.visit. = "Age (years)",Sex..Male.1. = "Sex",
                 BMIz = "BMI z score",FEV1.. = "ppFEV1",FVC.... = "ppFVC",
                 trikafta_duration = "Duration on Trikafta (months) at Visit 2",
                 Pancreatic.Status = "Pancreatic Status")
summary(t1,digits = 2,labelTranslations = newlabels)
```

# Table 2: Pre-/Post-Trikafta Comparisons

All metrics calculated based on 2 hour 

```{r}
# convert Insulin to mcU/mL
ins_cols = colnames(df)[grep("insulin",tolower(colnames(df)))]
df[,ins_cols] = lapply(df[,ins_cols], function(c){
  return(as.numeric(c) * 0.02869)
})
# cpeptide to pmol/L
cpep_cols = colnames(df)[grep("c.peptide",tolower(colnames(df)))]
df[,cpep_cols] = lapply(df[,cpep_cols], function(c){
  c = as.numeric(c)/1000
  return(c * 0.33)
})
# Calculate AUCs
df$`Glucose AUC` = apply(df %>% select(Glucose.0.minute:Glucose.120.min),1,function(r){
  trapz(c(0,10,30,60,90,120),as.numeric(r))
})
df$`C Peptide AUC` = apply(df %>% select(c.peptide.0.minute:c.peptide.120.min),1,function(r){
  trapz(c(0,10,30,60,90,120),as.numeric(r))
})
# Other indices
# Cpeptide index = delta cpeptide 0-30/delta glucose 0-30
df$`C Peptide Index` = (df$c.peptide.30.min - df$c.peptide.0.minute)/
  (df$Glucose.30.min - df$Glucose.0.minute)
# Add labels
newlabels["A1C.result"] = "HbA1c (%)"
p <- paired(Event.Name ~ A1C.result+BMIz+FEV1..+FVC....+
              `Glucose AUC`+`C Peptide AUC`+`C Peptide Index`, 
            data = df, id = Study.ID)
summary(p,pfootnote = T,labelTranslations = newlabels)
```
