---
title: "CF Registry Analysis - ROC"
author: "Tim Vigers"
date: "today"
date-format: long
format:
  html:
    toc: true
    toc-depth: 5
    toc-float: true
    code-fold: true
    self-contained: true
    fig-cap-location: top
    fig-width: 8
    fig-height: 8
    page-layout: full
bibliography: /Users/timvigers/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Miscellaneous/zotero.bib
csl: /Users/timvigers/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Miscellaneous/american-medical-association.csl
editor: source
---

```{r setup}
#| include: false
library(tidyverse)
library(gtsummary)
library(gt)
library(pROC)
switch(Sys.info()[["sysname"]],
  Windows = {
    home_dir <- "C:/Users/Tim/OneDrive - The University of Colorado Denver/Vigers/CF/Christine Chan/CF Registry"
  },
  Darwin = {
    home_dir <- "/Users/timvigers/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Vigers/CF/Christine Chan/CF Registry"
  }
)
knitr::opts_knit$set(root.dir = home_dir)
```

```{r data cleaning}
# Import data
encounter <- read.csv("./Data_Raw/CFF19_encountersMerged_Del1.csv",
  na.strings = c("", "N/A")
)
# Limit to those with two hour OGTT and HbA1c at the same encounter
roc_df <- encounter %>%
  select(eDWID, reviewyear, encounternum, twohour_bloodglucose, hgba1c) %>%
  drop_na() %>%
  arrange(eDWID, reviewyear, encounternum) %>%
  group_by(eDWID) %>%
  filter(row_number() == n()) %>%
  ungroup() %>%
  mutate(`OGTT 2-hour` = cut(twohour_bloodglucose,
    breaks = c(-Inf, 140, 200, Inf), labels = c("<140", "[140,200)", ">=200")
  ))
# Demographic data
demo <- read.csv("./Data_Raw/CFF19_DemogCFDiag_Del1.csv",
  na.strings = c("", "N/A")
)
# Race
races <- c(
  "White", "Black or African American", "American Indian or Alaska Native",
  "Asian", "Native Hawaiian or Other Pacific Islander", "Some other race"
)
demo$Race <- apply(demo, 1, function(r) {
  w <- which(r[paste0("Race", 1:6)] == 1)
  if (length(w) == 0) {
    "Unknown"
  } else if (length(w) > 1) {
    "More than one race"
  } else {
    races[w]
  }
})
demo$Race <- factor(demo$Race,
  levels = c(
    "White", "Black or African American", "American Indian or Alaska Native",
    "Asian", "More than one race", "Native Hawaiian or Other Pacific Islander",
    "Some other race"
  ),
  labels = c(
    "White", "Black or African American", "Other race", "Other race",
    "More than one race", "Other race", "Other race"
  )
)
demo$Hispanicrace <- factor(demo$Hispanicrace,
  levels = 1:2,
  labels = c("Yes", "No")
)
# F508
demo$F508 <- factor(demo$F508,
  levels = 1:3,
  labels = c("F508del/F508del", "F508del/Other", "Other/Other")
)
# Age at year end
annual <- read.csv("./Data_Raw/CFF19_Annualized_Del1.csv",
  na.strings = c("", "N/A")
)
annual <- annual %>% rename(reviewyear = ReviewYear)
# Merge
roc_df <- left_join(roc_df,
  demo %>% select(eDWID, Race, Hispanicrace, Gender, F508, MutClass),
  by = join_by(eDWID)
)
roc_df <- left_join(roc_df,
  annual %>% select(eDWID, reviewyear, Age_YrEnd),
  by = join_by(eDWID, reviewyear)
)
```

# Participant Characteristics

## By two hour OGTT value

```{r}
roc_df %>%
  select(
    reviewyear, Age_YrEnd, hgba1c, `OGTT 2-hour`, Race, Hispanicrace, Gender,
    F508, MutClass
  ) %>%
  tbl_summary(
    by = `OGTT 2-hour`, missing_text = "Missing",
    type = list(reviewyear ~ "categorical"),
    label = list(
      hgba1c = "HbA1c", Hispanicrace = "Hispanic", MutClass = "Mutation Class",
      reviewyear = "Year", Age_YrEnd = "Age at Year End"
    )
  ) %>%
  add_overall() %>%
  add_p(
    test = list(reviewyear = "fisher.test"),
    test.args = all_tests("fisher.test") ~ list(simulate.p.value = T)
  ) %>%
  separate_p_footnotes() %>%
  as_gt()
```

## By age

```{r}
roc_df %>%
  select(
    reviewyear, Age_YrEnd, hgba1c, `OGTT 2-hour`, Race, Hispanicrace, Gender,
    F508, MutClass
  ) %>%
  tbl_summary(
    by = Age_YrEnd, missing_text = "Missing",
    type = list(reviewyear ~ "categorical"),
    label = list(
      hgba1c = "HbA1c", Hispanicrace = "Hispanic", MutClass = "Mutation Class",
      reviewyear = "Year", Age_YrEnd = "Age at Year End"
    )
  ) %>%
  add_overall() %>%
  add_p(
    test = list(reviewyear = "fisher.test"),
    test.args = all_tests("fisher.test") ~ list(simulate.p.value = T)
  ) %>%
  separate_p_footnotes() %>%
  as_gt()
```

# HbA1c by diagnosis

```{r}
ggplot(roc_df, aes(x = `OGTT 2-hour`, y = hgba1c)) +
  geom_boxplot() +
  ylab("HbA1c") +
  theme_classic()
```

# ROC analysis

For the following analyses, we considered those with a two hour glucose value >= 140 and < 200 as a distinct group (AGT) and use receiver operating characteristic curves to find cutoffs that predict: 

1. NGT vs. AGT

2. AGT vs. CFRD

```{r}
ngt_agt <- roc_df %>% filter(`OGTT 2-hour` != ">=200")
ngt_agt$ogtt <- droplevels(ngt_agt$`OGTT 2-hour`)
agt_cfrd <- roc_df %>% filter(`OGTT 2-hour` != "<140")
agt_cfrd$ogtt <- droplevels(agt_cfrd$`OGTT 2-hour`)
```

## Peds and adults

### NGT vs. AGT

```{r}
#| message: false
r <- roc(ogtt ~ hgba1c, data = ngt_agt)
thresh <- coords(r, "best", best.method = "youden")
plot(r, print.auc = T, print.thres = T)
gt(coords(r)) %>% fmt_number(decimals = 3)
summary(r)
```

#### AGT vs. CFRD

```{r}
#| message: false
r <- roc(ogtt ~ hgba1c, data = agt_cfrd)
thresh <- coords(r, "best", best.method = "youden")
plot(r, print.auc = T, print.thres = T)
gt(coords(r)) %>% fmt_number(decimals = 3)
summary(r)
```

## Peds

```{r}
peds_ngt_agt <- ngt_agt %>% filter(Age_YrEnd < 18)
peds_agt_cfrd <- agt_cfrd %>% filter(Age_YrEnd < 18)
```

### NGT vs. AGT

```{r}
#| message: false
r <- roc(ogtt ~ hgba1c, data = peds_ngt_agt)
thresh <- coords(r, "best", best.method = "youden")
plot(r, print.auc = T, print.thres = T)
gt(coords(r)) %>% fmt_number(decimals = 3)
summary(r)
```

#### AGT vs. CFRD

```{r}
#| message: false
r <- roc(ogtt ~ hgba1c, data = peds_agt_cfrd)
thresh <- coords(r, "best", best.method = "youden")
plot(r, print.auc = T, print.thres = T)
gt(coords(r)) %>% fmt_number(decimals = 3)
summary(r)
```

### Adults

```{r}
adult_ngt_agt <- ngt_agt %>% filter(Age_YrEnd >= 18)
adult_agt_cfrd <- agt_cfrd %>% filter(Age_YrEnd >= 18)
```

### NGT vs. AGT

```{r}
#| message: false
r <- roc(ogtt ~ hgba1c, data = adult_ngt_agt)
thresh <- coords(r, "best", best.method = "youden")
plot(r, print.auc = T, print.thres = T)
gt(coords(r)) %>% fmt_number(decimals = 3)
summary(r)
```

#### AGT vs. CFRD

```{r}
#| message: false
r <- roc(ogtt ~ hgba1c, data = adult_agt_cfrd)
thresh <- coords(r, "best", best.method = "youden")
plot(r, print.auc = T, print.thres = T)
gt(coords(r)) %>% fmt_number(decimals = 3)
summary(r)
```
