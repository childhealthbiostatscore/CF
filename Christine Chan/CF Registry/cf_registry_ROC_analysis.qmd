---
title: "CF Registry Analysis - ROC"
author: "Tim Vigers"
date: "today"
date-format: long
format:
  html:
    toc: true
    toc-depth: 5
    toc-float: true
    code-fold: true
    self-contained: true
    fig-cap-location: top
    fig-width: 12
    fig-height: 9
    page-layout: full
editor: source
---

```{r setup}
#| include: false
library(ggplot2)
library(gtsummary)
library(gt)
library(pROC)
library(ggrepel)
library(childsds)
library(labelled)
library(Hmisc)
library(lmerTest)
library(multcomp)
library(tidyverse)
home_dir <- switch(
  Sys.info()["sysname"],
  "Darwin" = "/Users/tim/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Vigers/CF/Christine Chan/CF Registry",
  "Windows" = "C:/Users/tim/OneDrive - The University of Colorado Denver/Vigers/CF/Christine Chan/CF Registry",
  "Linux" = "/home/tim/OneDrive/Vigers/CF/Christine Chan/CF Registry"
)
github_dir <- switch(
  Sys.info()["sysname"],
  "Darwin" = "/Users/timvigers/GitHub",
  "Windows" = "C:/Users/Tim/GitHub",
  "Linux" = "/home/tim/GitHub"
)
knitr::opts_knit$set(root.dir = home_dir)
set.seed(1017)
```

```{r data cleaning}
setwd(home_dir)
# Import data
encounter <- read.csv(
  "./Data_Raw/CFF19_encountersMerged_Del1.csv",
  na.strings = c("", "N/A")
)
# Demographic data
demo <- read.csv(
  "./Data_Raw/CFF19_DemogCFDiag_Del1.csv",
  na.strings = c("", "N/A")
)
# Race
races <- c(
  "White",
  "Black or African American",
  "American Indian or Alaska Native",
  "Asian",
  "Native Hawaiian or Other Pacific Islander",
  "Some other race"
)
demo$Race <- apply(demo, 1, function(r) {
  w <- which(r[paste0("Race", 1:6)] == 1)
  if (length(w) == 0) {
    "Unknown"
  } else if (length(w) > 1) {
    "More than one race"
  } else {
    races[w]
  }
})
demo$Race <- factor(
  demo$Race,
  levels = c(
    "White",
    "Black or African American",
    "American Indian or Alaska Native",
    "Asian",
    "More than one race",
    "Native Hawaiian or Other Pacific Islander",
    "Some other race"
  ),
  labels = c(
    "White",
    "Black or African American",
    "Other race",
    "Other race",
    "More than one race",
    "Other race",
    "Other race"
  )
)
demo$Hispanicrace <- factor(
  demo$Hispanicrace,
  levels = 1:2,
  labels = c("Yes", "No")
)
# F508
demo$F508 <- factor(
  demo$F508,
  levels = 1:3,
  labels = c("F508del/F508del", "F508del/Other", "Other/Other")
)
# Age at year end
annual <- read.csv(
  "./Data_Raw/CFF19_Annualized_Del1.csv",
  na.strings = c("", "N/A")
)
annual <- annual |> rename(reviewyear = ReviewYear)
annual <- left_join(annual, demo |> select(eDWID, Gender), by = join_by(eDWID))
# Merge
encounter <- left_join(
  encounter,
  demo |> select(eDWID, Race, Hispanicrace, Gender, F508, MutClass),
  by = join_by(eDWID)
)
encounter <- left_join(
  encounter,
  annual |>
    select(
      eDWID,
      reviewyear,
      Age_YrEnd,
      A_IsOnEnzymes,
      A_FEV1_pct_predicted,
      A_FVC_pct_predicted
    ),
  by = join_by(eDWID, reviewyear)
)
# Format CFTR modulator variables
encounter$Vx770[is.na(encounter$Vx770)] <- 0
encounter$Vx770 <- factor(
  encounter$Vx770,
  levels = 0:1,
  labels = c("No", "Yes")
)
encounter$Vx809comb[is.na(encounter$Vx809comb)] <- 0
encounter$Vx809comb <- factor(
  encounter$Vx809comb,
  levels = 0:1,
  labels = c("No", "Yes")
)
# Limit to those with two hour OGTT and HbA1c at the same encounter
# Also remove years before 2010 and those under age 10
roc_df <- encounter |>
  arrange(eDWID, reviewyear, encounternum) |>
  select(
    eDWID,
    reviewyear,
    Age_YrEnd,
    Race,
    Hispanicrace,
    Gender,
    F508,
    MutClass,
    A_IsOnEnzymes,
    Vx770,
    Vx809comb,
    height,
    weight,
    A_FEV1_pct_predicted,
    A_FVC_pct_predicted,
    hgba1c,
    fast_bloodglucose,
    twohour_bloodglucose
  ) |>
  filter(
    reviewyear >= 2010,
    Age_YrEnd >= 10,
    hgba1c >= 3.5 & hgba1c <= 15
  ) |>
  drop_na(
    eDWID,
    reviewyear,
    Age_YrEnd,
    Race,
    Hispanicrace,
    Gender,
    F508,
    MutClass,
    twohour_bloodglucose,
    hgba1c
  ) |>
  group_by(eDWID) |>
  filter(row_number() == n()) |>
  ungroup() |>
  mutate(
    `OGTT 2-hour` = cut(
      twohour_bloodglucose,
      breaks = c(-Inf, 140, 200, Inf),
      labels = c("<140", "[140,200)", ">=200")
    ),
    `Age Group` = cut(Age_YrEnd, breaks = c(10, 18, 30, Inf), right = F)
  )
# Calculate BMI percentiles
roc_df$bmi = roc_df$weight / ((roc_df$height / 100)^2)
roc_df$bmi_perc = sds(
  value = roc_df$bmi,
  age = roc_df$Age_YrEnd,
  sex = roc_df$Gender,
  item = "bmi",
  type = "perc",
  male = "M",
  female = "F",
  ref = cdc.ref
) *
  100
# Get BMI group
roc_df$bmi_cat <- apply(roc_df, 1, function(r) {
  age <- as.numeric(r["Age_YrEnd"])
  gender <- as.character(r["Gender"])
  bmi <- as.numeric(r["bmi"])
  bmi_perc <- as.numeric(r["bmi_perc"])
  if (age <= 20) {
    return(cut(
      bmi_perc,
      c(-Inf, 10, 50, 85, Inf),
      right = F,
      labels = c("Undernourished", "At Risk", "Target/Goal", "Overweight")
    ))
  } else if (age > 20) {
    if (gender == "M") {
      return(cut(
        bmi,
        c(-Inf, 18.5, 23, 25, Inf),
        right = F,
        labels = c(
          "Undernourished",
          "At Risk",
          "Target/Goal",
          "Overweight"
        )
      ))
    } else if (gender == "F") {
      return(cut(
        bmi,
        c(-Inf, 18.5, 22, 25, Inf),
        right = F,
        labels = c(
          "Undernourished",
          "At Risk",
          "Target/Goal",
          "Overweight"
        )
      ))
    }
  }
})
roc_df$bmi_cat <- relevel(roc_df$bmi_cat, ref = "Target/Goal")
# Raw values for adults, percentiles for peds
roc_df$bmi_adult = roc_df$bmi
roc_df$bmi_adult[roc_df$Age_YrEnd <= 20] = NA
roc_df$bmi_perc = roc_df$bmi_perc
roc_df$bmi_perc[roc_df$Age_YrEnd > 20] = NA
# Labels
var_label(roc_df$bmi) = "BMI (all participants)"
var_label(roc_df$bmi_perc) = "BMI percentile (age <= 20)"
var_label(roc_df$bmi_adult) = "BMI value (age > 20)"
var_label(roc_df$bmi_cat) = "BMI category"
```

```{r}
# Plotting function
roc_plot <- function(roc_obj) {
  a <- ci.auc(roc_obj)
  a <- round(as.numeric(a[1:3]), 2)
  c <- coords(roc_obj, "best")
  mod_df <- coords(roc_obj)
  mod_df$one_m_spec = 1 - mod_df$specificity
  point_df <- mod_df[mod_df$threshold == as.numeric(c[1]), ]
  c <- round(as.numeric(c), 2)
  point_label <- paste0(
    "Threshold: ",
    c[1],
    "\n",
    "Specificity: ",
    c[2],
    "\n",
    "Sensitivity: ",
    c[3],
    "\n",
    "AUC: ",
    a[2],
    " (95%CI: ",
    a[1],
    ", ",
    a[3],
    ")"
  )
  p <- ggplot(mod_df, aes(x = one_m_spec, y = sensitivity)) +
    geom_line() +
    geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
    geom_point(data = point_df) +
    geom_label_repel(
      data = point_df,
      aes(label = point_label),
      nudge_x = 0.5,
      nudge_y = -0.5,
      segment.color = "grey50",
      size = 5
    ) +
    xlab("1-Specificity") +
    ylab("Sensitivity") +
    theme_bw(base_size = 20)
  return(p)
}
```

# Data cleaning

1. People who reported American Indian or Alaska Native, Asian, and Native Hawaiian or Other Pacific Islander for race were considered as "Other race" due to relatively small sample sizes for these groups.

2. Years prior to 2010 and those under age 10 at the end of a given year were excluded from the analysis.

3. HbA1cs < 3.5% or > 15% were excluded from the analysis, as these values were assumed to be entered incorrectly.

# Participant Characteristics

## By two hour OGTT value

```{r}
roc_df |>
  select(-eDWID) |>
  tbl_summary(
    by = `OGTT 2-hour`,
    missing_text = "Missing",
    type = list(
      reviewyear ~ "categorical",
      all_continuous() ~ "continuous2"
    ),
    statistic = list(
      all_continuous() ~
        c("{mean} ({sd})", "{median} ({p25}, {p75})", "{min}, {max}")
    ),
    label = list(
      hgba1c = "HbA1c",
      Hispanicrace = "Hispanic",
      MutClass = "Mutation Class",
      reviewyear = "Year",
      Age_YrEnd = "Age at Year End"
    )
  ) |>
  add_overall() |>
  add_p(
    test = list(reviewyear = "fisher.test"),
    test.args = all_tests("fisher.test") ~ list(simulate.p.value = T)
  ) |>
  separate_p_footnotes() |>
  as_gt()
```

### Pairwise comparisons

#### <140 vs. [140,200)

```{r}
roc_df |>
  select(`OGTT 2-hour`, Gender, MutClass, hgba1c) |>
  filter(`OGTT 2-hour` != ">=200") |>
  mutate(`OGTT 2-hour` = droplevels(`OGTT 2-hour`)) |>
  tbl_summary(
    by = `OGTT 2-hour`,
    missing_text = "Missing",
    type = list(all_continuous() ~ "continuous2"),
    statistic = list(
      all_continuous() ~
        c("{mean} ({sd})", "{median} ({p25}, {p75})", "{min}, {max}")
    ),
    label = list(
      hgba1c = "HbA1c",
      Hispanicrace = "Hispanic",
      MutClass = "Mutation Class",
      reviewyear = "Year",
      Age_YrEnd = "Age at Year End"
    )
  ) |>
  add_overall() |>
  add_p(
    test = list(reviewyear = "fisher.test"),
    test.args = all_tests("fisher.test") ~ list(simulate.p.value = T)
  ) |>
  separate_p_footnotes() |>
  as_gt()
```

#### [140,200) vs. >=200    

```{r}
roc_df |>
  select(`OGTT 2-hour`, Gender, MutClass, hgba1c) |>
  filter(`OGTT 2-hour` != "<140") |>
  mutate(`OGTT 2-hour` = droplevels(`OGTT 2-hour`)) |>
  tbl_summary(
    by = `OGTT 2-hour`,
    missing_text = "Missing",
    type = list(all_continuous() ~ "continuous2"),
    statistic = list(
      all_continuous() ~
        c("{mean} ({sd})", "{median} ({p25}, {p75})", "{min}, {max}")
    ),
    label = list(
      hgba1c = "HbA1c",
      Hispanicrace = "Hispanic",
      MutClass = "Mutation Class",
      reviewyear = "Year",
      Age_YrEnd = "Age at Year End"
    )
  ) |>
  add_overall() |>
  add_p(
    test = list(reviewyear = "fisher.test"),
    test.args = all_tests("fisher.test") ~ list(simulate.p.value = T)
  ) |>
  separate_p_footnotes() |>
  as_gt()
```

#### <140 vs. >=200

```{r}
roc_df |>
  select(`OGTT 2-hour`, Gender, MutClass, hgba1c) |>
  filter(`OGTT 2-hour` != "[140,200)") |>
  mutate(`OGTT 2-hour` = droplevels(`OGTT 2-hour`)) |>
  tbl_summary(
    by = `OGTT 2-hour`,
    missing_text = "Missing",
    type = list(all_continuous() ~ "continuous2"),
    statistic = list(
      all_continuous() ~
        c("{mean} ({sd})", "{median} ({p25}, {p75})", "{min}, {max}")
    ),
    label = list(
      hgba1c = "HbA1c",
      Hispanicrace = "Hispanic",
      MutClass = "Mutation Class",
      reviewyear = "Year",
      Age_YrEnd = "Age at Year End"
    )
  ) |>
  add_overall() |>
  add_p(
    test = list(reviewyear = "fisher.test"),
    test.args = all_tests("fisher.test") ~ list(simulate.p.value = T)
  ) |>
  separate_p_footnotes() |>
  as_gt()
```

## By age

```{r}
roc_df |>
  select(
    reviewyear,
    hgba1c,
    Age_YrEnd,
    `Age Group`,
    `OGTT 2-hour`,
    Race,
    Hispanicrace,
    Gender,
    F508,
    MutClass
  ) |>
  tbl_summary(
    by = `Age Group`,
    missing_text = "Missing",
    type = list(reviewyear ~ "categorical"),
    label = list(
      hgba1c = "HbA1c",
      Hispanicrace = "Hispanic",
      MutClass = "Mutation Class",
      reviewyear = "Year",
      Age_YrEnd = "Age at Year End"
    )
  ) |>
  add_overall() |>
  add_p(
    test = list(reviewyear = "fisher.test"),
    test.args = all_tests("fisher.test") ~ list(simulate.p.value = T)
  ) |>
  separate_p_footnotes() |>
  as_gt()
```

# HbA1c by diagnosis

## Boxplot

```{r}
ggplot(roc_df, aes(x = `OGTT 2-hour`, y = hgba1c)) +
  geom_boxplot() +
  geom_hline(yintercept = 5.3, linetype = "dashed") +
  geom_hline(yintercept = 5.5, linetype = "dashed") +
  geom_hline(yintercept = 5.7, linetype = "dashed") +
  ylab("HbA1c") +
  theme_classic(base_size = 20)
```

## Dotplot

```{r}
ggplot(roc_df, aes(x = `OGTT 2-hour`, y = hgba1c)) +
  geom_jitter(alpha = 0.05) +
  geom_hline(yintercept = 5.3, linetype = "dashed") +
  geom_hline(yintercept = 5.5, linetype = "dashed") +
  geom_hline(yintercept = 5.7, linetype = "dashed") +
  ylab("HbA1c") +
  theme_classic(base_size = 20)
```

## Violin plot

```{r}
ggplot(roc_df, aes(x = `OGTT 2-hour`, y = hgba1c)) +
  geom_violin(aes(fill = `OGTT 2-hour`)) +
  geom_hline(yintercept = 5.3, linetype = "dashed") +
  geom_hline(yintercept = 5.5, linetype = "dashed") +
  geom_hline(yintercept = 5.7, linetype = "dashed") +
  ylab("HbA1c") +
  theme_classic(base_size = 20) +
  theme(legend.position = "none")
```

# ROC analysis

For each ROC curve, we performed 2000 bootstrap replicates. Here the median best threshold (based on Youden index), sensitivity, and specificity are presented along with the bootstrapped 95% confidence intervals. Column names are printed in terms of percentiles, so `threshold.2.5.` indicates the lower limit of the confidence interval, `threshold.50.` indicates the median best threshold, and `threshold.97.5.` indicates the upper limit of the confidence interval. All non-bootstrapped thresholds are also reported.

## NGT vs. AGT and AGT vs. CFRD

For the following analyses, we considered those with a two hour glucose value >= 140 and < 200 as a distinct group (AGT) and use receiver operating characteristic curves to find cutoffs that predict: 

1. NGT vs. AGT

2. AGT vs. CFRD

```{r}
ngt_agt <- roc_df |> filter(`OGTT 2-hour` != ">=200")
ngt_agt$ogtt <- droplevels(ngt_agt$`OGTT 2-hour`)
agt_cfrd <- roc_df |> filter(`OGTT 2-hour` != "<140")
agt_cfrd$ogtt <- droplevels(agt_cfrd$`OGTT 2-hour`)
```

### Full cohort

#### NGT vs. AGT

```{r}
#| message: false
r <- roc(ogtt ~ hgba1c, data = ngt_agt)
roc_plot(r)
gt(data.frame(ci.coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

#### AGT vs. CFRD

```{r}
#| message: false
r <- roc(ogtt ~ hgba1c, data = agt_cfrd)
roc_plot(r)
gt(data.frame(ci.coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

### Peds vs. Adults

#### Peds

```{r}
peds_ngt_agt <- ngt_agt |> filter(Age_YrEnd < 18)
peds_agt_cfrd <- agt_cfrd |> filter(Age_YrEnd < 18)
```

##### NGT vs. AGT

```{r}
#| message: false
r <- roc(ogtt ~ hgba1c, data = peds_ngt_agt)
roc_plot(r)
gt(data.frame(ci.coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

##### AGT vs. CFRD

```{r}
#| message: false
r <- roc(ogtt ~ hgba1c, data = peds_agt_cfrd)
roc_plot(r)
gt(data.frame(ci.coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

#### Adults

```{r}
adult_ngt_agt <- ngt_agt |> filter(Age_YrEnd >= 18)
adult_agt_cfrd <- agt_cfrd |> filter(Age_YrEnd >= 18)
```

##### NGT vs. AGT

```{r}
#| message: false
r <- roc(ogtt ~ hgba1c, data = adult_ngt_agt)
roc_plot(r)
gt(data.frame(ci.coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

##### AGT vs. CFRD

```{r}
#| message: false
r <- roc(ogtt ~ hgba1c, data = adult_agt_cfrd)
roc_plot(r)
gt(data.frame(ci.coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

### By race

#### White

```{r}
white_ngt_agt <- ngt_agt |> filter(Race == "White")
white_agt_cfrd <- agt_cfrd |> filter(Race == "White")
```

##### NGT vs. AGT

```{r}
#| message: false
r <- roc(ogtt ~ hgba1c, data = white_ngt_agt)
roc_plot(r)
gt(data.frame(ci.coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

##### AGT vs. CFRD

```{r}
#| message: false
r <- roc(ogtt ~ hgba1c, data = white_agt_cfrd)
roc_plot(r)
gt(data.frame(ci.coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

#### Black or African American

```{r}
black_ngt_agt <- ngt_agt |> filter(Race == "Black or African American")
black_agt_cfrd <- agt_cfrd |> filter(Race == "Black or African American")
```

##### NGT vs. AGT

```{r}
#| message: false
r <- roc(ogtt ~ hgba1c, data = black_ngt_agt)
roc_plot(r)
gt(data.frame(ci.coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

##### AGT vs. CFRD

Bootstrap replicates found more than one "best" threshold, so the non-bootstrapped threshold is reported first, and a random bootstrapped "best" interval second.

```{r}
#| message: false
r <- roc(ogtt ~ hgba1c, data = black_agt_cfrd)
roc_plot(r)
gt(data.frame(coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(ci.coords(r, "best", best.policy = "random"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

#### More than one race

```{r}
more_ngt_agt <- ngt_agt |> filter(Race == "More than one race")
more_agt_cfrd <- agt_cfrd |> filter(Race == "More than one race")
```

##### NGT vs. AGT

Bootstrap replicates found more than one "best" threshold, so the non-bootstrapped threshold is reported first, and a random bootstrapped "best" interval second.

```{r}
#| message: false
r <- roc(ogtt ~ hgba1c, data = more_ngt_agt)
roc_plot(r)
gt(data.frame(coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(ci.coords(r, "best", best.policy = "random"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

##### AGT vs. CFRD

```{r}
#| message: false
r <- roc(ogtt ~ hgba1c, data = more_agt_cfrd)
roc_plot(r)
gt(data.frame(ci.coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

#### Other race

```{r}
other_ngt_agt <- ngt_agt |> filter(Race == "Other race")
other_agt_cfrd <- agt_cfrd |> filter(Race == "Other race")
```

##### NGT vs. AGT

Bootstrap replicates found more than one "best" threshold, so the non-bootstrapped threshold is reported first, and a random bootstrapped "best" interval second.

```{r}
#| message: false
r <- roc(ogtt ~ hgba1c, data = other_ngt_agt)
roc_plot(r)
gt(data.frame(coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(ci.coords(r, "best", best.policy = "random"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

##### AGT vs. CFRD

Bootstrap replicates found more than one "best" threshold, so the non-bootstrapped threshold is reported first, and a random bootstrapped "best" interval second.

```{r}
#| message: false
r <- roc(ogtt ~ hgba1c, data = other_agt_cfrd)
roc_plot(r)
gt(data.frame(coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(ci.coords(r, "best", best.policy = "random"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

### By ethnicity

#### Hispanic

```{r}
hispanic_ngt_agt <- ngt_agt |> filter(Hispanicrace == "Yes")
hispanic_agt_cfrd <- agt_cfrd |> filter(Hispanicrace == "No")
```

##### NGT vs. AGT

```{r}
#| message: false
r <- roc(ogtt ~ hgba1c, data = hispanic_ngt_agt)
roc_plot(r)
gt(data.frame(ci.coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

##### AGT vs. CFRD

```{r}
#| message: false
r <- roc(ogtt ~ hgba1c, data = hispanic_agt_cfrd)
roc_plot(r)
gt(data.frame(ci.coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

#### Non-Hispanic

```{r}
non_hispanic_ngt_agt <-
  ngt_agt |> filter(Race == "Black or African American")
non_hispanic_agt_cfrd <-
  agt_cfrd |> filter(Race == "Black or African American")
```

##### NGT vs. AGT

Bootstrap replicates found more than one "best" threshold, so the non-bootstrapped threshold is reported first, and a random bootstrapped "best" interval second.

```{r}
#| message: false
r <- roc(ogtt ~ hgba1c, data = non_hispanic_ngt_agt)
roc_plot(r)
gt(data.frame(coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(ci.coords(r, "best", best.policy = "random"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

##### AGT vs. CFRD

Bootstrap replicates found more than one "best" threshold, so the non-bootstrapped threshold is reported first, and a random bootstrapped "best" interval second.

```{r}
#| message: false
r <- roc(ogtt ~ hgba1c, data = non_hispanic_agt_cfrd)
roc_plot(r)
gt(data.frame(coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(ci.coords(r, "best", best.policy = "random"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

## Two hour OGTT >= 140 or >= 200

For the following analyses, we examined HbA1c cutoffs that best predict a two hour OGTT value either >= 140 or >= 200

```{r}
roc_df$agt <- as.numeric(roc_df$twohour_bloodglucose >= 140)
roc_df$cfrd <- as.numeric(roc_df$twohour_bloodglucose >= 200)
```

### Full cohort

#### $\geq$ 140

```{r}
#| message: false
r <- roc(agt ~ hgba1c, data = roc_df)
roc_plot(r)
gt(data.frame(ci.coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

#### $\geq$ 200

```{r}
#| message: false
r <- roc(cfrd ~ hgba1c, data = roc_df)
roc_plot(r)
gt(data.frame(ci.coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

### Peds vs. Adults

#### Peds

```{r}
peds_roc <- roc_df |> filter(Age_YrEnd < 18)
```

##### $\geq$ 140

```{r}
#| message: false
r <- roc(agt ~ hgba1c, data = peds_roc)
roc_plot(r)
gt(data.frame(ci.coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

##### $\geq$ 200

```{r}
#| message: false
r <- roc(cfrd ~ hgba1c, data = peds_roc)
roc_plot(r)
gt(data.frame(ci.coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

#### Adults

```{r}
adult_roc <- roc_df |> filter(Age_YrEnd >= 18)
```

##### $\geq$ 140

```{r}
#| message: false
r <- roc(agt ~ hgba1c, data = adult_roc)
roc_plot(r)
gt(data.frame(ci.coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

##### $\geq$ 200

```{r}
#| message: false
r <- roc(cfrd ~ hgba1c, data = adult_roc)
roc_plot(r)
gt(data.frame(ci.coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

### By race

#### White

```{r}
white_roc <- roc_df |> filter(Race == "White")
```

##### $\geq$ 140

```{r}
#| message: false
r <- roc(agt ~ hgba1c, data = white_roc)
roc_plot(r)
gt(data.frame(ci.coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

##### $\geq$ 200

```{r}
#| message: false
r <- roc(cfrd ~ hgba1c, data = white_roc)
roc_plot(r)
gt(data.frame(ci.coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

#### Black or African American

```{r}
black_roc <- roc_df |> filter(Race == "Black or African American")
```

##### $\geq$ 140

```{r}
#| message: false
r <- roc(agt ~ hgba1c, data = black_roc)
roc_plot(r)
gt(data.frame(ci.coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

##### $\geq$ 200

Bootstrap replicates found more than one "best" threshold, so the non-bootstrapped threshold is reported first, and a random bootstrapped "best" interval second.

```{r}
#| message: false
r <- roc(cfrd ~ hgba1c, data = black_roc)
roc_plot(r)
gt(data.frame(ci.coords(r, "best", best.policy = "random"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

#### More than one race

```{r}
more_roc <- roc_df |> filter(Race == "More than one race")
```

##### $\geq$ 140

```{r}
#| message: false
r <- roc(agt ~ hgba1c, data = more_roc)
roc_plot(r)
gt(data.frame(ci.coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

##### $\geq$ 200

```{r}
#| message: false
r <- roc(cfrd ~ hgba1c, data = more_roc)
roc_plot(r)
gt(data.frame(ci.coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

#### Other race

```{r}
other_roc <- roc_df |> filter(Race == "Other race")
```

##### $\geq$ 140

Bootstrap replicates found more than one "best" threshold, so the non-bootstrapped threshold is reported first, and a random bootstrapped "best" interval second.

```{r}
#| message: false
r <- roc(agt ~ hgba1c, data = other_roc)
roc_plot(r)
gt(data.frame(coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(ci.coords(r, "best", best.policy = "random"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

##### $\geq$ 200
Bootstrap replicates found more than one "best" threshold, so the non-bootstrapped threshold is reported first, and a random bootstrapped "best" interval second.

```{r}
#| message: false
r <- roc(cfrd ~ hgba1c, data = other_roc)
roc_plot(r)
gt(data.frame(coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(ci.coords(r, "best", best.policy = "random"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

### By ethnicity

#### Hispanic

```{r}
hispanic_roc <- roc_df |> filter(Hispanicrace == "Yes")
```

##### $\geq$ 140

```{r}
#| message: false
r <- roc(agt ~ hgba1c, data = hispanic_roc)
roc_plot(r)
gt(data.frame(ci.coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

##### $\geq$ 200

```{r}
#| message: false
r <- roc(cfrd ~ hgba1c, hispanic_roc)
roc_plot(r)
gt(data.frame(ci.coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

#### Non-Hispanic

```{r}
non_hispanic_roc <- roc_df |> filter(Hispanicrace == "No")
```

##### $\geq$ 140

```{r}
#| message: false
r <- roc(agt ~ hgba1c, data = non_hispanic_roc)
roc_plot(r)
gt(data.frame(ci.coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

##### $\geq$ 200

```{r}
#| message: false
r <- roc(cfrd ~ hgba1c, data = non_hispanic_roc)
roc_plot(r)
gt(data.frame(ci.coords(r, "best"))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
gt(data.frame(coords(
  r,
  "all",
  ret = c(
    "threshold",
    "sensitivity",
    "specificity",
    "tp",
    "tn",
    "fp",
    "fn",
    "npv",
    "ppv",
    "tnr",
    "fnr"
  )
))) |>
  fmt_number(decimals = 3, drop_trailing_zeros = T)
```

# Diagnosis comparisons for HbA1c registry paper

```{r}
#| warning: false
#| message: false
# Import data and codebook
annual <- read.csv(
  "./Data_Raw/CFF19_Annualized_Del1.csv",
  na.strings = c("", "N/A")
)
data_dict <- readxl::read_excel("./Data_Raw/Copy of Codes for CFFPR_2018.xlsx")
data_dict$var <- paste(data_dict$field_name, data_dict$code_value, sep = "_")
# Remove those with T1D or T2D
annual <- annual %>% arrange(eDWID, ReviewYear)
annual <- annual[!annual$cfrd_status_annual %in% c(4, 5), ]
annual$cfrd_status_annual <- factor(
  annual$cfrd_status_annual,
  levels = 1:3,
  labels = c("CFRD-", "CFRD-", "CFRD+")
)
# Get mutations
demogs <- read.csv("./Data_Raw/CFF19_DemogCFDiag_Del1.csv")
races <- c(
  "White",
  "Black or African American",
  "American Indian or Alaska Native",
  "Asian",
  "Native Hawaiian or Other Pacific ",
  "Some other race"
)
demogs$Race <- apply(demogs, 1, function(r) {
  w <- which(r[paste0("Race", 1:6)] == 1)
  if (length(w) > 1) {
    return("More than one race")
  } else {
    return(races[w])
  }
})
demogs$Race <- factor(
  demogs$Race,
  levels = c(
    "White",
    "American Indian or Alaska Native",
    "Asian",
    "Black or African American",
    "More than one race",
    "Native Hawaiian or Other Pacific ",
    "Some other race"
  ),
  labels = c(
    "White",
    "Other race",
    "Other race",
    "Black or African American",
    "More than one race",
    "Other race",
    "Other race"
  )
)
demogs$Hispanicrace <- factor(
  demogs$Hispanicrace,
  levels = 1:2,
  labels = c("Yes", "No")
)
demogs <- demogs %>% select(eDWID, Gender, MutClass, Race, Hispanicrace)
annual <- left_join(annual, demogs, by = join_by(eDWID))
# Variable formatting
# If A_supplement_feeding is 0, then A_feeding2 is also 0 because they are not
# on any supplemental feeding
# Include all kinds of tube feeds
annual$A_feeding2[annual$A_supplement_feeding == 0] <- 0
annual$A_feeding3[annual$A_supplement_feeding == 0] <- 0
annual$A_feeding4[annual$A_supplement_feeding == 0] <- 0
tube_fields <- c("A_feeding2", "A_feeding3", "A_feeding4")
annual$tube_feeding <-
  apply(annual[, tube_fields], 1, function(r) {
    if (all(is.na(r))) {
      return(NA)
    } else {
      return(max(as.numeric(r), na.rm = T))
    }
  })
# Liver disease
liver_fields <- c("A_hepatobiliary1_3", paste0("A_hepatobiliary2_", 1:4))
annual$liver_disease <-
  apply(annual[, liver_fields], 1, function(r) {
    if (all(is.na(r))) {
      return(NA)
    } else {
      return(max(as.numeric(r), na.rm = T))
    }
  })
# Get BMI categories
annual$bmi <- annual$A_weight / ((annual$A_height / 100)^2)
annual$bmi <- coalesce(annual$A_bmivalue, annual$bmi)
annual$bmi_perc_cdc <- sds(
  annual$bmi,
  age = annual$Age_YrEnd,
  sex = annual$Gender,
  male = "M",
  female = "F",
  item = "bmi",
  ref = cdc.ref,
  type = "perc"
) *
  100
annual$bmi_perc_who <- sds(
  annual$bmi,
  age = annual$Age_YrEnd,
  sex = annual$Gender,
  male = "M",
  female = "F",
  item = "bmi",
  ref = who.ref,
  type = "perc"
) *
  100
annual$bmi_perc <- coalesce(annual$bmi_perc_cdc, annual$bmi_perc_who)
annual$bmi_cat <- apply(annual, 1, function(r) {
  age <- as.numeric(r["Age_YrEnd"])
  gender <- as.character(r["Gender"])
  bmi <- as.numeric(r["bmi"])
  bmi_perc <- as.numeric(r["bmi_perc"])
  if (age <= 20) {
    return(cut(
      bmi_perc,
      c(-Inf, 10, 50, 85, Inf),
      right = F,
      labels = c("Undernourished", "At Risk", "Target/Goal", "Overweight")
    ))
  } else if (age > 20) {
    if (gender == "M") {
      return(cut(
        bmi,
        c(-Inf, 18.5, 23, 25, Inf),
        right = F,
        labels = c(
          "Undernourished",
          "At Risk",
          "Target/Goal",
          "Overweight"
        )
      ))
    } else if (gender == "F") {
      return(cut(
        bmi,
        c(-Inf, 18.5, 22, 25, Inf),
        right = F,
        labels = c(
          "Undernourished",
          "At Risk",
          "Target/Goal",
          "Overweight"
        )
      ))
    }
  }
})
annual$bmi_cat <- relevel(annual$bmi_cat, ref = "Target/Goal")
# Raw values for adults, percentiles for peds
annual$bmi_adult = annual$bmi
annual$bmi_adult[annual$Age_YrEnd <= 20] = NA
annual$bmi_perc = annual$bmi_perc
annual$bmi_perc[annual$Age_YrEnd > 20] = NA
# Labels
var_label(annual$bmi) = "BMI (all participants)"
var_label(annual$bmi_perc) = "BMI percentile (age <= 20)"
var_label(annual$bmi_adult) = "BMI value (age > 20)"
var_label(annual$bmi_cat) = "BMI category"
# Format columns
annual$MutClass <- factor(
  annual$MutClass,
  levels = c("1-3", "4-5", "Oth", "N/A"),
  labels = c("1-3", "4-5", "Oth", "Unknown")
)
annual$NumPulmExacerbation <- cut(
  annual$NumPulmExacerbation,
  labels = c("0", "1", "2", ">=3"),
  breaks = c(0, 1, 2, 3, Inf),
  right = F
)
# Age groups 10 - 18 inclusive, 19 - 30 inclusive, >= 31
annual$age_group <- cut(
  annual$Age_YrEnd,
  breaks = c(-Inf, 10, 19, 31, Inf),
  right = F
)
# Bugs
bugs <- c(
  "A_pseudomonasaeruginosa",
  "A_fungalyeast1",
  "A_pulmonarycomplications1",
  "A_mycocultureresults3",
  "A_cultureresults3"
)
# Yes/No variables
yn_vars <- c(
  "A_corticosteroids1",
  "A_feeding2",
  "A_Vx770",
  "A_VX809comb",
  bugs,
  "tube_feeding",
  "liver_disease"
)
annual[, yn_vars] <- lapply(
  annual[, yn_vars],
  factor,
  levels = 0:1,
  labels = c("No", "Yes")
)
annual$A_IsOnEnzymes <- factor(
  annual$A_IsOnEnzymes,
  levels = c(1, 0),
  labels = c(" Yes", " No")
)
# FEV1 to categorical
annual$ppFEV1_cat <- cut(
  annual$A_FEV1_pct_predicted,
  breaks = c(0, 40, 80, 100, Inf),
  right = F
)
annual$ppFEV1_cat <- factor(
  annual$ppFEV1_cat,
  levels = c("[100,Inf)", "[80,100)", "[40,80)", "[0,40)")
)
# Males to reference group
annual$Gender <- factor(annual$Gender, levels = c("M", "F"))
# Hispanic no as reference
annual$Hispanicrace <- factor(annual$Hispanicrace, levels = c("No", "Yes"))
# Get first year of CFRD
first_cfrd <- annual %>%
  filter(cfrd_status_annual == "CFRD+") %>%
  group_by(eDWID) %>%
  summarise(first_cfrd = min(ReviewYear), age_dx = min(Age_YrEnd))
annual <- left_join(annual, first_cfrd, by = join_by(eDWID))
# Year prior to first CFRD in registry - assume negative for CFRD. Assume all
# years following are CFRD+
annual$CFRD <- NA
annual$CFRD[annual$ReviewYear < annual$first_cfrd] <- "CFRD-"
annual$CFRD[annual$ReviewYear >= annual$first_cfrd] <- "CFRD+"
annual$CFRD[is.na(annual$first_cfrd)] <- "CFRD-"
annual$CFRD <- factor(annual$CFRD, levels = c("CFRD-", "CFRD+"))
# Add formatted columns for survival analysis
annual$tstop <- ymd(paste0(annual$ReviewYear, "-12-31"))
annual$tstart <- ymd(paste0(annual$ReviewYear, "-01-01"))
annual <- annual %>%
  group_by(eDWID) %>%
  mutate(entry_date = tstart[1]) %>%
  ungroup()
# Remove those under 10
annual$age_group <- relevel(annual$age_group, ref = "[10,19)")
annual <- annual %>% filter(Age_YrEnd != 0, Age_YrEnd >= 10)
annual$age_group <- droplevels(annual$age_group)
# List of covariates
vars <- c(
  "age_group",
  "Gender",
  "bmi_perc",
  "bmi_cat",
  "MutClass",
  "Race",
  "Hispanicrace",
  "A_IsOnEnzymes",
  "ppFEV1_cat",
  "tube_feeding",
  "NumPulmExacerbation",
  "A_pseudomonasaeruginosa",
  "A_fungalyeast1",
  "A_mycocultureresults3",
  "A_corticosteroids1",
  "cfrd_status_annual",
  "A_Vx770",
  "A_VX809comb",
  "liver_disease"
)
# Nice labels for plots and tables
labels <- list(
  cfrd_status_annual = "CFRD Status",
  MutClass = "Mutation class",
  Race = "Race",
  Hispanicrace = "Hispanic",
  Gender = "Sex",
  A_IsOnEnzymes = "Pancreatic enzyme use",
  ppFEV1_cat = "FEV1 percent predicted category",
  A_FEV1_pct_predicted = "FEV1 percent predicted",
  A_FVC_pct_predicted = "FVC percent predicted",
  tube_feeding = "Enteric feedings",
  liver_disease = "Liver disease",
  A_corticosteroids1 = "Use of corticosteroids",
  NumPulmExacerbation = "Admissions for PEx",
  age_group = "Age group",
  height_perc = "Height percentile",
  A_Vx770 = "Use of CFTR modulator Vx770",
  A_VX809comb = "Use of CFTR modulator Vx809 combination",
  A_pseudomonasaeruginosa = "Pseudomonas aeruginosa",
  A_fungalyeast1 = "Aspergillus (any species)",
  A_mycocultureresults3 = "Microorganisms in myco culture",
  A_cultureresults3 = "Microorganisms in culture",
  eDWID = "ID",
  tstart = "Interval start",
  tstop = "Interval stop",
  Age_YrEnd = "Age"
)
label(annual[, which(colnames(annual) %in% names(labels))]) <-
  labels[colnames(annual)[which(colnames(annual) %in% names(labels))]]
# Per reviewer, out of X individuals with a diagnosis of CFRD, X number had an
# OGTT (and X had an A1c, but no OGTT) that year or the year prior.
# This is super slow but idc idc
cfrd_only <- apply(first_cfrd, 1, function(r) {
  id <- as.numeric(r["eDWID"])
  year <- as.numeric(r["first_cfrd"])
  d <- annual[annual$eDWID == id & annual$ReviewYear %in% c(year, year - 1), ]
  a1c <- as.numeric(last(d["A_hgba1c"], na_rm = TRUE))
  ogtt0hr <- as.numeric(last(d["A_ogttfast_bloodglucose"], na_rm = TRUE))
  ogtt2hr <- as.numeric(last(d["A_twohour_bloodglucose"], na_rm = TRUE))
  return(c(id, year, a1c, ogtt0hr, ogtt2hr))
})
cfrd_only <- data.frame(t(cfrd_only))
colnames(cfrd_only) <- c("id", "year", "a1c", "ogtt0hr", "ogtt2hr")
cfrd_only <- left_join(
  cfrd_only,
  annual %>% mutate(eDWID = as.numeric(eDWID)),
  by = join_by(id == eDWID, year == ReviewYear)
)
cfrd_only$a1c_ogtt <- apply(cfrd_only, 1, function(r) {
  not_missing <- paste(
    which(!is.na(r[c("a1c", "ogtt0hr", "ogtt2hr")])),
    collapse = "_"
  )
  return(not_missing)
})
cfrd_only$a1c_ogtt <- factor(
  cfrd_only$a1c_ogtt,
  levels = c("", "1", "1_2", "1_2_3", "1_3", "2", "2_3", "3"),
  labels = c(
    "Neither",
    "HbA1c Only",
    "OGTT",
    "OGTT",
    "OGTT",
    "OGTT",
    "OGTT",
    "OGTT"
  )
)
cfrd_only %>%
  select(
    a1c_ogtt,
    Age_YrEnd,
    A_weight,
    A_height,
    bmi_adult,
    bmi_perc,
    bmi_cat,
    A_FEV1_pct_predicted,
    A_FVC_pct_predicted,
    Race,
    Hispanicrace,
    MutClass,
    a1c,
    A_ogttfast_bloodglucose,
    A_twohour_bloodglucose,
    A_IsOnEnzymes,
    liver_disease,
    A_pseudomonasaeruginosa,
    A_fungalyeast1,
    A_mycocultureresults3,
    A_cultureresults3
  ) %>%
  tbl_summary(
    by = a1c_ogtt,
    missing_text = "Missing",
    statistic = list(all_continuous() ~ "{mean} ({sd})")
  ) %>%
  add_overall() %>%
  add_p(test = list(all_continuous() ~ "oneway.test")) %>%
  modify_caption("**All Groups**")
cfrd_only %>%
  filter(a1c_ogtt %in% c("OGTT", "HbA1c Only")) %>%
  mutate(a1c_ogtt = droplevels(a1c_ogtt)) %>%
  select(
    a1c_ogtt,
    Age_YrEnd,
    A_weight,
    A_height,
    A_bmivalue,
    A_bmipercentile,
    A_FEV1_pct_predicted,
    A_FVC_pct_predicted,
    Race,
    Hispanicrace,
    MutClass,
    a1c,
    A_ogttfast_bloodglucose,
    A_twohour_bloodglucose,
    A_IsOnEnzymes,
    liver_disease,
    A_pseudomonasaeruginosa,
    A_fungalyeast1,
    A_mycocultureresults3,
    A_cultureresults3
  ) %>%
  tbl_summary(
    by = a1c_ogtt,
    missing_text = "Missing",
    statistic = list(all_continuous() ~ "{mean} ({sd})")
  ) %>%
  add_overall() %>%
  add_p(test = list(all_continuous() ~ "oneway.test")) %>%
  modify_caption("**OGTT vs. HbA1c Only**")
```

## FEV1 trends by diagnosis method

### LOESS-smoothed plot

```{r}
#| warning: false
#| message: false
# Plot by diagnosis type
mod_df = cfrd_only %>%
  select(id, a1c_ogtt, Age_YrEnd) %>%
  rename(eDWID = id)
mod_df = left_join(
  annual %>% select(-Age_YrEnd) |> mutate(eDWID = as.numeric(eDWID)),
  mod_df,
  by = join_by(eDWID)
)
mod_df = mod_df %>%
  drop_na(first_cfrd) |>
  group_by(eDWID) %>%
  mutate(years_to_cfrd = ReviewYear - first_cfrd)
var_label(mod_df$years_to_cfrd) = "Years to CFRD"
var_label(mod_df$Age_YrEnd) = "Age at Diagnosis"
ggplot(
  mod_df %>% filter(!is.na(a1c_ogtt)),
  aes(
    y = A_FEV1_pct_predicted,
    x = years_to_cfrd,
    color = a1c_ogtt,
    group = a1c_ogtt
  )
) +
  xlab("Years from CFRD") +
  xlim(c(-10, 10)) +
  geom_point(alpha = 0.1, shape = ".") +
  geom_smooth(formula = y ~ s(x, bs = "cr")) +
  theme_bw() +
  theme(legend.title = element_blank())
```

### Piecewise linear model results

There were not enough pancreatic sufficient people in this dataset to include that varaible in the model.

```{r}
# Fit model - adjust for age at dx, sex, genotype (severe vs mild), pancreatic
# insufficiency, age at CF diagnosis (do we know this?), number of clinic
# visits/year, use of CFTR modulators
mod_df$x = mod_df$years_to_cfrd * (mod_df$years_to_cfrd >= 0)
label(mod_df$x) = "Change in Slope Post-CFRD"
label(mod_df$years_to_cfrd) = "Slope Pre-CFRD"
label(mod_df$a1c_ogtt) = "Diagnosis Method"
label(mod_df$Age_YrEnd) = "Age at Diagnosis"
m <- lmer(
  A_FEV1_pct_predicted ~ years_to_cfrd *
    a1c_ogtt +
    x * a1c_ogtt +
    Age_YrEnd +
    Gender +
    MutClass +
    A_Vx770 +
    A_VX809comb +
    (1 | eDWID),
  data = mod_df
)
# Population-averaged plot
pop_dat <- data.frame(expand.grid(
  years_to_cfrd = -10:10,
  a1c_ogtt = unique(mod_df$a1c_ogtt),
  Age_YrEnd = mean(mod_df$Age_YrEnd, na.rm = T),
  Gender = "M",
  MutClass = "1-3",
  A_Vx770 = "No",
  A_VX809comb = "No"
))
pop_dat$x <- (pop_dat$years_to_cfrd >= 0) * pop_dat$years_to_cfrd
pred <- predict(m, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(
  pop_dat,
  aes(x = years_to_cfrd, y = pred, group = a1c_ogtt, colour = a1c_ogtt)
) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from CFRD") +
  ylab("FEV1 % Predicted") +
  theme_classic(base_size = 15)
# Model table
m |> tbl_regression()
# Contrasts
neither_pre <- rep(0, nrow(summary(m)$coefficients))
neither_change <- rep(0, nrow(summary(m)$coefficients))
neither_pre[which(rownames(summary(m)$coefficients) == "years_to_cfrd")] = 1
neither_change[which(rownames(summary(m)$coefficients) == "x")] = 1
a1c_pre <- rep(0, nrow(summary(m)$coefficients))
a1c_change <- rep(0, nrow(summary(m)$coefficients))
a1c_pre[which(
  rownames(summary(m)$coefficients) %in%
    c("years_to_cfrd", "years_to_cfrd:a1c_ogttHbA1c Only")
)] = 1
a1c_change[which(
  rownames(summary(m)$coefficients) %in%
    c("x", "a1c_ogttHbA1c Only:x")
)] = 1
ogtt_pre <- rep(0, nrow(summary(m)$coefficients))
ogtt_change <- rep(0, nrow(summary(m)$coefficients))
ogtt_pre[which(
  rownames(summary(m)$coefficients) %in%
    c("years_to_cfrd", "years_to_cfrd:a1c_ogttOGTT")
)] = 1
ogtt_change[which(
  rownames(summary(m)$coefficients) %in%
    c("x", "a1c_ogttOGTT:x")
)] = 1
contr <- rbind(
  "HbA1c Only Pre-CFRD" = a1c_pre,
  "HbA1c Only Post-CFRD" = a1c_pre + a1c_change,
  "OGTT Pre-CFRD" = ogtt_pre,
  "OGTT Post-CFRD" = ogtt_pre + ogtt_change,
  "Neither Pre-CFRD" = neither_pre,
  "Neither Post-CFRD" = neither_pre + neither_change
)
change_mod_slopes <- glht(m, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Diagnosis Method", rownames_to_stub = T) %>%
  fmt_number(decimals = 2)
```

## FVC trends by diagnosis method

### LOESS-smoothed plot

```{r} 
ggplot(
  mod_df %>% filter(!is.na(a1c_ogtt)),
  aes(
    y = A_FVC_pct_predicted,
    x = years_to_cfrd,
    color = a1c_ogtt,
    group = a1c_ogtt
  )
) +
  xlab("Years from CFRD") +
  xlim(c(-10, 10)) +
  geom_point(alpha = 0.1, shape = ".") +
  geom_smooth(formula = y ~ s(x, bs = "cr")) +
  theme_bw() +
  theme(legend.title = element_blank())
```

### Piecewise linear model results

There were not enough pancreatic sufficient people in this dataset to include that varaible in the model.

```{r}
# Fit model - adjust for age at dx, sex, genotype (severe vs mild), pancreatic
# insufficiency, age at CF diagnosis (do we know this?), number of clinic
# visits/year, use of CFTR modulators
mod_df$x = mod_df$years_to_cfrd * (mod_df$years_to_cfrd >= 0)
label(mod_df$x) = "Change in Slope Post-CFRD"
label(mod_df$years_to_cfrd) = "Slope Pre-CFRD"
label(mod_df$a1c_ogtt) = "Diagnosis Method"
label(mod_df$Age_YrEnd) = "Age at Diagnosis"
m <- lmer(
  A_FVC_pct_predicted ~ years_to_cfrd *
    a1c_ogtt +
    x * a1c_ogtt +
    Age_YrEnd +
    Gender +
    MutClass +
    A_Vx770 +
    A_VX809comb +
    (1 | eDWID),
  data = mod_df
)
# Population-averaged plot
pop_dat <- data.frame(expand.grid(
  years_to_cfrd = -10:10,
  a1c_ogtt = unique(mod_df$a1c_ogtt),
  Age_YrEnd = mean(mod_df$Age_YrEnd, na.rm = T),
  Gender = "M",
  MutClass = "1-3",
  A_Vx770 = "No",
  A_VX809comb = "No"
))
pop_dat$x <- (pop_dat$years_to_cfrd >= 0) * pop_dat$years_to_cfrd
pred <- predict(m, re.form = NA, newdata = pop_dat, se.fit = T)
pop_dat$pred <- pred$fit
pop_dat$ll <- pop_dat$pred - (1.96 * pred$se.fit)
pop_dat$ul <- pop_dat$pred + (1.96 * pred$se.fit)
ggplot(
  pop_dat,
  aes(x = years_to_cfrd, y = pred, group = a1c_ogtt, colour = a1c_ogtt)
) +
  geom_point() +
  geom_errorbar(aes(ymin = ll, ymax = ul), width = 0.1) +
  geom_line() +
  xlab("Years from CFRD") +
  ylab("FVC % Predicted") +
  theme_classic(base_size = 15)
# Model table
m |> tbl_regression()
# Contrasts
neither_pre <- rep(0, nrow(summary(m)$coefficients))
neither_change <- rep(0, nrow(summary(m)$coefficients))
neither_pre[which(rownames(summary(m)$coefficients) == "years_to_cfrd")] = 1
neither_change[which(rownames(summary(m)$coefficients) == "x")] = 1
a1c_pre <- rep(0, nrow(summary(m)$coefficients))
a1c_change <- rep(0, nrow(summary(m)$coefficients))
a1c_pre[which(
  rownames(summary(m)$coefficients) %in%
    c("years_to_cfrd", "years_to_cfrd:a1c_ogttHbA1c Only")
)] = 1
a1c_change[which(
  rownames(summary(m)$coefficients) %in%
    c("x", "a1c_ogttHbA1c Only:x")
)] = 1
ogtt_pre <- rep(0, nrow(summary(m)$coefficients))
ogtt_change <- rep(0, nrow(summary(m)$coefficients))
ogtt_pre[which(
  rownames(summary(m)$coefficients) %in%
    c("years_to_cfrd", "years_to_cfrd:a1c_ogttOGTT")
)] = 1
ogtt_change[which(
  rownames(summary(m)$coefficients) %in%
    c("x", "a1c_ogttOGTT:x")
)] = 1
contr <- rbind(
  "HbA1c Only Pre-CFRD" = a1c_pre,
  "HbA1c Only Post-CFRD" = a1c_pre + a1c_change,
  "OGTT Pre-CFRD" = ogtt_pre,
  "OGTT Post-CFRD" = ogtt_pre + ogtt_change,
  "Neither Pre-CFRD" = neither_pre,
  "Neither Post-CFRD" = neither_pre + neither_change
)
change_mod_slopes <- glht(m, linfct = contr)
change_mod_slopes_ci <- confint(change_mod_slopes, calpha = univariate_calpha())
change_mod_slopes_ci$confint %>%
  as.data.frame() %>%
  gt(caption = "Slopes by Diagnosis Method", rownames_to_stub = T) %>%
  fmt_number(decimals = 2)
```