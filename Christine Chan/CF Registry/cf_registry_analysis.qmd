---
title: "CF Registry Analysis"
author: "Tim Vigers"
date: "`r format(Sys.time(), '%d %B %Y')`"
format:
  html:
    toc: true
    toc-depth: 5
    toc-float: true
    code-fold: true
    self-contained: true
    page-layout: full
editor: visual
---

```{r}
#| include: false
library(knitr)
library(tidyverse)
library(table1)
library(pROC)
```

```{r}
# All data
encounter <- read.csv("Z:/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Christine Chan/CF registry data/CFF19_encountersMerged_Del1.csv",
                      na.strings = c("", "N/A")
)
annual <- read.csv("Z:/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Christine Chan/CF registry data/CFF19_Annualized_Del1.csv",
                   na.strings = c("", "N/A")
)
encounter <- encounter %>%
  arrange(eDWID, reviewyear, encounternum)
# Add age
ages <- annual %>% arrange(eDWID,ReviewYear) %>% 
  mutate(`Age in 2018` = 2018-(ReviewYear-Age_YrEnd)) %>%
  group_by(eDWID) %>%
  summarise(`Age in 2018` = as.numeric(names(sort(table(`Age in 2018`), 
                                                  decreasing = TRUE)[1])))
encounter = left_join(encounter,ages,by = "eDWID")
encounter$`Age Group` = cut(encounter$`Age in 2018`,
                            c(-Inf,10,19,31,Inf),
                            labels = c("< 10", "10 - 18", "19 - 30", "> 30"),
                            right=F)
# For those with CFRD by OGTT, find first visit with diagnosis
first_cfrd <- encounter %>%
  filter(twohour_bloodglucose >= 200) %>%
  group_by(eDWID) %>%
  slice_min(reviewyear) %>%
  select(eDWID, reviewyear, `Age in 2018`) %>%
  rename(first_cfrd = reviewyear)
encounter <- left_join(encounter, first_cfrd, by = c("eDWID", "Age in 2018"))
encounter <- encounter %>%
  group_by(eDWID) %>%
  mutate(cfrd_ogtt = case_when(
    reviewyear < first_cfrd ~ "No",
    reviewyear >= first_cfrd ~ "Yes"
  )) %>%
  ungroup()
encounter$cfrd_ogtt[is.na(encounter$cfrd_ogtt)] <- "No"
```

```{r}
#| label: tbl-incidence
#| tbl-cap: "Year-on-Year Incidence of CFRD"
# For each year, pull everyone with and without CFRD that year
year_inc = function(df=encounter,year,py = 1000){
  # Filter and count
  inc = df %>% 
    filter(reviewyear==year,is.na(first_cfrd) | first_cfrd == year) %>%
    group_by(eDWID) %>% filter(row_number() == 1) %>%
    select(eDWID,reviewyear,encounternum,`Age Group`,
           twohour_bloodglucose,cfrd_ogtt,first_cfrd)
  inc = inc %>% group_by(cfrd_ogtt) %>% count(`Age Group`,.drop = F)
  # Calculations
  new_cases = sum(inc$n[inc$cfrd_ogtt=="Yes"])
  total_at_risk = sum(inc$n)
  total_inc = new_cases/(total_at_risk/py)
  
  new_cases_10 = sum(inc$n[inc$cfrd_ogtt=="Yes" & inc$`Age Group` == "< 10"])
  at_risk_10 = sum(inc$n[inc$`Age Group` == "< 10"])
  inc_10 = new_cases_10/(at_risk_10/py)
  
  new_cases_10_18 = sum(inc$n[inc$cfrd_ogtt=="Yes" & inc$`Age Group` == "10 - 18"])
  at_risk_10_18 = sum(inc$n[inc$`Age Group` == "10 - 18"])
  inc_10_18 = new_cases_10_18/(at_risk_10_18/py)
  
  new_cases_19_30 = sum(inc$n[inc$cfrd_ogtt=="Yes" & inc$`Age Group` == "19 - 30"])
  at_risk_19_30 = sum(inc$n[inc$`Age Group` == "19 - 30"])
  inc_19_30 = new_cases_19_30/(at_risk_19_30/py)
  
  new_cases_30 = sum(inc$n[inc$cfrd_ogtt=="Yes" & inc$`Age Group` == "> 30"])
  at_risk_30 = sum(inc$n[inc$`Age Group` == "> 30"])
  inc_30 = new_cases_30/(at_risk_30/py)
  
  # Nice results
  list(`Year` = year,
       `Total New Cases` = new_cases,
       `Total At Risk` = total_at_risk,
       `Total Incidence` = total_inc,
       
       `Total New Cases Age < 10` = new_cases_10,
       `Total At Risk Age < 10` = at_risk_10,
       `Total Incidence Age < 10` = inc_10,
       
       `Total New Cases Age 10-18` = new_cases_10_18,
       `Total At Risk Age 10-18` = at_risk_10_18,
       `Total Incidence Age 10-18` = inc_10_18,
       
       `Total New Cases Age 19-30` = new_cases_19_30,
       `Total At Risk Age 19-30` = at_risk_19_30,
       `Total Incidence Age 19-30` = inc_19_30,
       
       `Total New Cases Age > 30` = new_cases_30,
       `Total At Risk Age > 30` = at_risk_30,
       `Total Incidence Age > 30` = inc_30)
}
incidence = lapply(2003:2018, function(y){year_inc(year = y)})
incidence = do.call(rbind,incidence)
kable(incidence,digits = 3)
```

In @tbl-incidence, incidence per year is calculated as the number of new CFRD diagnoses per 1,000 person-years of those at risk (excluding previously identified cases).

```{r}
#| label: tbl-prevalence
#| tbl-cap: "Yearly Prevalence of CFRD"
encounter %>% 
```

In @tbl-prevalence, prevalence is calculated as the total number of CFRD cases seen in clinic divided by the total number of people seen in clinic in a given year.

# Questions

1.  For these calculations, do we need to just use those with an OGTT? Or everybody in the database?
