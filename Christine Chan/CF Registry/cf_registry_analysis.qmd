---
title: "CF Registry Analysis"
author: "Tim Vigers"
date: "today"
date-format: long
format:
  html:
    toc: true
    toc-depth: 5
    toc-float: true
    code-fold: true
    self-contained: true
    fig-cap-location: top
    page-layout: full
editor: source
---

```{r}
#| include: false
library(knitr)
library(tidyverse)
library(forestmodel)
```

# Logistic analyses

Any participants with T1D or T2D were excluded from these analyses.

```{r}
# Import and clean data
annual <- read.csv("/Users/timvigers/Documents/Work/Christine Chan/CF registry data/CFF19_Annualized_Del1.csv",
                   na.strings = c("", "N/A")
)
annual = annual %>% filter(cfrd_status_annual != 4,cfrd_status_annual != 5)
annual$cfrd_status_annual = factor(annual$cfrd_status_annual,levels = 1:3,
                                   labels = c("CFRD-","CFRD-","CFRD+"))
demogs = read.csv("/Users/timvigers/Documents/Work/Christine Chan/CF registry data/CFF19_DemogCFDiag_Del1.csv")
demogs = demogs %>% select(eDWID,Gender,MutClass)
annual = left_join(annual,demogs,by = join_by(eDWID))
# Analysis function
log_reg = function(year = 2005){
  # Clean data
  df = annual %>% 
    filter(ReviewYear==year) %>%
    select(eDWID,Age_YrEnd,Gender,MutClass,A_IsOnEnzymes,A_FEV1_pct_predicted,
           A_bmivalue,A_bmipercentile,A_height,A_heightpercentile,
           NumPulmExacerbation,A_feeding2,A_pseudomonasaeruginosa,
           A_fungalyeast1,A_pulmonarycomplications1,A_mycocultureresults1,
           A_corticosteroids1,cfrd_status_annual,A_Vx770,A_VX809comb)
  # Format columns
  df$MutClass = factor(df$MutClass,levels = c("1-3","4-5","Oth","N/A"),
                       labels = c("1-3","4-5","Oth",NA))
  df$NumPulmExacerbation=cut(df$NumPulmExacerbation,labels = c("0","1","2",">=3"),
                             breaks = c(0,1,2,3,Inf),right = F)
  df$A_feeding2 = factor(df$A_feeding2,levels = 0:1,labels = c("No","Yes"))
  df$A_IsOnEnzymes = factor(df$A_IsOnEnzymes,levels = 0:1,labels = c("No","Yes"))
  df$A_FEV1_pct_predicted = cut(df$A_FEV1_pct_predicted,breaks = c(0,40,80,100,Inf),right = F)
  df$A_corticosteroids1 = factor(df$A_corticosteroids1,levels = 0:1,labels = c("No","Yes"))
  df$A_fungalyeast1 = factor(df$A_fungalyeast1,levels = 0:1,labels = c("No","Yes"))
  df$A_pulmonarycomplications1 = factor(df$A_pulmonarycomplications1,levels = 0:1,labels = c("No","Yes"))
  df$A_mycocultureresults1 = factor(df$A_mycocultureresults1,levels = 0:1,labels = c("No","Yes"))
  df$A_Vx770 = factor(df$A_Vx770,levels = 0:1,labels = c("No","Yes"))
  df$A_VX809comb = factor(df$A_VX809comb,levels = 0:1,labels = c("No","Yes"))
  # Remove all empty columns
  df = df[,-which(colSums(is.na(df))==nrow(df))]
  # Bugs
  bugs = c("A_pseudomonasaeruginosa","A_fungalyeast1",
           "A_pulmonarycomplications1","A_mycocultureresults1")
  # Models
  vars = colnames(df)[which(!colnames(df) %in% 
                              c(bugs,"cfrd_status_annual","eDWID","A_bmivalue",
                                "A_bmipercentile","A_height","A_heightpercentile"))]
  base_mod = as.formula(paste0("cfrd_status_annual~",paste0(vars,collapse = "+")))
  adult_mod = update(base_mod,.~.+A_bmivalue+A_height)
  peds_mod = update(base_mod,.~.+A_bmipercentile+A_heightpercentile)
  # Simple models
  adult_mod1 = glm(adult_mod,data = df,family = "binomial")
  peds_mod1 = glm(peds_mod,data = df,family = "binomial")
  # Print results
  cat("\n")
  cat("### Base Models")
  cat("\n")
  cat("\n")
  cat("#### Adult")
  cat("\n")
  cat("\n")
  print(forest_model(adult_mod1))
  cat("\n")
  cat("\n")
  cat("#### Peds")
  cat("\n")
  cat("\n")
  print(forest_model(peds_mod1))
  cat("\n")
  if ("A_pseudomonasaeruginosa" %in% colnames(df)){
    adult_mod2 = glm(update(adult_mod,.~.+A_pseudomonasaeruginosa),data = df,family = "binomial")
    peds_mod2 = glm(update(peds_mod,.~.+A_pseudomonasaeruginosa),data = df,family = "binomial")
    cat("\n")
    cat("### P. aeruginosa")
    cat("\n")
    cat("\n")
    cat("#### Adult")
    cat("\n")
    cat("\n")
    print(forest_model(adult_mod2))
    cat("\n")
    cat("\n")
    cat("#### Peds")
    cat("\n")
    cat("\n")
    print(forest_model(peds_mod2))
    cat("\n")
  }
  if("A_fungalyeast1" %in% colnames(df)){
    adult_mod3 = glm(update(adult_mod,.~.+A_fungalyeast1),data = df,family = "binomial")
    peds_mod3 = glm(update(peds_mod,.~.+A_fungalyeast1),data = df,family = "binomial")
    cat("\n")
    cat("### Aspergillus")
    cat("\n")
    cat("\n")
    cat("#### Adult")
    cat("\n")
    cat("\n")
    print(forest_model(adult_mod3))
    cat("\n")
    cat("\n")
    cat("#### Peds")
    cat("\n")
    cat("\n")
    print(forest_model(peds_mod3))
    cat("\n")
  }
  if("A_pulmonarycomplications1" %in% colnames(df)){
    adult_mod4 = glm(update(adult_mod,.~.+A_pulmonarycomplications1),data = df,family = "binomial")
    peds_mod4 = glm(update(peds_mod,.~.+A_pulmonarycomplications1),data = df,family = "binomial")
    cat("\n")
    cat("### ABPA")
    cat("\n")
    cat("\n")
    cat("#### Adult")
    cat("\n")
    cat("\n")
    print(forest_model(adult_mod4))
    cat("\n")
    cat("\n")
    cat("#### Peds")
    cat("\n")
    cat("\n")
    print(forest_model(peds_mod4))
    cat("\n")
  }
  if("A_mycocultureresults1" %in% colnames(df)){
    adult_mod5 = glm(update(adult_mod,.~.+A_mycocultureresults1),data = df,family = "binomial")
    peds_mod5 = glm(update(peds_mod,.~.+A_mycocultureresults1),data = df,family = "binomial")
    cat("\n")
    cat("### Mycobacterium")
    cat("\n")
    cat("\n")
    cat("#### Adult")
    cat("\n")
    cat("\n")
    print(forest_model(adult_mod5))
    cat("\n")
    cat("\n")
    cat("#### Peds")
    cat("\n")
    cat("\n")
    print(forest_model(peds_mod5))
    cat("\n")
  }
}
```

## 2005

```{r results='asis',fig.height=10,fig.width=10}
log_reg(2005)
```

# Questions

1. What variables do we use for B. Cepacia and liver disease?
2. Do we have CFTR modulator data aside from `Vx770` and `Vx809comb`?
