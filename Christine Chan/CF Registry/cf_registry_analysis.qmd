---
title: "CF Registry Analysis"
author: "Tim Vigers"
date: "`r format(Sys.time(), '%d %B %Y')`"
format:
  html:
    toc: true
    toc-depth: 5
    toc-float: true
    code-fold: true
    self-contained: true
editor: visual
---

```{r}
#| include: false
library(tidyverse)
library(table1)
# All data
df = read.csv("/home/timvigers/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Christine Chan/CF registry data/CFF19_encountersMerged_Del1.csv",na.strings = c("","N/A"))
df = df %>% arrange(eDWID,reviewyear,encounternum)
# For those with CFRD by OGTT, find first visit with diagnosis
first_cfrd = df %>% group_by(eDWID) %>% 
  summarise(first_cfrd = which(twohour_bloodglucose >= 200),.groups = "drop")
df = left_join(df,first_cfrd,by = "eDWID")
df = df %>% group_by(eDWID) %>% 
  mutate(cfrd_ogtt = case_when(
    row_number() < first_cfrd ~ "No",
    row_number() >= first_cfrd ~ "Yes"
  )) %>%
  ungroup()
df$cfrd_ogtt[is.na(df$cfrd_ogtt)] = "No"
df$cfrd_ogtt = factor(df$cfrd_ogtt,levels = c("No","Yes"),
                      labels = c("No","Yes"),ordered = TRUE)
diagnosis = df %>% 
  group_by(eDWID,reviewyear) %>% 
  summarise(cfrd_ogtt = max(cfrd_ogtt),.groups = "drop")
```

```{python}
#| @tbl-incidence
diagnosis = r.diagnosis
years = diagnosis["reviewyear"].unique()
cases = []
at_risk = []
incidence = []
# Loop through years
for y in years:
  d = diagnosis[diagnosis["reviewyear"]==y]
  this_year = d.loc[d["cfrd_ogtt"]=="Yes","eDWID"].to_list()
  cases = set(cases).union(this_year)
  new_cases = set(cases).difference(set(this_year))
  at_risk = set(d["eDWID"].to_list()).difference(at_risk)
  incidence.append(round(len(new_cases)/len(at_risk),3))
```
