---
title: "CF Registry Analysis"
author: "Tim Vigers"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 5
    toc_float: no
    page-layout: full
---

```{r setup, include=FALSE}
library(JM)
library(arsenal)
library(tidyverse)
library(knitr)
library(pROC)
library(lavaan)
library(survMisc)
knitr::opts_chunk$set(echo = FALSE,cache = TRUE,cache.lazy = FALSE)
knitr::opts_knit$set(root.dir = "~/Work/CHCO/Christine Chan/CF registry data")
```

```{r}
# Read in CSVs
df <- read.csv("CFF19_encountersMerged_Del1.csv",na.strings = c("","N/A"))
annual <- read.csv("CFF19_Annualized_Del1.csv",na.strings = c("","N/A"))
colnames(annual)[colnames(annual) == "ReviewYear"] <- "reviewyear"
demo <- read.csv("CFF19_DemogCFDiag_Del1.csv",na.strings = c("","N/A"))
geno <- read.csv("Data_Clean/genotypes.csv", header = F,na.strings = c("","N/A"))
# Combine and format demographics columns
demo$Race <- apply(demo, 1, function(r) {
  race <- r[paste0("Race", 1:6)]
  race <- as.numeric(which(race == 1))
  race <- paste(race, collapse = ", ")
})
demo$Race[grep(", ", demo$Race)] <- "More Than One"
demo$Race <- factor(demo$Race,
                    levels = c(1:6, "More Than One"),
                    labels = c(
                      "White", "Black or African American",
                      "American Indian or Alaska Native", "Asian",
                      "Native Hawaiian or Other Pacific Islander",
                      "Some other race", "More Than One"
                    )
)
demo$Hispanicrace <- factor(demo$Hispanicrace,
                            levels = 1:2,
                            labels = c("Yes", "No")
)
# Merge
df <- left_join(df, annual, by = c("eDWID", "reviewyear"))
df <- left_join(df, demo, by = "eDWID")
# Group years by 2003-2009, 2010-2013, and 2014-2018
df$Period <- cut(df$reviewyear,
                 breaks = c(2002, 2009, 2013, 2018),
                 labels = c("2003 - 2009", "2010 - 2013", "2014 - 2018")
)
df$smoking <- factor(df$smoking, levels = 1:4, labels = c(
  "No",
  "Occasionally",
  "Yes, Regularly, less than 1 ppd",
  "Yes, Regularly, 1 ppd or more"
), ordered = T)
df$second_smoke <- factor(df$second_smoke, levels = c(1:4), labels = c(
  "No",
  "Occasionally",
  "Yes, Regularly, less than 1 ppd",
  "Yes, Regularly, 1 ppd or more"
), ordered = T)
# Factors
ed_levels <- c(
  "Less than High School",
  "High School diploma or equivalent",
  "Some College",
  "College Graduate",
  "Masters/Doctoral level degree"
)
df$patient_education <- factor(df$patient_education,
                               levels = c(1:5),
                               labels = ed_levels
)
df$father_education <- factor(df$father_education,
                              levels = c(1:5),
                              labels = ed_levels
)
df$mother_education <- factor(df$mother_education,
                              levels = c(1:5),
                              labels = ed_levels
)
df$spouse_education <- factor(df$spouse_education,
                              levels = c(1:5),
                              labels = ed_levels
)
df$oxygen_therapy <- factor(df$oxygen_therapy,
                            levels = 1:6,
                            labels = c(
                              "Yes, Continuously",
                              "Yes, Nocturnal and/or with exertion",
                              "Yes, During exacerbation",
                              "Yes, prn",
                              "No",
                              "Unknown"
                            )
)
# Genotypes
df$Mutation1 <- factor(df$Mutation1,
                       levels = geno[geno$V1 == "mutation1", "V2"],
                       labels = geno[geno$V1 == "mutation1", "V3"]
)
df$Mutation2 <- factor(df$Mutation2,
                       levels = geno[geno$V1 == "mutation2", "V2"],
                       labels = geno[geno$V1 == "mutation2", "V3"]
)
df$F508del <- (df$Mutation1 == "F508del") + (df$Mutation2 == "F508del")
df$F508del <- factor(df$F508del, levels = 0:2, ordered = T,
                     labels = c("None", "Heterozygous", "Homozygous"))
# Percentiles for peds
df$bmi_peds = df$A_bmipercentile * (df$Age_YrEnd < 18)
df$bmi_adults = df$A_bmivalue * (df$Age_YrEnd >= 18)
df$height_peds = df$A_heightpercentile * (df$Age_YrEnd < 18)
df$height_adults = df$A_height * (df$Age_YrEnd >= 18)
df$weight_peds = df$A_weightpercentile * (df$Age_YrEnd < 18)
df$weight_adults = df$A_weight * (df$Age_YrEnd >= 18)
# Yes/no variables
yn <- c("A_IsOnEnzymes", "A_salt_supplement", "A_cf_vitamins", "A_dornasealfa", 
        "A_pulmonarycomplications4", "A_pulmonarycomplications5", 
        "A_othercomplications9", paste0("A_hepatobiliary1_",1:3), 
        paste0("A_hepatobiliary2_",1:4),paste0("employment", 1:7),
        "pregnant","dexa_results_osteoporosis","A_Vx770","A_VX809comb",
        "A_feeding3","A_corticosteroids1","A_pulmonarycomplications2",
        paste0("A_mycobacterials",c(1:5,7:10)),
        "A_pseudomonasaeruginosa","A_staphylococcus_aureus",
        "A_othermicroorganisms1","A_othermicroorganisms2",
        "A_fungalyeast1","A_fungalyeast2","A_fungalyeast3",
        paste0("A_act_primary",1:8),paste0("A_bronchodilators",1:2),
        paste0("A_bronchodilatorsinhaled",1:5))
df[, yn] <- lapply(df[, yn], function(c) {
  factor(c, levels = 0:1, labels = c("No", "Yes"), ordered = T)
})
df$Gender = as.factor(df$Gender)
# CFRD diagnosis
df$cfrd = df$cfrd_status == 3
df$cfrd = factor(df$cfrd,levels = c(F,T),labels = c("CFRD-","CFRD+"),ordered = T)
# Sort
df = df %>% arrange(eDWID,reviewyear,encounternum)
```

# Aim 1

## CFRD Incidence

```{r warning=FALSE}
df %>% group_by(reviewyear,eDWID) %>% 
  summarise(cfrd = max(cfrd,na.rm = T),
            age = max(Age_YrEnd,na.rm = T),
            .groups = "drop_last") %>%
  summarise(`CFRD Cases` = sum(cfrd=="CFRD+",na.rm = T),
            `Total People with CF` = n(),
            `CFRD Prevalence` =`CFRD Cases`/`Total People with CF`,
            .groups = "drop") %>%
  mutate(`New Cases` = `CFRD Cases`-`CFRD Cases`[1],
         `CFRD Incidence` = `New Cases`/`Total People with CF`) %>%
  kable(.)
```

## Table 1: Participant characteristics at last visit in time period

```{r results='asis',warning=FALSE}
# Summarize by ID and period
t1_df <- df %>%
  group_by(eDWID, Period) %>%
  summarise(
    CFRD = max(cfrd,na.rm = T),
    Age = max(Age_YrEnd), Race = last(na.omit(Race)),
    Hispanic = last(na.omit(Hispanicrace)), Gender = last(na.omit(Gender)),
    `Patient Education` = last(na.omit(patient_education)),
    `Father Education` = last(na.omit(father_education)),
    `Mother Education` = last(na.omit(mother_education)),
    `Spouse Education` = last(na.omit(spouse_education)),
    `Marital Status` = last(na.omit(marital_status)),
    `Part Time` = max(employment1, na.rm = F),
    `Full time homemaker` = max(employment2, na.rm = F),
    `Full time employment` = max(employment3, na.rm = F),
    `Unemployed` = max(employment4, na.rm = F),
    `Student` = max(employment5, na.rm = F),
    `Disabled` = max(employment6, na.rm = F),
    `Retired` = max(employment7, na.rm = F),
    Pregnancy = max(pregnant, na.rm = T),
    .groups = "keep"
  )
# Convert infinite values to missing
t1_df = data.frame(lapply(t1_df, function(c){
  c[is.infinite(c)] = NA
  return(c)
}))
# Print table
cols <- colnames(t1_df)[4:ncol(t1_df)]
t1 = tableby(as.formula(paste0("CFRD~", paste0("`", cols, "`", collapse = "+"))),
             strata = Period,data = t1_df)
summary(t1)
```

## Table 2: Pulmonary function

Continuous and count variables are from the last year of each period.

```{r results='asis',warning=FALSE}
# Summarize by ID and period
t2_df <- df %>%
  group_by(eDWID, Period) %>%
  summarise(
    CFRD = max(cfrd,na.rm = T),
    Smoking = max(smoking, na.rm = T),
    `Secondhand smoke` = max(second_smoke, na.rm = T),
    `FEV1 % Predicted` = last(na.omit(A_GLI_FEV1_pct_predicted)),
    `FVC % Predicted` = last(na.omit(A_GLI_FVC_pct_predicted)),
    `Pulm. Exacerbations` = sum(NumPulmExacerbation,na.rm = T),
    `Beta agonist` = max(A_bronchodilators1, na.rm = T),
    `Theophylline product` = max(A_bronchodilators2, na.rm = T),
    `Short acting beta agonist` = max(A_bronchodilatorsinhaled1, na.rm = T),
    `Long acting beta agonist` = max(A_bronchodilatorsinhaled2, na.rm = T),
    `Short acting anticholinergic` = max(A_bronchodilatorsinhaled3, na.rm = T),
    `Long acting anticholinergic` = max(A_bronchodilatorsinhaled4, na.rm = T),
    `Combination beta agonist and anticholinergic` = max(A_bronchodilatorsinhaled5, na.rm = T),
    `Positive Expiratory Pressure (PEP)` = max(A_act_primary1, na.rm = T),
    `Postural drainage with clapping (CPT)` = max(A_act_primary2, na.rm = T),
    `Forced expiratory techniques` = max(A_act_primary3, na.rm = T),
    `Oscillating PEP` = max(A_act_primary4, na.rm = T),
    `High frequency chest wall oscillation` = max(A_act_primary5, na.rm = T),
    `Exercise` = max(A_act_primary6, na.rm = T),
    `None` = max(A_act_primary7, na.rm = T),
    `Other` = max(A_act_primary8, na.rm = T),
    `Oxygen Therapy` = last(na.omit(oxygen_therapy)),
    .groups = "keep"
  )
# Convert infinite values to missing
t2_df = data.frame(lapply(t2_df, function(c){
  c[is.infinite(c)] = NA
  return(c)
}))
# Print table
cols <- colnames(t2_df)[4:ncol(t2_df)]
t2 = tableby(as.formula(paste0("CFRD~", paste0("`", cols, "`", collapse = "+"))),
             strata = Period,data = t2_df)
summary(t2)
```

## Table 3: Panreactic function

Continuous and count variables are from the last year of each period.

```{r results='asis',warning=FALSE}
# Summarize by ID and period
t3_df <- df %>%
  group_by(eDWID, Period) %>%
  summarise(
    CFRD = max(cfrd,na.rm = T),
    `On Enzymes` = last(na.omit(A_IsOnEnzymes)),
    `Mutation Class` = last(na.omit(MutClass)),
    `F508del` = last(na.omit(F508del)),
    .groups = "keep"
  )
# Convert infinite values to missing
t3_df = data.frame(lapply(t3_df, function(c){
  c[is.infinite(c)] = NA
  return(c)
}))
# Print table
cols <- colnames(t3_df)[4:ncol(t3_df)]
t3 = tableby(as.formula(paste0("CFRD~", paste0("`", cols, "`", collapse = "+"))),
             strata = Period,data = t3_df)
summary(t3)
```

## Table 4: Nutrition

Continuous and count variables are from the last year of each period.

```{r results='asis',warning=FALSE}
# Summarize by ID and period
t4_df <- df %>%
  group_by(eDWID, Period) %>%
  summarise(
    CFRD = max(cfrd,na.rm = T),
    `BMI %ile (age <18)` = last(na.omit(bmi_peds)),
    `BMI Value (age <= 18)` = last(na.omit(bmi_adults)),
    `Salt Supplement` = max(A_salt_supplement, na.rm = T),
    `CF Vitamins` = max(A_cf_vitamins, na.rm = T),
    `Hemoptysis` = max(A_pulmonarycomplications4, na.rm = T),
    `Pneumothorax Chest Tube` = max(A_pulmonarycomplications5, na.rm = T),
    `Sinus Disease` = max(A_othercomplications9, na.rm = T),
    `Cirrhosis` = max(A_hepatobiliary1_3, na.rm = T),
    .groups = "keep"
  )
# Convert infinite values to missing
t4_df = data.frame(lapply(t4_df, function(c){
  c[is.infinite(c)] = NA
  return(c)
}))
# Print table
cols <- colnames(t4_df)[4:ncol(t4_df)]
t4 = tableby(as.formula(paste0("CFRD~", paste0("`", cols, "`", collapse = "+"))),
             strata = Period,data = t4_df)
summary(t4)
```

## Table 5: Other

Continuous and count variables are from the last year of each period.

```{r results='asis',warning=FALSE}
# Summarize by ID and period
t5_df <- df %>%
  group_by(eDWID, Period) %>%
  summarise(
    CFRD = max(cfrd,na.rm = T),
    `Osteoperosis`=max(dexa_results_osteoporosis,na.rm = T),
    `Kalydeco`=max(A_Vx770,na.rm = T),
    `Lumacaftor/Ivacaftor`=max(A_VX809comb,na.rm = T),
    `Height %ile (age <18)` = last(na.omit(height_peds)),
    `Height Value (age <= 18)` = last(na.omit(height_adults)),
    `Weight %ile (age <18)` = last(na.omit(weight_peds)),
    `Weight Value (age <= 18)` = last(na.omit(weight_adults)),
    `Num. Hospitalizations` = sum(NumHosp,na.rm = T),
    `Gall stones`=max(A_hepatobiliary1_1,na.rm=T),
    `Liver disease, cirrhosis`=max(A_hepatobiliary1_3,na.rm=T),
    `Liver disease, non- cirrhosis`=max(A_hepatobiliary2_1,na.rm=T),
    `Hepatic Steatosis`=max(A_hepatobiliary2_2,na.rm=T),
    `Liver disease, other`=max(A_hepatobiliary2_3,na.rm=T),
    `Acute Liver Failure`=max(A_hepatobiliary2_4,na.rm=T),
    `G-Tube`=max(A_feeding3,na.rm = T),
    `Oral corticosteroids`=max(A_corticosteroids1,na.rm = T),
    `Asthma`=max(A_pulmonarycomplications2,na.rm = T),
    `Mycobacterial tuberculosis`=max(A_mycobacterials1,na.rm=T),
    `Mycobacterium abscessus/chelonae`=max(A_mycobacterials2,na.rm=T),
    `Mycobacterium avium complex (MAC)`=max(A_mycobacterials3,na.rm=T),
    `Mycobacterium fortuitum group`=max(A_mycobacterials4,na.rm=T),
    `Mycobacterium gordonae`=max(A_mycobacterials5,na.rm=T),
    `Mycobacterium kansasii`=max(A_mycobacterials7,na.rm=T),
    `Mycobacterium marinum`=max(A_mycobacterials8,na.rm=T),
    `Mycobacterium terrae`=max(A_mycobacterials9,na.rm=T),
    `Other Mycobacterium`=max(A_mycobacterials10,na.rm=T),
    .groups = "keep"
  )
# Convert infinite values to missing
t5_df = data.frame(lapply(t5_df, function(c){
  c[is.infinite(c)] = NA
  return(c)
}))
# Print table
cols <- colnames(t5_df)[4:ncol(t5_df)]
t5 = tableby(as.formula(paste0("CFRD~", paste0("`", cols, "`", collapse = "+"))),
             strata = Period,data = t5_df)
summary(t5)
```

## Table 6: Microbiome

```{r results='asis',warning=FALSE}
# Summarize by ID and period
t6_df <- df %>%
  group_by(eDWID, Period) %>%
  summarise(
    CFRD = max(cfrd,na.rm = T),
    `Pseudomonas`=max(A_pseudomonasaeruginosa,na.rm=T),
    `Burkholderia`=max(A_staphylococcus_aureus,na.rm=T),
    `Alcaligenes`=max(A_othermicroorganisms1,na.rm=T),
    `Stenotrophomonas`=max(A_othermicroorganisms2,na.rm=T),
    `Aspergillus`=max(A_fungalyeast1,na.rm=T),
    `Candida`=max(A_fungalyeast2,na.rm=T),
    `Scedosporium`=max(A_fungalyeast3,na.rm=T),
    .groups = "keep"
  )
# Convert infinite values to missing
t6_df = data.frame(lapply(t6_df, function(c){
  c[is.infinite(c)] = NA
  return(c)
}))
# Print table
cols <- colnames(t6_df)[4:ncol(t6_df)]
t6 = tableby(as.formula(paste0("CFRD~", paste0("`", cols, "`", collapse = "+"))),
             strata = Period,data = t6_df)
summary(t6)
```

# Aim 2

## Structural equation modeling (SEM)

```{r echo=TRUE,eval=FALSE}
model <- '
  # regressions
    GLI_FEV1_pct_predicted~cfrd
    cfrd ~ Gender
  # residual correlations
    Gender ~~ corticosteroids1
    Gender ~~ F508del
    cfrd ~~ hgba1c
    cfrd ~~ bmipercentile
'
fit <- sem(model, data = df)
summary(fit, standardized = TRUE)
```

# Aim 3

## ROC curves

For each ROC curve, we used everyone's most recent visit where they had both a CFRD status and an A1c measure. Confidence intervals for the threshold that maximizes sensitivity and specificity (based on the Youden index) were calculated using 2000 bootstrap replicates.

### CFRD

```{r}
# Clean data
roc_df = df %>% group_by(eDWID) %>%
  select(eDWID,Period,reviewyear,encounterid,encounternum,hgba1c,cfrd_status_annual) %>%
  drop_na() %>% slice_max(reviewyear) %>% slice_max(encounternum)
roc_df$cfrd_status = as.numeric(roc_df$cfrd_status_annual == 3)
r = roc(cfrd_status~hgba1c,roc_df,plot=TRUE, print.auc=TRUE,ci=T,quiet=T)
thresh.ci = ci.coords(r,"best",best.method="youden",progress="none")
n = names(thresh.ci)
thresh.ci = do.call(rbind,thresh.ci)
rownames(thresh.ci)=n
kable(thresh.ci,row.names = T)
```

### CFRD-related retinopathy

```{r}
# Clean data
roc_df = df %>% group_by(eDWID) %>%
  select(eDWID,Period,reviewyear,encounterid,encounternum,hgba1c,A_cfrdsecondarycomplications1) %>%
  drop_na() %>% slice_max(reviewyear) %>% slice_max(encounternum)
r = roc(A_cfrdsecondarycomplications1~hgba1c,roc_df,plot=TRUE, print.auc=TRUE,ci=T,quiet=T)
thresh.ci = ci.coords(r,"best",best.method="youden",progress="none")
n = names(thresh.ci)
thresh.ci = do.call(rbind,thresh.ci)
rownames(thresh.ci)=n
kable(thresh.ci,row.names = T)
```

### CFRD-related microalbuminuria

```{r}
# Clean data
roc_df = df %>% group_by(eDWID) %>%
  select(eDWID,Period,reviewyear,encounterid,encounternum,hgba1c,A_cfrdsecondarycomplications2) %>%
  drop_na() %>% slice_max(reviewyear) %>% slice_max(encounternum)
r = roc(A_cfrdsecondarycomplications2~hgba1c,roc_df,plot=TRUE, print.auc=TRUE,ci=T,quiet=T)
thresh.ci = ci.coords(r,"best",best.method="youden",progress="none")
n = names(thresh.ci)
thresh.ci = do.call(rbind,thresh.ci)
rownames(thresh.ci)=n
kable(thresh.ci,row.names = T)
```

### CFRD-related chronic renal insufficiency

```{r}
# Clean data
roc_df = df %>% group_by(eDWID) %>%
  select(eDWID,Period,reviewyear,encounterid,encounternum,hgba1c,A_cfrdsecondarycomplications3) %>%
  drop_na() %>% slice_max(reviewyear) %>% slice_max(encounternum)
r = roc(A_cfrdsecondarycomplications3~hgba1c,roc_df,plot=TRUE, print.auc=TRUE,ci=T,quiet=T)
thresh.ci = ci.coords(r,"best",best.method="youden",progress="none")
n = names(thresh.ci)
thresh.ci = do.call(rbind,thresh.ci)
rownames(thresh.ci)=n
kable(thresh.ci,row.names = T)
```

### CFRD-related chronic renal insufficiency

```{r}
# Clean data
roc_df = df %>% group_by(eDWID) %>%
  select(eDWID,Period,reviewyear,encounterid,encounternum,hgba1c,A_cfrdsecondarycomplications3) %>%
  drop_na() %>% slice_max(reviewyear) %>% slice_max(encounternum)
r = roc(A_cfrdsecondarycomplications3~hgba1c,roc_df,plot=TRUE, print.auc=TRUE,ci=T,quiet=T)
thresh.ci = ci.coords(r,"best",best.method="youden",progress="none")
n = names(thresh.ci)
thresh.ci = do.call(rbind,thresh.ci)
rownames(thresh.ci)=n
kable(thresh.ci,row.names = T)
```

### CFRD-related chronic renal failure requiring dialysis

```{r}
# Clean data
roc_df = df %>% group_by(eDWID) %>%
  select(eDWID,Period,reviewyear,encounterid,encounternum,hgba1c,A_cfrdsecondarycomplications4) %>%
  drop_na() %>% slice_max(reviewyear) %>% slice_max(encounternum)
r = roc(A_cfrdsecondarycomplications4~hgba1c,roc_df,plot=TRUE, print.auc=TRUE,ci=T,quiet=T)
thresh.ci = ci.coords(r,"best",best.method="youden",progress="none")
n = names(thresh.ci)
thresh.ci = do.call(rbind,thresh.ci)
rownames(thresh.ci)=n
kable(thresh.ci,row.names = T)
```

### CFRD-related peripheral neuropathy

```{r}
# Clean data
roc_df = df %>% group_by(eDWID) %>%
  select(eDWID,Period,reviewyear,encounterid,encounternum,hgba1c,A_cfrdsecondarycomplications5) %>%
  drop_na() %>% slice_max(reviewyear) %>% slice_max(encounternum)
r = roc(A_cfrdsecondarycomplications5~hgba1c,roc_df,plot=TRUE, print.auc=TRUE,ci=T,quiet=T)
thresh.ci = ci.coords(r,"best",best.method="youden",progress="none")
n = names(thresh.ci)
thresh.ci = do.call(rbind,thresh.ci)
rownames(thresh.ci)=n
kable(thresh.ci,row.names = T)
```

## Joint model

```{r eval=FALSE,echo=TRUE}
annual = left_join(annual,demo,by = "eDWID")
# Super simple joint model to start with
jm_df = annual %>% dplyr::select(eDWID,reviewyear,Gender,A_hgba1c,cfrd_status_annual) %>%
  filter(cfrd_status_annual <= 3)
jm_df$cfrd_status_annual = as.numeric(jm_df$cfrd_status_annual==3)
jm_df = jm_df %>% group_by(eDWID) %>% 
  mutate(cfrd = max(cfrd_status_annual),
         reviewyear = reviewyear-2003)
jm_df$stop = 
# Survival model
sf <- survfit(Surv(reviewyear, cfrd) ~ factor(Gender), data = jm_df)
autoplot(sf)
```

# Questions/notes

1. In the cleaned ROC data about 34% of people had CFRD. Does that seem correct?
2. I also need to meet with Laura about the SEM since she's an expert.
  - Do we want to include any latent variables?
  - How should we treat BMI in the SEM? Percentile or raw value adjusted for age?
3. Unfortunately some of the complicated models are not converging, so I need to investigate that a bit.
4. What is the best way to treat time in these models? Should we use annualized data and assum even spacing?
