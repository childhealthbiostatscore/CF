---
title: "Pre-/Post-Trikafta in CFRD"
author: "Tim Vigers & Casey Sakamoto"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(arsenal)
library(tidyverse)
library(performance)
library(lubridate)
library(knitr)
knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "S:/PEDS/RI Biostatistics Core/Shared/Shared Projects/Vigers/CF"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Vigers/CF"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Vigers/CF"
}
knitr::opts_knit$set(root.dir = home_dir)
```

```{r}
# Import cleaned data from Casey
df = read.csv("./Christine Chan/Prepost Triakfta/Data_Cleaned/analysis_data.csv",na.strings = "NA")
df$X = NULL
# Fill in MRN and CFF ID for everyone
df = df %>% 
  group_by(CFF.ID) %>% fill(MRN,.direction = "downup") %>% 
  group_by(MRN) %>% fill(CFF.ID,.direction = "downup") %>%
  arrange(CFF.ID,Date)
# Fill in constant variables for all rows
df = df %>% group_by(MRN) %>% fill(CFF.ID,.direction = "downup") %>% 
  group_by(CFF.ID) %>% fill(DOB,Start:CFRD.Diagnosis.Date,.direction = "downup") %>% ungroup()
df$Hispanic.Latinx[is.na(df$Hispanic.Latinx)] = FALSE
# Assume that blanks for pancreatic and G tube indicate "no"
df$Pancreatic.Status[is.na(df$Pancreatic.Status)] = "Sufficient"
df$G.tube.in.past.12.months[is.na(df$G.tube.in.past.12.months)] = "No"
# Convert dates
date_vars = c("DOB","Start","Date")
df[,date_vars] = lapply(df[,date_vars], function(d){
  parse_date_time(d,orders = c("mdy","ymd","dmy"),quiet = T)
})
# Time from start and filtering
df = df %>% mutate(time = as.numeric(difftime(Date,Start,units = "days"))) %>%
  filter(!is.na(time),abs(time) <= 365,!is.na(CFF.ID),
         !is.na(CFRD.Diagnosis.Date) | !is.na(CFRD.Status)) %>%
  select(-MRN,CFF.ID,DOB,Start,everything())
```

# Table 1: Participant Characteristics

```{r}
demographics = df %>% group_by(CFF.ID) %>% filter(row_number() == 1)

```

```{r}
# Piecewise model function
piecewise = function(outcome,data = df){
  
}
```
