---
title: "Pre/Post-Trikafta"
author: "Tim Vigers"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(arsenal)
library(tidyverse)
library(lubridate)
library(readxl)
library(PAutilities)
library(AGD)
library(rspiro)
library(anthro)
library(knitr)
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Vigers/CF/Christine Chan/Prepost Triakfta")
```

```{r code from maxie,eval=FALSE}
# Source Maxie's code, and write final ID lists
source("~/GitHub/CF/Christine Chan/Pre-post Trikafta/p001+cmw_UPDATED.R")
ids = data.frame(unique(analytic_cm$CFF.ID))
colnames(ids) = "CFF.ID"
write.csv(ids,file = "./Data_Cleaned/final_ids.csv",row.names = F)
```

```{r closest date function}
closest_dates = function(df,start = "Start",date = "Date"){
  # Remove MRN
  df$MRN = NULL
  # Start and date columns must be formated for subtraction (ideally with lubridate)
  df$Timepoint = as.numeric(df[,date] - df[,start])
  # Remove visits on start date or > 1 year out
  df = df %>% filter(Timepoint !=0 & abs(Timepoint) <= 365) %>% 
    # Get closest visit before and closest after
    group_by(CFF.ID,sign(Timepoint)) %>%
    slice_min(Timepoint * sign(Timepoint),n=1) %>% 
    # Format
    ungroup %>% select(-Timepoint) %>% rename(Timepoint = `sign(Timepoint)`)
  # Timepoint as factor
  df$Timepoint = factor(df$Timepoint,labels = c("Before","After"))
  # Delete unnecessary columns
  df = df %>% select(-all_of(c(start,date))) %>% select(CFF.ID,Timepoint,everything())
  # Return
  df = data.frame(df)
  return(df)
} 
pre_post_average = function(df,start = "Start",date = "Date"){
  # Remove MRN
  df$MRN = NULL
  # Start and date columns must be formated for subtraction (ideally with lubridate)
  df$Timepoint = as.numeric(df[,date] - df[,start])
  # Columns to exclude
  excluded_vars = c(start,date,"CFF.ID","Timepoint","sign(Timepoint)")
  # Remove visits on start date or > 1 year out
  df = df %>% filter(Timepoint !=0 & abs(Timepoint) <= 365) %>% 
    # Get closest visit before and closest after
    group_by(CFF.ID,sign(Timepoint)) %>%
    summarise(across(-any_of(excluded_vars), ~mean(.x,na.rm = T)),.groups = "drop") %>%
    # Format
    rename(Timepoint = `sign(Timepoint)`) %>%
    mutate_all(~replace(., is.nan(.), NA)) # Replace NaN
  # Timepoint as factor
  df$Timepoint = factor(df$Timepoint,labels = c("Before","After"))
  # Select
  df = df %>% select(CFF.ID,Timepoint,everything())
  # Return
  df = data.frame(df)
}
```

# Table 1: Demographics at Trikafta Start

```{r}
# Start dates
chco_demographics = read.csv("./Data_Cleaned/chco_trikafta_dates.csv",na.strings = "")
# Fix select dates
chco_demographics$Earliest.Trikafta.Date.in.PortCF[chco_demographics$MRN =="1053930"] = "12/1/2019"
chco_demographics$Earliest.Trikafta.Date.in.PortCF[chco_demographics$MRN =="1695512"] = "12/12/2019"
chco_demographics$Earliest.Trikafta.Date.in.PortCF[chco_demographics$MRN =="815274"] = "12/13/2019"
chco_demographics$Earliest.Trikafta.Date.in.PortCF[chco_demographics$MRN =="1078408"] = "3/9/2020"
chco_demographics$Earliest.Trikafta.Date.in.PortCF[chco_demographics$MRN =="899717"] = "2/14/2020"
chco_demographics$CFF.ID = as.character(chco_demographics$CFF.ID)
# Diabetes and with start date only
chco_demographics = chco_demographics %>% 
  filter(!is.na(Earliest.Trikafta.Date.in.PortCF),CFRD.yes.1 == 1)
chco_demographics$Earliest.Trikafta.Date.in.PortCF = 
  mdy(chco_demographics$Earliest.Trikafta.Date.in.PortCF)
chco_dates = chco_demographics %>% rename(Start = Earliest.Trikafta.Date.in.PortCF) %>%
  select(CFF.ID,MRN,Start)
# A1C and OGTT
chco_a1c = read.csv("./Data_Cleaned/chco_a1c_ogtt.csv")
## Format
chco_a1c$CFF.ID = as.character(chco_a1c$CFF.ID)
chco_a1c$Date = mdy(chco_a1c$Date)
chco_a1c$Diabetes = NULL
## Only those w/CFRD and known start
chco_a1c = left_join(chco_dates,chco_a1c,by = "CFF.ID")
## Get closest before and closest after dates
chco_a1c = closest_dates(chco_a1c)
# PFTs
chco_pft = read.csv("./Data_Cleaned/chco_bmi_pft.csv")
chco_pft$Date = mdy(chco_pft$Date)
chco_pft = left_join(chco_dates,chco_pft,by = "MRN")
chco_pft = closest_dates(chco_pft)
# CGM
chco_cgm = read.csv("./Data_Cleaned/chco_cgm.csv")
chco_cgm$Date = date(mdy_hm(chco_cgm$date_cgm_placement))
chco_cgm$CFF.ID = sub("_.*","",chco_cgm$subject_id)
# chco_cgm$subject_id = NULL
chco_cgm = left_join(chco_dates,chco_cgm,by = "CFF.ID")
chco_cgm = closest_dates(chco_cgm)
# Merge
chco = full_join(chco_a1c,chco_pft,by = c("CFF.ID", "MRN", "Timepoint"))
chco = full_join(t,chco_cgm,by = c("CFF.ID", "MRN", "Timepoint"))

# Montana
montana = read.csv("./Data_Raw/Data From Montana/Copy of Paper patient population glycemic (+hofer).csv",na.strings = "")
demo_adult = read.csv("./Data_Raw/Data From Montana/demo_adults.csv",na.strings = "")
demo_kids = read.csv("./Data_Raw/Data From Montana/demo_kids.csv",na.strings = "")
demo_kids$Date.Of.Birth..mm.dd.yyyy. = NULL
demo_kids = demo_kids[,colnames(demo_adult)]
demo = rbind(demo_adult,demo_kids)
# Get within a year of Trikafta start
montana$time_diff = mdy(montana$Trikafta.start.date) - mdy(montana$Date.of.Encounter)
montana = montana %>% filter(abs(montana$time_diff)<=365)
# Add demographics
montana = left_join(montana,demo,by = "CFF.ID")
# PFTs
pft_adult <- read.csv("./Data_Raw/Data From Montana/Copy of PFTs growth adult (+hofer).csv")
pft_kids <- read.csv("./Data_Raw/Data From Montana/PFTs kids.csv")
pft_adult = pft_adult[,colnames(pft_kids)]
pfts = rbind(pft_adult,pft_kids)
montana = full_join(montana,pfts,by = c("CFF.ID", "Date.of.Encounter"))
```

# Spline regression

```{r}
a1c = read.csv("./Data_Raw/Data From CHCO/Copy of A1C and OGTTs Before and After Trikafta_cc modified 8.25.20.csv")
a1c$Earliest.Trikafta.Date.in.PortCF = mdy(a1c$Earliest.Trikafta.Date.in.PortCF)
a1c$Date.of.A1C.or.OGTT = mdy(a1c$Date.of.A1C.or.OGTT)
a1c = a1c %>% 
  mutate(time = as.numeric(difftime(Date.of.A1C.or.OGTT,
                                    Earliest.Trikafta.Date.in.PortCF,
                                    units = "days"))) %>%
  filter(!is.na(Hgb.A1C),abs(time)<=365)
a1c$spline = ifelse(a1c$time>0,1,0)
a1c$X = a1c$time * a1c$spline
# Segmented model, knot at 0
smod = lme(Hgb.A1C ~ time + X,random = ~1|MRN,data = a1c,na.action = na.omit)
# Plot
# Segments
xs1 = c(min(a1c$time),0)
beta1 = summary(smod)$tTable[1:2]
ys1 = cbind(1, xs1) %*% beta1

xs2 = c(0,max(a1c$time))
beta2 = c(summary(smod)$tTable[1],sum(summary(smod)$tTable[2:3]))
ys2 = cbind(1,xs2) %*% beta2

p = ggplot(a1c,aes(x = time,y = Hgb.A1C)) + 
  geom_point() + 
  geom_segment(aes(x = xs1[1], xend = xs1[2], y = ys1[1], yend = ys1[2]),color = "blue") +
  geom_segment(aes(x = xs2[1], xend = xs2[2], y = ys2[1], yend = ys2[2]),color = "blue") +
  xlab("Days from Trikafta Start") + ylab("HbA1c") + theme_bw()
p
```