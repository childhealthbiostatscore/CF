---
title: "Pre-/Post-Trikafta in CFRD"
author: "Tim Vigers"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 5
    toc_float: yes
---

```{r setup, include=FALSE}
library(tidyverse)
library(gtsummary)
library(arsenal)
library(rspiro)
home_dir <- switch(Sys.info()["sysname"],
  "Darwin" = "/Users/timvigers/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Vigers/CF",
  "Windows" = "C:/Users/Tim/OneDrive - The University of Colorado Denver/Vigers/CF",
  "Linux" = "/home/timvigers/OneDrive/Vigers/CF"
)
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir = home_dir)
```

```{r}
load("./Colleen Wood/Prepost Trikafta/Data_Cleaned/analysis_dataset.rdata")
# Baseline HbA1c, BMI group pre- and post-modulator
df <- df %>%
  group_by(`CFF ID`) %>%
  mutate(
    `Baseline HbA1c` = HbA1c[`Pre or Post` == "Pre"],
    `Baseline BMI` = `BMI Percentile`[`Pre or Post` == "Pre"],
    `Post BMI` = `BMI Percentile`[`Pre or Post` == "Post"]
  ) %>%
  ungroup()
df$`Baseline HbA1c` <- cut(df$`Baseline HbA1c`, c(-Inf, 6.5, Inf), right = F)
df$`Baseline BMI` <- cut(df$`Baseline BMI`, c(-Inf, 85, Inf), right = F)
df$`Post BMI` <- cut(df$`Post BMI`, c(-Inf, 85, Inf), right = F)
# Pre-modulator BMI percentile
df <- df %>%
  group_by(`CFF ID`) %>%
  mutate(`Baseline HbA1c` = HbA1c[`Pre or Post` == "Pre"]) %>%
  ungroup()
df$`Baseline HbA1c` <- cut(df$`Baseline HbA1c`, c(-Inf, 6.5, Inf), right = F)
# Race neutral equations
df$ppFEV1gl <- pctpred_GLIgl(
  age = df$Age, height = df$Height / 100, gender = df$Sex, FEV1 = df$FEV1
)
df$ppFVCgl <- pctpred_GLIgl(
  age = df$Age, height = df$Height / 100, gender = df$Sex, FVC = df$FEV1
)
# Columns formats
df$`Num. A1c Values` <- as.numeric(df$`Num. A1c Values`)
```

# Participant characteristics prior to CFTR modulator start

```{r}
df %>%
  filter(`Pre or Post` == "Pre") %>%
  select(
    Age, `BMI Percentile`, Weight, Sex, ppFEV1, ppFEV1gl, ppFVC,
    ppFVCgl, `G-tube in past 12 months`, `Pancreatic Status`, Site,
    Genotype, `Age Group`, Race
  ) %>%
  tbl_summary(
    statistic = list(c("ppFEV1", "ppFEV1gl", "ppFVC", "ppFVCgl") ~ "{mean} ± {sd}"),
    missing_text = "Missing"
  )
```

# Pre-post

## HbA1c and others

### All groups

```{r warning=FALSE, message=FALSE}
df %>%
  select(
    `CFF ID`, `Pre or Post`, `Num. A1c Values`, HbA1c, Time, Weight,
    `BMI Percentile`, ppFEV1, ppFEV1gl, ppFVC, ppFVCgl, TDD,
  ) %>%
  tbl_summary(
    by = `Pre or Post`, type = list(
      c(
        "Num. A1c Values", "HbA1c", "Time", "Weight", "BMI Percentile",
        "ppFEV1", "ppFEV1gl", "ppFVC", "ppFVCgl", "TDD"
      ) ~ "continuous2"
    ),
    statistic = list(
      c("ppFEV1", "ppFEV1gl", "ppFVC", "ppFVCgl") ~
        c("{mean} ± {sd}", "{min}, {max}"),
      c("Num. A1c Values", "HbA1c", "Time", "Weight", "BMI Percentile") ~
        c("{median} [{p25}, {p75}]", "{min}, {max}")
    ),
    include = -`CFF ID`, digits = list(everything() ~ 2),
    missing_text = "Missing"
  ) %>%
  add_p(
    test = list(
      c("Num. A1c Values", "HbA1c", "Time", "Weight", "BMI Percentile", "TDD") ~
        "paired.wilcox.test",
      c("ppFEV1", "ppFEV1gl", "ppFVC", "ppFVCgl") ~ "paired.t.test"
    ),
    group = `CFF ID`
  ) %>%
  separate_p_footnotes()
```

### Stratified by baseline HbA1c

```{r warning=FALSE, message=FALSE}
df %>%
  select(
    `CFF ID`, `Pre or Post`, `Baseline HbA1c`, `Num. A1c Values`, HbA1c, Time,
    Weight, `BMI Percentile`, ppFEV1, ppFEV1gl, ppFVC, ppFVCgl, TDD,
  ) %>%
  tbl_strata(
    strata = `Baseline HbA1c`,
    .tbl_fun = ~ .x %>%
      tbl_summary(
        by = `Pre or Post`, type = list(
          c(
            "Num. A1c Values", "HbA1c", "Time", "Weight", "BMI Percentile",
            "ppFEV1", "ppFEV1gl", "ppFVC", "ppFVCgl", "TDD"
          ) ~ "continuous2"
        ),
        statistic = list(
          c("ppFEV1", "ppFEV1gl", "ppFVC", "ppFVCgl") ~
            c("{mean} ± {sd}", "{min}, {max}"),
          c("Num. A1c Values", "HbA1c", "Time", "Weight", "BMI Percentile") ~
            c("{median} [{p25}, {p75}]", "{min}, {max}")
        ),
        include = -`CFF ID`, digits = list(everything() ~ 2),
        missing_text = "Missing"
      ) %>%
      add_p(
        test = list(
          c("Num. A1c Values", "HbA1c", "Time", "Weight", "BMI Percentile", "TDD") ~
            "paired.wilcox.test",
          c("ppFEV1", "ppFEV1gl", "ppFVC", "ppFVCgl") ~ "paired.t.test"
        ),
        group = `CFF ID`
      ) %>%
      separate_p_footnotes()
  )
```

### By site

```{r warning=FALSE, message=FALSE}
df %>%
  select(
    `CFF ID`, `Pre or Post`, Site, `Num. A1c Values`, HbA1c, Time,
    Weight, `BMI Percentile`, ppFEV1, ppFEV1gl, ppFVC, ppFVCgl, TDD,
  ) %>%
  tbl_strata(
    strata = Site,
    .tbl_fun = ~ .x %>%
      tbl_summary(
        by = `Pre or Post`, type = list(
          c(
            "Num. A1c Values", "HbA1c", "Time", "Weight", "BMI Percentile",
            "ppFEV1", "ppFEV1gl", "ppFVC", "ppFVCgl", "TDD"
          ) ~ "continuous2"
        ),
        statistic = list(
          c("ppFEV1", "ppFEV1gl", "ppFVC", "ppFVCgl") ~
            c("{mean} ± {sd}", "{min}, {max}"),
          c("Num. A1c Values", "HbA1c", "Time", "Weight", "BMI Percentile") ~
            c("{median} [{p25}, {p75}]", "{min}, {max}")
        ),
        include = -`CFF ID`, digits = list(everything() ~ 2),
        missing_text = "Missing"
      ) %>%
      add_p(
        test = list(
          c("Num. A1c Values", "HbA1c", "Time", "Weight", "BMI Percentile", "TDD") ~
            "paired.wilcox.test",
          c("ppFEV1", "ppFEV1gl", "ppFVC", "ppFVCgl") ~ "paired.t.test"
        ),
        group = `CFF ID`
      ) %>%
      separate_p_footnotes()
  )
```

### By BMI percentile pre-modulator

```{r warning=FALSE, message=FALSE}
df %>%
  select(
    `CFF ID`, `Pre or Post`, `Baseline BMI`, `Num. A1c Values`, HbA1c, Time,
    Weight, `BMI Percentile`, ppFEV1, ppFEV1gl, ppFVC, ppFVCgl, TDD,
  ) %>%
  tbl_strata(
    strata = `Baseline BMI`,
    .tbl_fun = ~ .x %>%
      tbl_summary(
        by = `Pre or Post`, type = list(
          c(
            "Num. A1c Values", "HbA1c", "Time", "Weight", "BMI Percentile",
            "ppFEV1", "ppFEV1gl", "ppFVC", "ppFVCgl", "TDD"
          ) ~ "continuous2"
        ),
        statistic = list(
          c("ppFEV1", "ppFEV1gl", "ppFVC", "ppFVCgl") ~
            c("{mean} ± {sd}", "{min}, {max}"),
          c("Num. A1c Values", "HbA1c", "Time", "Weight", "BMI Percentile") ~
            c("{median} [{p25}, {p75}]", "{min}, {max}")
        ),
        include = -`CFF ID`, digits = list(everything() ~ 2),
        missing_text = "Missing"
      ) %>%
      add_p(
        test = list(
          c("Num. A1c Values", "HbA1c", "Time", "Weight", "BMI Percentile", "TDD") ~
            "paired.wilcox.test",
          c("ppFEV1", "ppFEV1gl", "ppFVC", "ppFVCgl") ~ "paired.t.test"
        ),
        group = `CFF ID`
      ) %>%
      separate_p_footnotes()
  )
```

### By BMI percentile post-modulator

```{r warning=FALSE, message=FALSE}
df %>%
  select(
    `CFF ID`, `Pre or Post`, `Post BMI`, `Num. A1c Values`, HbA1c, Time,
    Weight, `BMI Percentile`, ppFEV1, ppFEV1gl, ppFVC, ppFVCgl, TDD,
  ) %>%
  filter(!is.na(`Post BMI`)) %>%
  tbl_strata(
    strata = `Post BMI`,
    .tbl_fun = ~ .x %>%
      tbl_summary(
        by = `Pre or Post`,
        type = list(
          c(
            "Num. A1c Values", "HbA1c", "Time", "Weight", "BMI Percentile",
            "ppFEV1", "ppFEV1gl", "ppFVC", "ppFVCgl", "TDD"
          ) ~ "continuous2"
        ),
        statistic = list(
          c("ppFEV1", "ppFEV1gl", "ppFVC", "ppFVCgl") ~
            c("{mean} ± {sd}", "{min}, {max}"),
          c("Num. A1c Values", "HbA1c", "Time", "Weight", "BMI Percentile") ~
            c("{median} [{p25}, {p75}]", "{min}, {max}")
        ),
        include = -`CFF ID`, digits = list(everything() ~ 2),
        missing_text = "Missing"
      ) %>%
      add_p(
        test = list(
          c(
            "Num. A1c Values", "HbA1c", "Time", "Weight", "BMI Percentile",
            "TDD"
          ) ~ "paired.wilcox.test",
          c("ppFEV1", "ppFEV1gl", "ppFVC", "ppFVCgl") ~ "paired.t.test"
        ),
        group = `CFF ID`
      ) %>%
      separate_p_footnotes()
  )
```

## CGM

Only 13 of those with CGM also had HbA1c values pre- and post-CFTR modulator.

### Demographics

```{r warning=FALSE, message=FALSE}
cgm <- df[!is.na(df$average_sensor), ]
cgm %>%
  filter(`Pre or Post` == "Pre") %>%
  select(
    Age, `BMI Percentile`, Weight, Sex, ppFEV1, ppFEV1gl, ppFVC,
    ppFVCgl, `G-tube in past 12 months`, `Pancreatic Status`, Site,
    Genotype, `Age Group`, Race
  ) %>%
  tbl_summary(
    type = list(
      c(
        "Age", "BMI Percentile", "Weight", "ppFEV1", "ppFEV1gl", "ppFVC",
        "ppFVCgl"
      ) ~ "continuous2"
    ),
    statistic = list(all_continuous2() ~
      c("{median} [{p25}, {p75}]", "{min}, {max}")),
    digits = list(everything() ~ 2)
  )
```

### Overall CGM variables

```{r results='asis'}
cgm_formula <- as.formula(paste0("`Pre or Post`~", paste0(cgm_vars, collapse = "+")))
cgm_formula <- update(cgm_formula, . ~ . + TDD + `Long acting insulin dose`)
cgm_vars2 <- c(cgm_vars, "TDD", "Long acting insulin dose")

cgm %>%
  select(`CFF ID`, `Pre or Post`, all_of(cgm_vars2)) %>%
  tbl_summary(
    by = `Pre or Post`,
    type = list(everything() ~ "continuous2"),
    statistic = list(
      everything() ~ c("{median} [{p25}, {p75}]", "{min}, {max}")
    ),
    include = -`CFF ID`, digits = list(everything() ~ 2),
    missing_text = "Missing"
  ) %>%
  add_p(
    test = list(everything() ~ "paired.wilcox.test"),
    group = `CFF ID`
  ) %>%
  separate_p_footnotes()
```

#### Stratified by baseline HbA1c

```{r results='asis'}
cgm_formula <- as.formula(paste0("`Pre or Post`~", paste0(cgm_vars, collapse = "+")))
cgm_formula <- update(cgm_formula, . ~ . + TDD + `Long acting insulin dose`)
p <- paired(cgm_formula,
  data = cgm, id = `CFF ID`, strata = `Baseline HbA1c`,
  signed.rank.exact = FALSE, numeric.test = "signed.rank",
  numeric.stats = c("Nmiss", "medianrange", "q1q3")
)
summary(p, pfootnote = T, digits = 1)


cgm %>%
  select(`CFF ID`, `Pre or Post`, `Baseline HbA1c`, all_of(cgm_vars2)) %>%
  tbl_strata(
    by = `Baseline HbA1c`,
    .tbl_fun = ~ .x %>%
      tbl_summary(
        by = `Pre or Post`,
        type = list(everything() ~ "continuous2"),
        statistic = list(
          everything() ~ c("{median} [{p25}, {p75}]", "{min}, {max}")
        ),
        include = -`CFF ID`, digits = list(everything() ~ 2),
        missing_text = "Missing"
      ) %>%
      add_p(
        test = list(everything() ~ "paired.wilcox.test"),
        group = `CFF ID`
      ) %>%
      separate_p_footnotes()
  )
```

### Daytime CGM variables

```{r results='asis'}
cgm$daytime_cv <- cgm$daytime_sd / cgm$daytime_avg_sensor_glucose
day_cgm <- c(day_cgm, "daytime_cv")
cgm_formula <- as.formula(paste0("`Pre or Post`~", paste0(day_cgm, collapse = "+")))
p <- paired(cgm_formula,
  data = cgm, id = `CFF ID`,
  signed.rank.exact = FALSE, numeric.test = "signed.rank",
  numeric.stats = c("Nmiss", "medianrange", "q1q3")
)
summary(p, pfootnote = T, digits = 1)
```

#### Stratified by baseline HbA1c

```{r results='asis'}
cgm$daytime_cv <- cgm$daytime_sd / cgm$daytime_avg_sensor_glucose
day_cgm <- c(day_cgm, "daytime_cv")
cgm_formula <- as.formula(paste0("`Pre or Post`~", paste0(day_cgm, collapse = "+")))
p <- paired(cgm_formula,
  data = cgm, id = `CFF ID`, strata = `Baseline HbA1c`,
  signed.rank.exact = FALSE, numeric.test = "signed.rank",
  numeric.stats = c("Nmiss", "medianrange", "q1q3")
)
summary(p, pfootnote = T, digits = 1)
```

### Nighttime CGM variables

```{r results='asis'}
cgm$nighttime_cv <- cgm$nighttime_sd / cgm$nighttime_avg_sens_glucose
night_cgm <- c(night_cgm, "nighttime_cv")
cgm_formula <- as.formula(paste0("`Pre or Post`~", paste0(night_cgm, collapse = "+")))
p <- paired(cgm_formula,
  data = cgm, id = `CFF ID`,
  signed.rank.exact = FALSE, numeric.test = "signed.rank",
  numeric.stats = c("Nmiss", "medianrange", "q1q3")
)
summary(p, pfootnote = T, digits = 1)
```

#### Stratified by baseline HbA1c

```{r results='asis'}
cgm$nighttime_cv <- cgm$nighttime_sd / cgm$nighttime_avg_sens_glucose
night_cgm <- c(night_cgm, "nighttime_cv")
cgm_formula <- as.formula(paste0("`Pre or Post`~", paste0(night_cgm, collapse = "+")))
p <- paired(cgm_formula,
  data = cgm, id = `CFF ID`, strata = `Baseline HbA1c`,
  signed.rank.exact = FALSE, numeric.test = "signed.rank",
  numeric.stats = c("Nmiss", "medianrange", "q1q3")
)
summary(p, pfootnote = T, digits = 1)
```
