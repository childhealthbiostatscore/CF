---
title: "Pre-/Post-Trikafta in CFRD"
author: "Tim Vigers & Casey Sakamoto"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(arsenal)
library(tidyverse)
library(lubridate)
source("~/GitHub/CF/get_genotype_class_severity.R")
variables = c("CFF ID","Site","Sex","Race","Genotypes1","Genotypes2","Pancreatic Status",
              "G-tube in past 12 months","Start","Date","Age")
```

```{r include=FALSE}
# CHCO
chco_a1c = read_csv("/Volumes/Documents/Work/Vigers/CF/Colleen Wood/Prepost Triakfta/Data_Cleaned/chco_glycemic.csv",show_col_types = F)
chco_a1c$Date = parse_date_time(chco_a1c$Date,orders = "mdy")
chco_bmi = read_csv("/Volumes/Documents/Work/Vigers/CF/Colleen Wood/Prepost Triakfta/Data_Cleaned/chco_bmi_pft.csv",show_col_types = F)
chco_bmi$Date = parse_date_time(chco_bmi$Date,orders = "mdy")
chco = full_join(chco_a1c,chco_bmi,by = c("MRN", "Date"))
# Fill CFF ID by MRN
chco= chco %>% group_by(MRN) %>% 
  fill(`CFF ID`,.direction = "downup") %>% ungroup() %>%
  filter(!is.na(`CFF ID`)) %>%
  select(-MRN)
# Add demographics
chco_reg = read_csv("/Volumes/Documents/Work/Vigers/CF/Colleen Wood/Prepost Triakfta/Data_Cleaned/chco_registry.csv",show_col_types = F)
chco_reg = chco_reg %>% select(-MRN)
chco_reg$Start = parse_date_time(chco_reg$Start,orders = "mdy")
chco = left_join(chco,chco_reg,by = "CFF ID")
# Add Time
chco$Time = as.numeric(difftime(chco$Date,chco$Start,units = "days"))
```

```{r include=FALSE}
# Montana
mon_bmi = read_csv("/Volumes/Documents/Work/Vigers/CF/Colleen Wood/Prepost Triakfta/Data_Cleaned/montana_bmi_pft.csv",show_col_types = F)
mon_bmi$Date = parse_date_time(mon_bmi$Date,orders = "mdy")
mon_a1c = read_csv("/Volumes/Documents/Work/Vigers/CF/Colleen Wood/Prepost Triakfta/Data_Cleaned/montana_glycemic_registry.csv",show_col_types = F)
mon_a1c$Date = parse_date_time(mon_a1c$Date,orders = "mdy")
# Get start date and CFRD status
mon_starts = mon_a1c %>% select(`CFF ID`,`CFRD Status`,Start) %>% 
  distinct() %>% filter(`CFRD Status`=="CFRD with or without fasting hyperglycemia")
mon_starts$Start = parse_date_time(mon_starts$Start,orders = "mdy")
# Remove unnecessary columns
mon_a1c = mon_a1c %>% select(`CFF ID`,Date,HbA1c,`OGTT Fasting`,`OGTT Two Hour`)
# Merge and remove those without CFRD or start date
mon = full_join(mon_bmi,mon_a1c,by = c("CFF ID", "Date"))
mon= mon %>% filter(`CFF ID` %in% mon_starts$`CFF ID`)
mon = left_join(mon,mon_starts %>% select(`CFF ID`,Start), by = "CFF ID")
# Add Time
mon$Time = as.numeric(difftime(mon$Date,mon$Start,units = "days"))
```

```{r include=FALSE}
# UM
um_a1c = read_csv("/Volumes/Documents/Work/Vigers/CF/Colleen Wood/Prepost Triakfta/Data_Cleaned/um_a1cs.csv",show_col_types = F)
um_a1c$Age = round(um_a1c$Age / 365.25,1)
um_bmi = read_csv("/Volumes/Documents/Work/Vigers/CF/Colleen Wood/Prepost Triakfta/Data_Cleaned/um_bmi.csv",show_col_types = F)
um_bmi$Age = round(um_bmi$Age / 365.25,1)
um_ogtt = read_csv("/Volumes/Documents/Work/Vigers/CF/Colleen Wood/Prepost Triakfta/Data_Cleaned/um_ogtt.csv",show_col_types = F)
um_ogtt$Age = round(um_ogtt$Age / 365.25,1)
um_pft = read_csv("/Volumes/Documents/Work/Vigers/CF/Colleen Wood/Prepost Triakfta/Data_Cleaned/um_pfts.csv",show_col_types = F)
um_pft$Age = round(um_pft$Age / 365.25,1)
um_race = read_csv("/Volumes/Documents/Work/Vigers/CF/Colleen Wood/Prepost Triakfta/Data_Cleaned/um_race.csv",show_col_types = F)
# Join
um = reduce(list(um_a1c,um_bmi,um_ogtt,um_pft),full_join)
um = left_join(um,um_race,by = "CFF ID")
```

```{r include=FALSE}
# UW
uw_bmi = read_csv("/Volumes/Documents/Work/Vigers/CF/Colleen Wood/Prepost Triakfta/Data_Cleaned/uw_bmi.csv",show_col_types = F)
uw_bmi$Date = parse_date_time(uw_bmi$Date,orders = "mdy")
uw_glyc = read_csv("/Volumes/Documents/Work/Vigers/CF/Colleen Wood/Prepost Triakfta/Data_Cleaned/uw_glycemic.csv",show_col_types = F)
uw_glyc$Date = parse_date_time(uw_glyc$Date,orders = "mdy")
uw_pft = read_csv("/Volumes/Documents/Work/Vigers/CF/Colleen Wood/Prepost Triakfta/Data_Cleaned/uw_pft.csv",show_col_types = F)
uw_pft$Date = parse_date_time(uw_pft$Date,orders = "mdy")
uw_reg = read_csv("/Volumes/Documents/Work/Vigers/CF/Colleen Wood/Prepost Triakfta/Data_Cleaned/uw_registry.csv",show_col_types = F)
uw_reg$Start = parse_date_time(uw_reg$Start,orders = "mdy")
# Merge
uw = reduce(list(uw_bmi,uw_glyc,uw_pft,uw_reg),full_join)
```

```{r include=FALSE}
# Put everything together

```

# Participant Characteristics

```{r results='asis'}
t1 = tableby(~Age+BMI.Percentile+Weight+Sex+,pre_post[pre_post$Before_After == "Before",])
summary(t1)
```

# Pre-post

```{r}
summary(tableby( ~ ppFEV + ppFVC + BMIz,data = df[!is.na(df$average_sensor),]))
```

